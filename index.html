<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Ponto - Justificativas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
        }

        /* Header Card */
        .header-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-card h1 {
            font-size: 30px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-card p {
            color: #94a3b8;
            margin-top: 4px;
        }

        .date-input {
            padding: 8px 16px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .stat-card .label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 30px;
            font-weight: bold;
            color: #e2e8f0;
        }

        /* Controls */
        .controls-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls-left {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-filter {
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            border: 2px solid rgba(148, 163, 184, 0.2);
        }

        .btn-filter:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .btn-filter.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border: 2px solid transparent;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-filter.active:hover {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-clear {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .btn-clear:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
            transform: translateY(-2px);
        }

        .btn-generate {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-generate:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .checkbox-signature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #faf5ff;
            border: 2px solid #d8b4fe;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-signature:hover {
            background: #f3e8ff;
        }

        .checkbox-signature input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-signature span {
            font-weight: 500;
            color: #7c3aed;
        }

        /* Table */
        .table-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
            overflow-y: visible;
            position: relative;
        }

        /* Scrollbar horizontal sticky */
        .table-card::-webkit-scrollbar {
            height: 14px;
        }

        .table-card::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 8px;
        }

        .table-card::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 8px;
            border: 2px solid #f1f5f9;
            cursor: grab;
        }

        .table-card::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(90deg, #2563eb, #1e40af);
        }

        .table-card::-webkit-scrollbar-thumb:active {
            cursor: grabbing;
            background: #1e40af;
        }

        table {
            width: 100%;
            min-width: 2120px;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        th.center {
            text-align: center;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            color: #1f2937;
        }

        td.center {
            text-align: center;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: #f9fafb;
            transform: translateX(4px);
        }

        tbody tr.inconsistency {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        tbody tr.selected {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        .punch-time {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .punch-time.present {
            color: #22c55e;
        }

        .punch-time.missing {
            color: #ef4444;
        }

        .punch-time.optional {
            color: #9ca3af;
        }

        /* ERRO: Hor√°rio fora de ordem cronol√≥gica */
        .punch-time.error-time {
            color: #ffffff !important;
            background: #b91c1c !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            font-weight: 700 !important;
            animation: pulseError 2s infinite;
        }

        @keyframes pulseError {
            0%, 100% {
                background: #b91c1c;
                box-shadow: 0 0 0 0 rgba(185, 28, 28, 0.7);
            }
            50% {
                background: #dc2626;
                box-shadow: 0 0 0 6px rgba(185, 28, 28, 0);
            }
        }

        /* APROVADO: Hor√°rio aprovado pelo RH */
        .punch-time.approved {
            color: #ffffff !important;
            background: #10b981 !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            font-weight: 700 !important;
        }

        .approved-badge {
            position: absolute;
            bottom: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            line-height: 16px;
            text-align: center;
            font-weight: bold;
            z-index: 10;
        }

        .approve-icon {
            position: absolute;
            top: 2px;
            left: 2px;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            transition: all 0.2s;
            z-index: 10;
        }

        .approve-icon:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .swap-icon {
            display: inline-block;
            cursor: pointer;
            font-size: 16px;
            margin-right: 6px;
            opacity: 0.7;
            transition: all 0.2s;
            vertical-align: middle;
            color: #3b82f6;
        }

        .swap-icon:hover {
            opacity: 1;
            transform: scale(1.2) rotate(180deg);
        }

        /* Edi√ß√£o Inline - Estilo Excel - REMOVIDO */

        .question-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.6;
            transition: all 0.2s;
            z-index: 10;
        }

        .question-icon:hover {
            opacity: 1;
            transform: scale(1.15);
        }

        .has-question {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 14px;
            color: #f59e0b;
            filter: drop-shadow(0 0 2px rgba(245, 158, 11, 0.5));
            animation: pulse-question 2s ease-in-out infinite;
        }
        
        @keyframes pulse-question {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .editable-cell.editing {
            padding: 0 !important;
            background: rgba(15, 23, 42, 1) !important;
            box-shadow: inset 0 0 0 2px #3b82f6 !important;
        }

        .inline-input {
            width: 100%;
            height: 100%;
            border: none;
            background: rgba(15, 23, 42, 0.8);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            padding: 8px 12px;
            color: #22c55e;
            outline: none;
        }

        .inline-input:focus {
            background: rgba(15, 23, 42, 1);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .saving-cell {
            background: rgba(59, 130, 246, 0.2) !important;
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.ok {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Info Box */
        .info-box {
            margin-top: 24px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            gap: 12px;
        }

        .info-box svg {
            flex-shrink: 0;
            margin-top: 4px;
            color: #60a5fa;
        }

        .info-box p {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .info-box ol {
            color: #cbd5e1;
            font-size: 14px;
            padding-left: 20px;
        }

        .info-box li {
            margin: 4px 0;
        }

        /* PDF Preview */
        .pdf-preview {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f172a;
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 32px;
            display: none;
        }

        .pdf-preview.active {
            display: block;
        }

        @media screen {
            .pdf-preview {
                overflow-y: auto;
                overflow-x: hidden;
            }
        }

        .pdf-controls {
            max-width: 210mm;
            margin: 0 auto 24px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-controls h2 {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .pdf-controls p {
            color: #94a3b8;
        }

        .pdf-controls-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-print {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-print:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-close {
            background: rgba(75, 85, 99, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: white;
        }

        .btn-close:hover {
            background: rgba(55, 65, 81, 1);
        }

        /* Form Page A4 Landscape */
        .form-page {
            width: 297mm;
            height: 210mm;
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            margin: 0 auto 32px;
            padding: 10mm;
            overflow: hidden;
        }

        @media screen {
            .form-page {
                max-width: calc(100vw - 64px);
                width: auto;
                aspect-ratio: 297/210;
            }
        }

        @media print {
            body { 
                margin: 0 !important; 
                padding: 0 !important;
                background: white !important;
                overflow: hidden !important;
            }
            
            html {
                overflow: hidden !important;
            }
            
            @page { 
                size: A4 landscape; 
                margin: 0mm;
            }
            
            .pdf-preview {
                position: static !important;
                padding: 0 !important;
                background: white !important;
                overflow: visible !important;
            }
            
            .pdf-controls { 
                display: none !important; 
            }
            
            .form-page {
                page-break-after: always;
                page-break-inside: avoid;
                margin: 0 !important;
                padding: 10mm !important;
                box-shadow: none !important;
                width: 297mm !important;
                height: 210mm !important;
                max-width: none !important;
                overflow: visible !important;
            }
            
            .form-page:last-child {
                page-break-after: auto;
            }
            
            #pdfPages {
                margin: 0 !important;
                padding: 0 !important;
            }
        }

        .form-border {
            border: 4px solid black;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .form-header {
            background: #d1d5db;
            border-bottom: 2px solid black;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-circle {
            width: 48px;
            height: 48px;
            background: #4b5563;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .logo-text {
            font-weight: bold;
            font-size: 20px;
        }

        .form-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            color: #1f2937;
        }

        .form-orientation {
            font-size: 12px;
            padding: 8px 16px;
            background: #f3f4f6;
            border-bottom: 2px solid #9ca3af;
            color: #1f2937;
        }

        .form-employee-data {
            padding: 12px 16px;
            border-bottom: 2px solid #9ca3af;
            font-size: 16px;
            color: #1f2937;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 8px;
        }

        .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .form-field {
            display: flex;
            gap: 8px;
        }

        .form-field-label {
            font-weight: 600;
            color: #374151;
        }

        .form-field-value {
            font-weight: bold;
            color: #1f2937;
        }

        .section-header {
            background: #374151;
            color: white;
            text-align: center;
            padding: 8px;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 2px solid black;
        }

        .form-times {
            flex: 1;
            padding: 24px;
            background: #f9fafb;
            border-bottom: 2px solid #9ca3af;
        }

        .times-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 32px;
            align-items: center;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .time-slot {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .time-value {
            font-size: 24px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .time-value.present {
            color: black;
        }

        .time-value.missing {
            color: #000;
            background: transparent;
            padding: 0;
            border: none;
            font-size: 28px;
            font-weight: 900;
            font-family: 'Courier New', monospace;
            letter-spacing: 8px;
        }

        .time-status {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 12px;
            border-radius: 4px;
        }

        .time-status.batido {
            background: #dcfce7;
            color: #166534;
        }

        .time-status.justificar {
            background: #fee2e2;
            color: #991b1b;
        }

        .form-justification {
            padding: 12px 16px;
            background: #f9fafb;
            border-bottom: 2px solid #9ca3af;
        }

        .justification-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            font-size: 14px;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1f2937;
        }

        .checkbox-item input {
            width: 16px;
            height: 16px;
        }

        .obs-field {
            margin-top: 8px;
            font-size: 12px;
            color: #1f2937;
        }

        .obs-field .obs-label {
            font-weight: 600;
        }

        .obs-line {
            border-bottom: 2px solid #9ca3af;
            margin-top: 4px;
            padding-bottom: 8px;
        }

        .form-signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding: 16px;
            margin-top: auto;
        }

        .signature-box {
            text-align: center;
            color: #1f2937;
        }

        .signature-box.left {
            padding-right: 32px;
            border-right: 2px solid #9ca3af;
        }

        .signature-box.right {
            padding-left: 32px;
        }

        .signature-space {
            height: 64px;
        }

        .signature-line {
            border-top: 2px solid black;
            padding-top: 8px;
        }

        .signature-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
            color: #1f2937;
        }

        .signature-label {
            font-size: 12px;
            color: #4b5563;
        }

        /* Estilo para c√©lulas de Hor√°rio com setas de navega√ß√£o */
        .punch-cell {
            position: relative;
        }

        .selected-cell {
            background: #dbeafe !important;
            outline: 2px solid #3b82f6 !important;
        }

        /* TAREFA 7: Estilos para drag-and-drop */
        .punch-cell[draggable="true"] {
            cursor: grab !important;
        }

        .punch-cell[draggable="true"]:active {
            cursor: grabbing !important;
        }

        .drag-over {
            background: #fef3c7 !important;
            outline: 2px dashed #f59e0b !important;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
        }

        .swap-arrow {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #3b82f6;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
            transition: all 0.15s;
        }

        .swap-arrow:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .digital-signature {
            font-weight: bold;
            font-style: italic;
            font-size: 36px;
            font-family: 'Brush Script MT', cursive;
            color: #1e40af;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-footer {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-top: 8px;
        }

        .hidden {
            display: none;
        }

        #pdfPages {
            margin: 0;
            padding: 0;
        }

        /* Upload de Anexo */
        .upload-btn {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .upload-btn:hover {
            background: #2563eb;
        }

        .attached-file {
            background: #dcfce7;
            color: #166534;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .remove-file {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }

        .motivo-field {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        /* bot√£oo API */
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .api-status.connected {
            background: #f1f5f9;
            color: #0f172a;
            border: 2px solid #10b981;
        }

        .api-status.disconnected {
            background: #f1f5f9;
            color: #64748b;
            border: 2px solid #cbd5e1;
        }

        .btn-api {
            background: #6b7280;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-api:hover {
            background: #047857;
        }

        .btn-config {
            background: #6b7280;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-config:hover {
            background: #4b5563;
        }

        .btn-company {
            padding: 8px 16px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn-company:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(148, 163, 184, 0.5);
            transform: translateY(-2px);
        }

        .btn-company.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white !important;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-company.loading {
            opacity: 0.6;
            cursor: wait;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            padding: 32px 48px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(148, 163, 184, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            margin: 0;
        }

        /* Custom Alert Popup */
        .custom-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(10px);
        }

        .custom-alert.active {
            display: flex;
        }

        .alert-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            padding: 0;
            border-radius: 16px;
            min-width: 400px;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            animation: slideUp 0.3s ease-out;
            overflow: hidden;
        }

        .alert-header {
            padding: 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .alert-header.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .alert-header.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .alert-header.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .alert-header.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .alert-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-body {
            padding: 24px;
            color: #e2e8f0;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .alert-footer {
            padding: 16px 24px;
            background: rgba(15, 23, 42, 0.5);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .alert-btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        .alert-btn.primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }

        .alert-btn.primary:hover {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .alert-btn.secondary {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .alert-btn.secondary:hover {
            background: rgba(51, 65, 85, 1);
            border-color: rgba(148, 163, 184, 0.3);
        }
    </style>
    
    <!-- Google Cloud Vision API (substitui Tesseract) -->
</head>
<body>
    <!-- ==========================================
         autentica√ß√£oO - Verificar login Secullum
         ========================================== -->
    <script>
        // Verificar autentica√ß√£oO ANTES de carregar a p√°gina
        (function() {
            const token = localStorage.getItem('secullum_token');
            const expiry = localStorage.getItem('secullum_token_expiry');
            const userName = localStorage.getItem('user_name') || localStorage.getItem('secullum_username') || 'Usu√°rio';
            
            // Se n√£o tem token OU token expirou, redirecionar para login
            if (!token || !expiry || Date.now() >= parseInt(expiry)) {
                console.log('?? Token inv√°lido ou expirado, redirecionando para login...');
                localStorage.clear(); // Limpar tudo
                window.location.href = '/login.html';
                return;
            }
            
            console.log('? Usu√°rio autenticado:', userName);
            window.CURRENT_USER = userName;
            
            // Atualizar nome do Usu√°rio no header quando carregar
            document.addEventListener('DOMContentLoaded', () => {
                const userNameElement = document.getElementById('userName');
                if (userNameElement) {
                    userNameElement.textContent = userName;
                }
                
                // Conectar API automaticamente ao carregar a p√°gina
                setTimeout(() => {
                    connectToAPI();
                }, 500);
            });
        })();
    </script>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text" id="loadingText">Carregando...</p>
        </div>
    </div>

    <!-- Custom Alert -->
    <div class="custom-alert" id="customAlert">
        <div class="alert-content">
            <div class="alert-header" id="alertHeader">
                <div class="alert-title" id="alertTitle"></div>
            </div>
            <div class="alert-body" id="alertBody"></div>
            <div class="alert-footer">
                <button class="alert-btn primary" id="alertOkBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal de Pergunta -->
    <div class="custom-alert" id="questionModal">
        <div class="alert-content" style="min-width: 500px;">
            <div class="alert-header warning">
                <div class="alert-title">? Pergunta ao Colaborador</div>
            </div>
            <div class="alert-body">
                <p id="questionContext" style="margin-bottom: 16px; font-weight: 600;"></p>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #e2e8f0;">Digite a pergunta:</label>
                <textarea id="questionInput" 
                          rows="4" 
                          style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                          placeholder="Ex: Por que bateu o ponto √£s 10:00 se n√£o estava trabalhando?"></textarea>
            </div>
            <div class="alert-footer">
                <button class="alert-btn secondary" id="questionCancelBtn">Cancelar</button>
                <button class="alert-btn primary" id="questionOkBtn">Adicionar Pergunta</button>
            </div>
        </div>
    </div>

    <!-- Modal Monitor de m√©quinas -->
    <div class="custom-alert" id="machineMonitorModal">
        <div class="alert-content" style="min-width: 900px; max-width: 95vw;">
            <div class="alert-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                <div class="alert-title">üìä Monitor de Rel√≥gios de Ponto</div>
            </div>
            <div class="alert-body" style="max-height: 70vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 8px;">
                    <div>
                        <div style="font-size: 12px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">√öltima atualiza√ß√£oo</div>
                        <div id="monitorLastUpdate" style="font-size: 18px; font-weight: 700; color: #e2e8f0; margin-top: 4px;">--:--:--</div>
                    </div>
                    <button class="btn" onclick="refreshMachineMonitor()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 10px 20px;">
                        <span>??</span>
                        <span>Atualizar</span>
                    </button>
                </div>
                <div id="machineMonitorContent">
                    <!-- Ser√° preenchido pelo JavaScript -->
                </div>
            </div>
            <div class="alert-footer">
                <button class="alert-btn secondary" onclick="closeMachineMonitor()">Fechar</button>
                <button class="alert-btn primary" onclick="exportMachineMonitor()">üì∏ Exportar Print</button>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div id="mainInterface" class="container">
        <!-- Header -->
        <div class="header-card" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Gest√£o de Ponto - Justificativas</h1>
                <p>Sistema de gera√ß√£o autom√°tica de formul√°rios</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <!-- BOT√ÉO DE TESTE - ANEXO OCR -->
                <button id="btnTesteAnexo" style="margin: 0; font-size: 14px; padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    üìé TESTE ANEXO
                </button>
                <input type="file" id="inputTesteAnexo" accept="image/*" style="display: none;">
                
                <div id="userInfo" style="margin-right: 16px; text-align: right; color: #94a3b8;">
                    <small style="display: block; font-size: 12px;">Logado como:</small>
                    <strong style="display: block; color: #e2e8f0;" id="userName">Admin</strong>
                </div>
                <button class="btn" id="btnMachineMonitor" onclick="openMachineMonitor()" style="margin: 0; font-size: 16px; padding: 12px 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                    <span>üìä</span>
                    <span>MONITOR</span>
                </button>
                <button class="btn" onclick="openPresencePanel()" style="margin: 0; font-size: 16px; padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <span>üìÖ</span>
                    <span>PRESEN√áA</span>
                </button>
                <button class="btn btn-generate" id="btnGenerateTopRight" style="margin: 0; font-size: 16px; padding: 12px 24px;">
                    <span>üìÑ</span>
                    <span>GERAR PDF</span>
                </button>
                <button class="btn" onclick="logout()" style="margin: 0; font-size: 16px; padding: 12px 24px; background: #ef4444;">
                    <span>üö™</span>
                    <span>SAIR</span>
                </button>
            </div>
        </div>

        <!-- Empresas e Status API -->
        <div class="header-card" style="margin-top: 20px;">
            <div style="display: flex; gap: 20px; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                <!-- Empresas -->
                <div style="flex: 1; min-width: 300px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">üè¢ Empresas</label>
                    <div id="companyButtons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn-company active" data-company="all" onclick="selectCompany('all', this)" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            üè¢ TODAS
                        </button>
                        <!-- Bot√©es das empresas Ser√°o adicionados aqui pelo JavaScript -->
                    </div>
                </div>
                
                <!-- Status API -->
                <div style="display: flex; gap: 12px; align-items: center; padding: 12px 16px; background: rgba(15, 23, 42, 0.6); border-radius: 10px; border: 2px solid rgba(148, 163, 184, 0.2);">
                    <span class="api-status disconnected" id="apiStatus" style="background: rgba(15, 23, 42, 0.8); color: #94a3b8; border: 2px solid rgba(148, 163, 184, 0.2); padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                        <span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: inline-block;"></span>
                        Conectando API...
                    </span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-card">
            <div class="controls-left" style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; flex: 1;">
                <!-- Filtros de Data -->
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #94a3b8; margin-bottom: 4px;">Data In√≠cio</label>
                    <input type="date" class="date-input" id="dateStart" style="font-size: 13px; padding: 8px 10px; height: 38px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #94a3b8; margin-bottom: 4px;">Data Fim</label>
                    <input type="date" class="date-input" id="dateEnd" style="font-size: 13px; padding: 8px 10px; height: 38px;">
                </div>
                <button class="btn-primary" id="btnSearchDates" style="padding: 9px 16px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; height: 38px;">
                    üîç Buscar Per√≠odo
                </button>
                
                <!-- Filtro por Nome -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #94a3b8; margin-bottom: 4px;">üîç Filtrar por Nome</label>
                    <input type="text" class="date-input" id="searchName" placeholder="Digite o nome..." style="font-size: 13px; padding: 8px 10px; width: 100%; height: 38px;">
                </div>
                
                <!-- Filtro por L√≠der -->
                <div style="min-width: 180px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #94a3b8; margin-bottom: 4px;">üë§ L√≠der</label>
                    <input type="text" class="date-input" id="searchLider" placeholder="Nome do l√≠der..." style="font-size: 13px; padding: 8px 10px; width: 100%; height: 38px;">
                </div>
                
                <!-- Filtro por Projeto -->
                <div style="min-width: 150px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #94a3b8; margin-bottom: 4px;">üìä Projeto</label>
                    <input type="text" class="date-input" id="searchProject" placeholder="Ex: 400" style="font-size: 13px; padding: 8px 10px; width: 100%; height: 38px;">
                </div>
                
                <button class="btn-primary" id="btnClearFilter" style="padding: 9px 14px; background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; height: 38px;">
                    ‚ùå Limpar
                </button>
                
                <!-- bot√£oo de filtro -->
                <button class="btn btn-filter" id="btnFilter" style="height: 38px;">
                    <span>‚ö†Ô∏è</span>
                    <span id="filterText">Mostrar S√≥ Inconsist√™ncias</span>
                </button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" style="width: 18px; height: 18px; cursor: pointer;">
                        </th>
                        <th style="width: 50px;">ID</th>
                        <th style="width: 80px;">REG</th>
                        <th style="min-width: 150px; max-width: 180px;">L√çDER</th>
                        <th style="min-width: 100px; max-width: 120px;">PROJ (BDO)</th>
                        <th style="min-width: 120px; max-width: 140px;">DEPTO (SEC)</th>
                        <th style="min-width: 180px; max-width: 220px;">NOME</th>
                        <th style="width: 140px;">CPF</th>
                        <th style="min-width: 140px;">EMPRESA</th>
                        <th style="width: 100px;">DATA</th>
                        <th style="width: 80px;" class="center">ENT. 1</th>
                        <th style="width: 80px;" class="center">SA√ç. 1</th>
                        <th style="width: 80px;" class="center">ENT. 2</th>
                        <th style="width: 80px;" class="center">SA√ç. 2</th>
                        <th style="width: 80px;" class="center">ENT. 3</th>
                        <th style="width: 80px;" class="center">SA√ç. 3</th>
                        <th style="width: 80px;" class="center">ENT. 4</th>
                        <th style="width: 80px;" class="center">SA√ç. 4</th>
                        <th style="width: 80px;" class="center">ENT. 5</th>
                        <th style="width: 80px;" class="center">SA√ç. 5</th>
                        <th style="width: 70px;" class="center" title="ID de Impress√£o">ID IMP</th>
                        <th style="min-width: 150px; max-width: 200px;">MOTIVO</th>
                        <th style="width: 100px;">ANEXOS</th>
                        <th style="width: 90px;" class="center">STATUS</th>
                    </tr>
                </thead>
                <tbody id="employeeTable">
                    <!-- Ser√° preenchido pelo JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Modal de Edi√ß√£o de Batidas -->
        <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 9999; justify-content: center; align-items: center;">
            <div style="background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 24px; font-weight: bold; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">‚úèÔ∏è Editar Batidas</h2>
                    <button onclick="closeEditModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #94a3b8; padding: 0; width: 32px; height: 32px; line-height: 1;"></button>
                </div>
                
                <div style="background: rgba(15, 23, 42, 0.6); padding: 16px; border-radius: 8px; margin-bottom: 24px; border: 1px solid rgba(148, 163, 184, 0.1);">
                    <div style="font-weight: 600; color: #e2e8f0;" id="editEmployeeName">NOME DO FUNCION√ÅRIO</div>
                    <div style="font-size: 14px; color: #94a3b8; margin-top: 4px;">
                        REG: <span id="editEmployeeReg">000</span> | Data: <span id="editEmployeeDate">00/00/0000</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">ENTRADA 1</label>
                        <input type="time" id="editEnt1" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">SA√çDA 1</label>
                        <input type="time" id="editSai1" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">ENTRADA 2</label>
                        <input type="time" id="editEnt2" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">SA√çDA 2</label>
                        <input type="time" id="editSai2" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">ENTRADA 3</label>
                        <input type="time" id="editEnt3" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">SA√çDA 3</label>
                        <input type="time" id="editSai3" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">ENTRADA 4</label>
                        <input type="time" id="editEnt4" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">SA√çDA 4</label>
                        <input type="time" id="editSai4" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">ENTRADA 5</label>
                        <input type="time" id="editEnt5" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #94a3b8; margin-bottom: 8px; font-size: 14px;">SA√çDA 5</label>
                        <input type="time" id="editSai5" style="width: 100%; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeEditModal()" style="padding: 12px 24px; border: 2px solid rgba(148, 163, 184, 0.3); background: rgba(51, 65, 85, 0.8); color: #e2e8f0; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Cancelar
                    </button>
                    <button onclick="confirmSaveEdit()" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        ? Confirmar e Enviar
                    </button>
                </div>
            </div>
        </div>

        <!-- Info -->
    </div>

    <!-- PDF Preview -->
    <div id="pdfPreview" class="pdf-preview">
        <div class="pdf-controls">
            <div>
                <h2>Pr√ß√£-visualiza√ß√£o - Formato Paisagem</h2>
                <p id="pdfCount">0 formul√©rio(s) √£ 1 por p√°gina A4 Paisagem</p>
            </div>
            <div class="pdf-controls-buttons">
                <button class="btn btn-print" onclick="window.print()">
                    <span>???</span>
                    <span>Imprimir Todas</span>
                </button>
                <button class="btn btn-close" id="btnClosePDF">
                    <span>??</span>
                    <span>Fechar</span>
                </button>
            </div>
        </div>
        <div id="pdfPages">
            <!-- Ser√° preenchido pelo JavaScript -->
        </div>
    </div>

    <script>
        // ==========================================
        // SISTEMA DE LOADING E POPUPS
        // ==========================================
        function showLoading(text = 'Carregando...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }

        function showAlert(title, message, type = 'info') {
            const alert = document.getElementById('customAlert');
            const header = document.getElementById('alertHeader');
            const titleEl = document.getElementById('alertTitle');
            const body = document.getElementById('alertBody');
            
            // √£cones baseados no tipo
            const icons = {
                success: '?',
                error: '?',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            titleEl.innerHTML = `${icons[type] || icons.info} ${title}`;
            body.textContent = message;
            header.className = `alert-header ${type}`;
            alert.classList.add('active');
        }

        function hideAlert() {
            document.getElementById('customAlert').classList.remove('active');
        }

        // Alias para compatibilidade
        function showNotification(message, type = 'info') {
            const titles = {
                success: 'Sucesso',
                error: 'Erro',
                warning: 'Aten√£oo',
                info: 'Informa√ß√£o'
            };
            showAlert(titles[type] || titles.info, message, type);
        }

        // Fechar alert ao clicar no bot√£oo OK
        document.getElementById('alertOkBtn').addEventListener('click', () => {
            document.getElementById('customAlert').classList.remove('active');
        });

        // Fechar alert ao clicar fora
        document.getElementById('customAlert').addEventListener('click', (e) => {
            if (e.target.id === 'customAlert') {
                document.getElementById('customAlert').classList.remove('active');
            }
        });

        // ==========================================
        // JUSTIFICATIVAS PADRONIZADAS
        // ==========================================
        const JUSTIFICATIVAS_PADRAO = [
            'Esqueceu de registrar o Ponto',
            'Falha no App',
            'Falta',
            'Folga',
            'Hora Parada',
            'Maquina Ponto com defeito',
            'Registro em duplicidade',
            'Registro indevido'
        ];

        // Mapeamento OCR ? Justificativa Padronizada
        const MAPEAMENTO_JUSTIFICATIVAS = {
            'esqueceu de registrar o ponto': 'Esqueceu de registrar o Ponto',
            'esqueceu': 'Esqueceu de registrar o Ponto',
            'esquecimento': 'Esqueceu de registrar o Ponto',
            'falha no app': 'Falha no App',
            'falha app': 'Falha no App',
            'falta': 'Falta',
            'folga': 'Folga',
            'hora parada': 'Hora Parada',
            'maquina ponto com defeito': 'Maquina Ponto com defeito',
            'maquina defeito': 'Maquina Ponto com defeito',
            'defeito': 'Maquina Ponto com defeito',
            'registro em duplicidade': 'Registro em duplicidade',
            'duplicidade': 'Registro em duplicidade',
            'registro indevido': 'Registro indevido',
            'indevido': 'Registro indevido'
        };

        // ==========================================
        // configura√ß√£oO DA API SECULLUM
        // ==========================================
        const API_CONFIG = {
            authURL: 'https://autenticador.secullum.com.br/Token',
            baseURL: 'https://pontowebintegracaoexterna.secullum.com.br',
            token: '',
            credentials: {
                grant_type: 'password',
                username: 'ferreira.eduardo@larsil.com.br',
                password: 'larsil123@',
                client_id: '3'
            },
            companies: [], // Ser√° preenchido dinamicamente pela API
            selectedCompanies: ['all'], // 'all' ou array de IDs
            endpoints: {
                auth: '/Token',
                batidas: '/Batidas',
                funcionarios: '/Funcionarios',
                justificativas: '/Justificativas',
                cartaoPontoManual: '/CartaoPonto/Manual',
                cartaoPontoJustificativa: '/CartaoPonto/Justificativa',
                calcular: '/Calcular',
                pendencias: '/Pendencias'
            }
        };

        // ==========================================
        // üöÄ CACHE H√çBRIDO INTELIGENTE - 60 DIAS
        // ==========================================
        const CACHE_STRATEGY = {
            DEFAULT_RANGE_DAYS: 60,
            TTL: {
                historical: 24 * 60 * 60 * 1000,
                current_month: 5 * 60 * 1000,
                today: 30 * 1000
            }
        };

        // ==========================================
        // ‚ö° CONFIGURA√á√ÉO OTIMIZADA (pode alterar aqui)
        // ==========================================
        const CACHE_CONFIG = {
            daysToLoad: 6,  // Quantidade de dias para carregar (padr√£o: 6)
            ttl: {
                historical: 24 * 60 * 60 * 1000,  // 24h para dados antigos
                today: 30 * 1000  // 30s para dados de hoje
            }
        };

        const SMART_CACHE = {
            employees: new Map(),      // ‚úÖ NOVO: cache por funcion√°rio (REG_DATA_EMPRESA)
            historical: new Map(),
            recent: new Map(),
            today: new Map(),
            metadata: {
                lastFullLoad: null,
                lastUpdate: null,
                totalRequests: 0
            }
        };

        let autoRefreshInterval = null;

        // ==========================================
        // üì¶ CACHE POR FUNCION√ÅRIO - GET/SET
        // ==========================================
        function getCachedEmployee(reg, date, empresaId) {
            const key = `${reg}_${date}_${empresaId}`;
            return SMART_CACHE.employees.get(key) || null;
        }

        function setCachedEmployee(reg, date, empresaId, data, timestamp = Date.now()) {
            const key = `${reg}_${date}_${empresaId}`;
            data._cacheTimestamp = timestamp;
            SMART_CACHE.employees.set(key, data);
        }

        function getCachedDataByEmployee(dateStart, dateEnd) {
            const start = new Date(dateStart);
            const end = new Date(dateEnd);
            const allBatidas = [];
            
            const selectedCompanies = API_CONFIG.selectedCompanies.includes('all') 
                ? API_CONFIG.companies 
                : API_CONFIG.companies.filter(c => API_CONFIG.selectedCompanies.includes(c.id));
            
            console.log(`üîç Buscando no cache: ${dateStart} at√© ${dateEnd}`);
            console.log(`üì¶ Cache tem ${SMART_CACHE.employees.size} funcion√°rios`);
            
            // ‚úÖ NOVA ESTRUTURA: cache por funcion√°rio (reg_empresaId)
            // Cada entrada tem { data: { reg, nome, empresaId, empresaNome, batidas: [] }, timestamp, ttl }
            for (const [key, cacheEntry] of SMART_CACHE.employees.entries()) {
                const [reg, empresaId] = key.split('_');
                
                // Filtrar por empresa selecionada
                if (!selectedCompanies.some(c => String(c.id) === String(empresaId))) {
                    continue;
                }
                
                const funcionario = cacheEntry.data;
                
                if (!funcionario || !funcionario.batidas || !Array.isArray(funcionario.batidas)) {
                    continue;
                }
                
                // Filtrar batidas pelo per√≠odo
                funcionario.batidas.forEach(batida => {
                    const dataBatida = batida.Data ? new Date(batida.Data.split('T')[0]) : null;
                    
                    if (dataBatida && dataBatida >= start && dataBatida <= end) {
                        // Adicionar metadados da empresa se n√£o existirem
                        if (!batida._empresa) {
                            batida._empresa = funcionario.empresaNome;
                            batida._empresaId = funcionario.empresaId;
                        }
                        allBatidas.push(batida);
                    }
                });
            }
            
            console.log(`‚úÖ ${allBatidas.length} batidas encontradas no cache`);
            
            return allBatidas;
        }

        // ==========================================
        // üéØ INVALIDA√á√ÉO CIR√öRGICA - 1 FUNCION√ÅRIO
        // ==========================================
        async function invalidateSingleEmployee(reg, date, empresaId) {
            // Normalizar data
            let dateStr = date;
            if (date.includes('/')) {
                const [dia, mes, ano] = date.split('/');
                dateStr = `${ano}-${mes.padStart(2,'0')}-${dia.padStart(2,'0')}`;
            } else if (date.includes('T')) {
                dateStr = date.split('T')[0];
            }
            
            const key = `${reg}_${dateStr}_${empresaId}`;
            
            // Remover do cache
            SMART_CACHE.employees.delete(key);
            
            console.log(`üóëÔ∏è Cache invalidado: ${reg} em ${dateStr}`);
            
            // Recarregar APENAS este funcion√°rio da API
            return await reloadSingleEmployee(reg, dateStr, empresaId);
        }

        async function reloadSingleEmployee(reg, date, empresaId) {
            const company = API_CONFIG.companies.find(c => c.id === empresaId);
            if (!company) {
                console.warn(`‚ö†Ô∏è Empresa ${empresaId} n√£o encontrada`);
                return null;
            }
            
            console.log(`‚ö° Recarregando ${reg} de ${date}...`);
            
            try {
                const url = `${API_CONFIG.baseURL}/IntegracaoExterna/Batidas?dataInicio=${date}&dataFim=${date}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_CONFIG.token}`,
                        'secullumidbancoselecionado': company.id,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.warn(`‚ö†Ô∏è Erro ${response.status} ao recarregar ${reg}`);
                    return null;
                }
                
                const result = await response.json();
                
                // Filtrar APENAS o funcion√°rio espec√≠fico
                const employeeData = result.find(batida => {
                    const regBatida = batida.Funcionario?.NumeroIdentificador || 
                                     batida.Funcionario?.NumeroFolha;
                    return regBatida === reg;
                });
                
                if (employeeData) {
                    employeeData._empresa = company.name;
                    employeeData._empresaId = company.id;
                    
                    // Salvar no cache
                    setCachedEmployee(reg, date, empresaId, employeeData);
                    
                    console.log(`‚úÖ ${reg} atualizado no cache`);
                    return employeeData;
                }
                
                console.warn(`‚ö†Ô∏è Funcion√°rio ${reg} n√£o encontrado nos dados`);
                
            } catch (err) {
                console.error(`‚ùå Erro ao recarregar ${reg}:`, err);
            }
            
            return null;
        }

        // ==========================================
        // HELPER: Adicionar token de autentica√ß√£o em todas as requisi√ß√µes
        // ==========================================
        function getAuthHeaders(additionalHeaders = {}) {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            
            if (!token) {
                console.warn('?? Token n√£o encontrado - algumas funcionalidades podem n√£o funcionar');
                return {
                    'Content-Type': 'application/json',
                    ...additionalHeaders
                };
            }
            
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...additionalHeaders
            };
        }

        // Helper para fetch com autentica√ß√£oO (retorna null se n√£o autenticado)
        async function authenticatedFetch(url, options = {}) {
            const headers = getAuthHeaders(options.headers || {});
            if (!headers) {
                console.warn('?? Requisi√ß√£√£o ignorada - sem autentica√ß√£oO:', url);
                return null;
            }
            return fetch(url, { ...options, headers });
        }

        // ==========================================
        // configura√ß√£oO GLOBAL DA API
        // ==========================================
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://justificativas.up.railway.app';

        // ==========================================
        // configura√ß√£oO SQL AZURE (Node.js API)
        // ==========================================
        const SQL_API = {
            baseURL: `${API_BASE_URL}/api`,
            endpoints: {
                colaboradores: '/colaboradores',
                colaboradorByCPF: '/colaboradores/cpf',
                colaboradoresBatchCPF: '/colaboradores/batch-cpf'
            }
        };

        // Cache de dados do SQL Azure
        let sqlColaboradoresCache = {};

        // fun√ß√£oo para buscar colaborador por CPF no SQL Azure
        async function getColaboradorByCPF(cpf) {
            try {
                // Verificar se j√° est√© no cache
                const cpfLimpo = cpf.replace(/[^\d]/g, '');
                if (sqlColaboradoresCache[cpfLimpo]) {
                    return sqlColaboradoresCache[cpfLimpo];
                }

                const response = await fetch(`${SQL_API.baseURL}${SQL_API.endpoints.colaboradorByCPF}/${cpfLimpo}`);
                
                if (response.ok) {
                    const data = await response.json();
                    sqlColaboradoresCache[cpfLimpo] = data;
                    return data;
                }
                
                return null;
            } catch (error) {
                console.warn(`?? Erro ao buscar colaborador CPF ${cpf}:`, error.message);
                return null;
            }
        }

        // fun√ß√£oo para buscar m√©ltiplos colaboradores por CPFs (batch - mais r√°pido)
        async function getColaboradoresBatchCPF(cpfs) {
            try {
                const response = await fetch(`${SQL_API.baseURL}${SQL_API.endpoints.colaboradoresBatchCPF}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cpfs })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Adicionar ao cache
                    data.forEach(colab => {
                        const cpfLimpo = colab.CPF.replace(/[^\d]/g, '');
                        sqlColaboradoresCache[cpfLimpo] = colab;
                    });
                    
                    console.log(`? ${data.length} colaboradores carregados do SQL Azure`);
                    return data;
                }
                
                return [];
            } catch (error) {
                console.warn('?? Erro ao buscar colaboradores em batch:', error.message);
                return [];
            }
        }

        // fun√ß√£oo para autenticar na API Secullum
        async function authenticateAPI() {
            try {
                const body = new URLSearchParams({
                    grant_type: API_CONFIG.credentials.grant_type,
                    username: API_CONFIG.credentials.username,
                    password: API_CONFIG.credentials.password,
                    client_id: API_CONFIG.credentials.client_id
                });

                const response = await fetch(API_CONFIG.authURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body.toString()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Falha na autentica√ß√£oO: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                API_CONFIG.token = data.access_token;
                console.log('? autenticado com sucesso!');
                console.log('?? Token:', API_CONFIG.token.substring(0, 50) + '...');
                
                // Buscar empresas dispon√ß√£veis ap√©s autentica√ß√£oO
                await loadCompanies();
                
                return true;
            } catch (error) {
                console.error('? Erro na autentica√ß√£oO:', error);
                alert(`Erro ao conectar com a API Secullum:\n\n${error.message}\n\nVerifique as credenciais.`);
                return false;
            }
        }

        // fun√ß√£oo para buscar empresas (bancos) dispon√ß√£veis
        async function loadCompanies() {
            try {
                
                const response = await fetch('https://autenticador.secullum.com.br/ContasSecullumExterno/ListarBancos', {
                    headers: {
                        'Authorization': `Bearer ${API_CONFIG.token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro ao buscar empresas: ${response.status}`);
                }

                const bancos = await response.json();
                console.log(`? ${bancos.length} empresas encontradas`);
                
                // Cores para os bot√©es
                const cores = ['#7c3aed', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#8b5cf6', '#14b8a6'];
                
                API_CONFIG.companies = bancos.map((banco, index) => ({
                    id: banco.id.toString(),
                    name: banco.nome || banco.razaoSocial || `Empresa ${banco.id}`,
                    color: cores[index % cores.length],
                    documento: banco.documento
                }));
                
                // Atualizar bot√©es de empresas
                initCompanyButtons();
                
                
                
            } catch (error) {
                console.error('? Erro ao buscar empresas:', error);
                // Fallback para empresas padr√£o
                API_CONFIG.companies = [
                    { id: '3', name: 'LARSIL SERVICOS FLORESTAIS LTDA', color: '#7c3aed' }
                ];
                initCompanyButtons();
            }
        }

        // fun√ß√£oo para enriquecer batidas com nomes dos FUNCION√ÅRIOs
        async function enrichWithEmployeeNames(batidas, companies) {
            // Enriquecer com nomes dos funcion√°rios
            
            const funcionariosCache = new Map();
            const funcionariosAtivosSet = new Set(); // ? REGISTRAR APENAS FUNCION√ÅRIOS ATIVOS
            
            for (const company of companies) {
                try {
                    const url = `${API_CONFIG.baseURL}/IntegracaoExterna/Funcionarios`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${API_CONFIG.token}`,
                            'secullumidbancoselecionado': company.id,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const funcionarios = await response.json();
                        
                        // FILTRAR: Apenas FUNCION√ÅRIOs ATIVOS (sem data de demisS√≥o)
                        const funcionariosAtivos = funcionarios.filter(func => {
                            // ? CAMPO CORRETO: "Demissao" (conforme documenta√ß√£o Secullum)
                            const dataDemissao = func.Demissao || null;
                            
                            // Se tem data de demisS√≥o preenchida, EXCLUIR (n√£o mostrar)
                            if (dataDemissao && dataDemissao !== '0001-01-01T00:00:00' && dataDemissao !== null) {
                                return false; // Demitido - n√£o mostrar
                            }
                            
                            // Se n√£o tem demisS√≥o, √£ ATIVO
                            return true;
                        });
                        
                        console.log(`? ${company.name}: ${funcionariosAtivos.length} FUNCION√ÅRIOs ativos (total: ${funcionarios.length})`);
                        
                        funcionariosAtivos.forEach(func => {
                            const reg = func.NumeroIdentificador || func.NumeroFolha;
                            const key = `${company.id}_${reg}`;
                            
                            // Debug removido para performance
                            
                            // ? EXTRAIR DEPARTAMENTO (pode ser string ou objeto)
                            let departamento = null;
                            if (func.Departamento) {
                                if (typeof func.Departamento === 'string') {
                                    departamento = func.Departamento;
                                } else if (typeof func.Departamento === 'object') {
                                    // Se for objeto, tentar pegar Nome, Descricao, Codigo ou Id
                                    departamento = func.Departamento.Nome || 
                                                  func.Departamento.Descricao || 
                                                  func.Departamento.Codigo || 
                                                  func.Departamento.Id || 
                                                  null;
                                }
                            }
                            
                            funcionariosCache.set(key, {
                                nome: func.Nome || func.NomeCompleto || 'Nome n√£o informado',
                                cpf: func.Cpf || func.CPF || '',
                                pis: func.NumeroPis || func.PIS || '',
                                // ? DEPARTAMENTO DA API SECULLUM
                                projetoSecullum: departamento
                            });
                            
                            // ? MARCAR como ATIVO
                            funcionariosAtivosSet.add(key);
                        });
                    }
                } catch (error) {
                    console.warn(`?? Erro ao buscar FUNCION√ÅRIOs de ${company.name}`);
                }
            }
            
            // ? FILTRAR batidas: mostrar APENAS FUNCION√ÅRIOs ATIVOS (silencioso)
            const batidasFiltradas = batidas.filter(batida => {
                const reg = batida.Funcionario?.NumeroIdentificador || batida.Funcionario?.NumeroFolha;
                const key = `${batida._empresaId}_${reg}`;
                
                // Se n√£o est√© no Set de ativos, n√£o mostrar (demitido/inativo)
                if (!funcionariosAtivosSet.has(key)) {
                    return false;
                }
                
                // Enriquecer com nome se estiver no cache
                const funcInfo = funcionariosCache.get(key);
                if (funcInfo) {
                    batida._funcionarioNome = funcInfo.nome;
                    batida._funcionarioCpf = funcInfo.cpf;
                    batida._projetoSecullum = funcInfo.projetoSecullum; // ? PROJETO DA API SECULLUM
                }
                
                return true;
            });
            
            console.log(`? Nomes carregados! ${batidasFiltradas.length} registros (apenas FUNCION√ÅRIOs ativos)`);
            
            // ? SUBSTITUIR array original
            batidas.length = 0;
            batidas.push(...batidasFiltradas);
        }

        // üöÄ BUSCAR DADOS DE 1 DIA (micro-request para cache)
        async function fetchDayData(company, date) {
            try {
                const url = `${API_CONFIG.baseURL}/IntegracaoExterna/Batidas?dataInicio=${date}&dataFim=${date}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_CONFIG.token}`,
                        'secullumidbancoselecionado': company.id,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) return [];
                
                const result = await response.json();
                
                if (Array.isArray(result)) {
                    result.forEach(batida => {
                        batida._empresa = company.name;
                        batida._empresaId = company.id;
                    });
                    return result;
                }
                
                return [];
            } catch (err) {
                return [];
            }
        }

        // ==========================================
        // ‚úÖ FUN√á√ÉO OTIMIZADA - USA RANGE DE DATAS
        // ==========================================
        async function loadFullHistoricalCache() {
            console.log('üöÄ [OTIMIZADO] Iniciando carga com date range...');
            showLoading('‚ö° Carregando dados otimizados...');
            
            const now = new Date();
            const startDate = new Date(now);
            startDate.setDate(startDate.getDate() - parseInt(CACHE_CONFIG.daysToLoad) + 1);
            
            // Formatar datas para API (YYYY-MM-DD)
            const dataInicio = formatDateForAPI(startDate);
            const dataFim = formatDateForAPI(now);
            
            console.log(`üìÖ Range solicitado: ${dataInicio} at√© ${dataFim} (${CACHE_CONFIG.daysToLoad} dias)`);
            
            // Buscar empresas selecionadas
            const empresas = API_CONFIG.selectedCompanies.includes('all')
                ? API_CONFIG.companies
                : API_CONFIG.companies.filter(c => API_CONFIG.selectedCompanies.includes(c.id));
            
            console.log(`üè¢ Empresas selecionadas: ${empresas.map(e => e.name).join(', ')}`);
            
            if (empresas.length === 0) {
                hideLoading();
                showNotification('‚ö†Ô∏è Nenhuma empresa selecionada', 'warning');
                return false;
            }
            
            try {
                const startTime = Date.now();
                
                // ‚úÖ OTIMIZA√á√ÉO: 1 request por empresa (PARALELO)
                const promises = empresas.map(async (empresa) => {
                    console.log(`üîÑ Buscando dados da ${empresa.name}...`);
                    
                    try {
                        const url = `${API_CONFIG.baseURL}/IntegracaoExterna/Batidas?dataInicio=${dataInicio}&dataFim=${dataFim}`;
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${API_CONFIG.token}`,
                                'secullumidbancoselecionado': empresa.id,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`‚ùå Erro ${response.status} na empresa ${empresa.name}:`, errorText);
                            throw new Error(`Erro ${response.status} na empresa ${empresa.name}`);
                        }
                        
                        const data = await response.json();
                        console.log(`‚úÖ ${empresa.name}: ${data.length} batidas recebidas`);
                        
                        return {
                            empresaId: empresa.id,
                            empresaNome: empresa.name,
                            data: Array.isArray(data) ? data : [],
                            success: true
                        };
                        
                    } catch (error) {
                        console.error(`‚ùå Falha ao buscar ${empresa.name}:`, error);
                        return {
                            empresaId: empresa.id,
                            empresaNome: empresa.name,
                            data: [],
                            success: false,
                            error: error.message
                        };
                    }
                });
                
                // ‚úÖ Aguardar TODAS as empresas em paralelo
                console.log(`‚è≥ Aguardando ${promises.length} requisi√ß√µes paralelas...`);
                const results = await Promise.all(promises);
                
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`‚ö° Tempo total de requisi√ß√µes: ${elapsed}s`);
                
                // Verificar falhas
                const failures = results.filter(r => !r.success);
                if (failures.length > 0) {
                    console.warn(`‚ö†Ô∏è ${failures.length} empresa(s) falharam:`, failures.map(f => f.empresaNome));
                }
                
                // ‚úÖ Processar e cachear por funcion√°rio
                let totalFuncionarios = 0;
                let totalBatidas = 0;
                
                results.forEach(result => {
                    if (!result.success || result.data.length === 0) {
                        console.log(`‚è≠Ô∏è Pulando ${result.empresaNome} (sem dados ou erro)`);
                        return;
                    }
                    
                    const { empresaId, empresaNome, data } = result;
                    totalBatidas += data.length;
                    
                    // Agrupar batidas por funcion√°rio
                    const funcionariosMap = new Map();
                    
                    data.forEach(batida => {
                        // Extrair REG do funcion√°rio
                        const reg = batida.Funcionario?.NumeroIdentificador || 
                                   batida.Funcionario?.NumeroFolha || 
                                   null;
                        
                        if (!reg) {
                            console.warn('‚ö†Ô∏è Batida sem REG:', batida);
                            return;
                        }
                        
                        if (!funcionariosMap.has(reg)) {
                            funcionariosMap.set(reg, {
                                reg: reg,
                                nome: batida.Funcionario?.Nome || 'Nome n√£o dispon√≠vel',
                                empresaId: empresaId,
                                empresaNome: empresaNome,
                                batidas: []
                            });
                        }
                        
                        funcionariosMap.get(reg).batidas.push(batida);
                    });
                    
                    console.log(`üìä ${empresaNome}: ${funcionariosMap.size} funcion√°rios encontrados`);
                    
                    // Cachear cada funcion√°rio individualmente
                    funcionariosMap.forEach((funcionario, reg) => {
                        const cacheKey = `${reg}_${empresaId}`;
                        
                        // Determinar TTL baseado na data mais recente
                        let ttl = CACHE_CONFIG.ttl.historical; // Padr√£o: 24h
                        
                        const hoje = new Date().toISOString().split('T')[0];
                        const temBatidasHoje = funcionario.batidas.some(b => {
                            const dataBatida = b.Data ? b.Data.split('T')[0] : null;
                            return dataBatida === hoje;
                        });
                        
                        if (temBatidasHoje) {
                            ttl = CACHE_CONFIG.ttl.today; // 30s
                        }
                        
                        SMART_CACHE.employees.set(cacheKey, {
                            data: funcionario,
                            timestamp: Date.now(),
                            ttl: ttl
                        });
                        
                        totalFuncionarios++;
                    });
                });
                
                hideLoading();
                
                console.log(`‚úÖ Cache populado com sucesso!`);
                console.log(`üìä Estat√≠sticas:`);
                console.log(`   - Funcion√°rios: ${totalFuncionarios}`);
                console.log(`   - Batidas totais: ${totalBatidas}`);
                console.log(`   - Tempo total: ${elapsed}s`);
                console.log(`   - Performance: ${(totalBatidas / parseFloat(elapsed)).toFixed(0)} batidas/segundo`);
                
                showNotification(`‚úÖ Dados carregados em ${elapsed}s! (${totalFuncionarios} funcion√°rios)`, 'success');
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar dados:', error);
                hideLoading();
                showNotification(`‚ùå Erro: ${error.message}`, 'error');
                return false;
            }
        }

        // ==========================================
        // ‚úÖ FUN√á√ÉO AUXILIAR - FORMATAR DATA PARA API
        // ==========================================
        function formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`; // Retorna "2025-11-30"
        }

        // ==========================================
        // ‚úÖ NORMALIZAR DATAS DE DIFERENTES FORMATOS
        // ==========================================
        function normalizeDate(dateStr) {
            if (!dateStr) return null;
            
            // J√° est√° no formato correto (YYYY-MM-DD)
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Formato DD/MM/YYYY
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                const [day, month, year] = dateStr.split('/');
                return `${year}-${month}-${day}`;
            }
            
            // Formato estranho: 27T00:00:00/10/2025
            const strangeMatch = dateStr.match(/^(\d{2})T\d{2}:\d{2}:\d{2}\/(\d{2})\/(\d{4})$/);
            if (strangeMatch) {
                const [, day, month, year] = strangeMatch;
                return `${year}-${month}-${day}`;
            }
            
            // Tentar parsear como Date
            const parsed = new Date(dateStr);
            if (!isNaN(parsed.getTime())) {
                return formatDateForAPI(parsed);
            }
            
            console.warn('‚ö†Ô∏è Formato de data n√£o reconhecido:', dateStr);
            return null;
        }

        // üîÑ ATUALIZAR APENAS HOJE E ONTEM (30s)
        async function updateRecentData() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const yesterday = new Date(now - 24*60*60*1000).toISOString().split('T')[0];
            
            console.log('‚ö° Atualizando apenas hoje e ontem...');
            
            const companies = API_CONFIG.companies;
            const dates = [yesterday, today];
            const promises = [];
            
            dates.forEach(date => {
                companies.forEach(company => {
                    promises.push(
                        fetchDayData(company, date).then(data => ({
                            date,
                            companyId: company.id,
                            data
                        }))
                    );
                });
            });
            
            const results = await Promise.allSettled(promises);
            
            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    const { date, companyId, data } = result.value;
                    const key = `${date}_${companyId}`;
                    SMART_CACHE.today.set(key, data);
                }
            });
            
            SMART_CACHE.metadata.lastUpdate = Date.now();
            console.log('‚úÖ Dados recentes atualizados');
        }

        // üìä PEGAR DADOS DO CACHE (INSTANT√ÇNEO)
        // fun√ß√£oo para buscar batidas de todas as empresas selecionadas
        async function fetchEmployeesFromAPI(dateStart, dateEnd) {
            try {
                console.log('üîç Iniciando busca inteligente...');
                
                // üì¶ STEP 1: Carregar cache hist√≥rico (se n√£o existir)
                if (!SMART_CACHE.metadata.lastFullLoad) {
                    console.log('üì• PRIMEIRA CARGA: Buscando 60 dias...');
                    await loadFullHistoricalCache();
                }
                
                // üîÑ STEP 2: Atualizar APENAS os dados recentes
                const now = Date.now();
                const needsUpdate = !SMART_CACHE.metadata.lastUpdate || 
                                   (now - SMART_CACHE.metadata.lastUpdate) > CACHE_STRATEGY.TTL.today;
                
                if (needsUpdate) {
                    console.log('‚ö° Atualizando dados recentes...');
                    await updateRecentData();
                }
                
                // üìä STEP 3: Montar resultado do cache POR FUNCION√ÅRIO
                const startTime = performance.now();
                let allBatidas = getCachedDataByEmployee(dateStart, dateEnd);
                const elapsed = ((performance.now() - startTime)).toFixed(2);
                
                console.log(`‚úÖ ${allBatidas.length} registros prontos em ${elapsed}ms do cache`);
                
                // Validar se h√° dados no per√≠odo solicitado
                if (allBatidas.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum registro encontrado no per√≠odo selecionado');
                    alert('Nenhum registro encontrado no per√≠odo selecionado.\n\nVerifique se:\n‚Ä¢ O per√≠odo est√° dentro dos √∫ltimos 60 dias\n‚Ä¢ As empresas selecionadas possuem dados');
                    return [];
                }
                
                const companies = API_CONFIG.selectedCompanies.includes('all') 
                    ? API_CONFIG.companies 
                    : API_CONFIG.companies.filter(c => API_CONFIG.selectedCompanies.includes(c.id));
                
                await enrichWithEmployeeNames(allBatidas, companies);
                
                // Auto-refresh: iniciar se n√£o estiver rodando
                if (!autoRefreshInterval) {
                    console.log('üîÑ Iniciando auto-refresh (30s)');
                    autoRefreshInterval = setInterval(updateRecentData, CACHE_STRATEGY.TTL.today);
                }
                
                return parseSecullumData(allBatidas, dateStart);
            } catch (error) {
                console.error('‚ùå Erro ao buscar colaboradores:', error);
                
                // Limpar cache se houver erro cr√≠tico
                if (error.message.includes('fetch') || error.message.includes('network')) {
                    console.warn('‚ö†Ô∏è Erro de rede detectado - mantendo cache local');
                } else {
                    console.error('‚ùå Erro cr√≠tico - resetando cache');
                    SMART_CACHE.metadata.lastFullLoad = null;
                }
                
                alert(`Erro ao buscar dados da API:\n\n${error.message}\n\nTente novamente ou contate o suporte.`);
                return [];
            }
        }
        
        // üßπ CLEANUP: Parar auto-refresh quando necess√°rio
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('üõë Auto-refresh parado');
            }
        }
        
        // üóëÔ∏è LIMPAR CACHE: √ötil para for√ßar recarga completa
        function clearCache() {
            SMART_CACHE.employees.clear();
            SMART_CACHE.historical.clear();
            SMART_CACHE.recent.clear();
            SMART_CACHE.today.clear();
            SMART_CACHE.metadata.lastFullLoad = null;
            SMART_CACHE.metadata.lastUpdate = null;
            SMART_CACHE.metadata.totalRequests = 0;
            stopAutoRefresh();
            console.log('üóëÔ∏è Cache limpo - pr√≥xima busca far√° carga completa');
        }
        
        // üîÑ ATUALIZAR FUNCION√ÅRIO INDIVIDUAL
        async function refreshEmployee(reg, date, empresaId) {
            try {
                showLoading(`‚ö° Atualizando ${reg}...`);
                
                // Invalidar e recarregar
                const newData = await invalidateSingleEmployee(reg, date, empresaId);
                
                // Atualizar objeto em allEmployees
                const employee = allEmployees.find(e => 
                    e.reg === reg && e.date === date && e.empresaId === empresaId
                );
                
                if (employee && newData) {
                    // Atualizar punches com dados da API
                    Object.assign(employee.punches, {
                        ent1: newData.Entrada1 || '',
                        sai1: newData.Saida1 || '',
                        ent2: newData.Entrada2 || '',
                        sai2: newData.Saida2 || '',
                        ent3: newData.Entrada3 || '',
                        sai3: newData.Saida3 || '',
                        ent4: newData.Entrada4 || '',
                        sai4: newData.Saida4 || '',
                        ent5: newData.Entrada5 || '',
                        sai5: newData.Saida5 || ''
                    });
                    
                    // Atualizar rawData
                    employee.rawData = newData;
                    
                    // Recalcular status
                    updateEmployeeStatus(employee);
                    
                    // Re-renderizar tabela
                    renderTable();
                    
                    hideLoading();
                    console.log(`‚úÖ ${reg} atualizado com sucesso!`);
                    
                } else {
                    hideLoading();
                    console.warn(`‚ö†Ô∏è Funcion√°rio ${reg} n√£o encontrado ap√≥s atualiza√ß√£o`);
                    alert(`‚ö†Ô∏è N√£o foi poss√≠vel atualizar os dados de ${reg}`);
                }
                
            } catch (err) {
                hideLoading();
                console.error(`‚ùå Erro ao atualizar ${reg}:`, err);
                alert(`‚ùå Erro ao atualizar funcion√°rio:\n${err.message}`);
            }
        }
        
        // Expor fun√ß√£o globalmente para debug
        window.clearCache = clearCache;
        window.refreshEmployee = refreshEmployee;
        window.cacheStats = () => {
            console.log('üìä CACHE STATS:');
            console.log(`  Historical: ${SMART_CACHE.historical.size} registros`);
            console.log(`  Recent: ${SMART_CACHE.recent.size} registros`);
            console.log(`  Today: ${SMART_CACHE.today.size} registros`);
            console.log(`  Last Full Load: ${SMART_CACHE.metadata.lastFullLoad ? new Date(SMART_CACHE.metadata.lastFullLoad).toLocaleString() : 'Nunca'}`);
            console.log(`  Last Update: ${SMART_CACHE.metadata.lastUpdate ? new Date(SMART_CACHE.metadata.lastUpdate).toLocaleString() : 'Nunca'}`);
            return {
                historical: SMART_CACHE.historical.size,
                recent: SMART_CACHE.recent.size,
                today: SMART_CACHE.today.size,
                lastFullLoad: SMART_CACHE.metadata.lastFullLoad,
                lastUpdate: SMART_CACHE.metadata.lastUpdate
            };
        };
        
        // Limpar ao sair da p√°gina
        window.addEventListener('beforeunload', stopAutoRefresh);

        // fun√ß√£oo para converter dados da Secullum para formato interno
        function parseSecullumData(batidas, dataRef) {
            // Agrupar batidas por FUNCION√ÅRIO + data
            const funcionariosMap = new Map();

            batidas.forEach(batida => {
                // Pegar informa√ß√µeses do FUNCION√ÅRIO
                const reg = batida.Funcionario?.NumeroIdentificador || batida.Funcionario?.NumeroFolha || batida.FuncionarioId || 'N/A';
                const pis = batida.Funcionario?.NumeroPis || '';
                const dataFormatada = batida.Data || dataRef;
                const key = `${reg}_${dataFormatada}`;
                
                if (!funcionariosMap.has(key)) {
                    funcionariosMap.set(key, {
                        reg: reg,
                        pis: pis,
                        cpf: batida._funcionarioCpf || '',
                        name: batida._funcionarioNome || `FUNCION√ÅRIO ${reg}`,
                        city: batida._empresa || 'N/A',
                        project: 'N/A',
                        projetoSecullum: batida._projetoSecullum || null, // ? PROJETO DA API SECULLUM
                        date: formatDateBR(dataFormatada),
                        day: getDayOfWeek(dataFormatada),
                        punches: {
                            ent1: '',
                            sai1: '',
                            ent2: '',
                            sai2: '',
                            ent3: '',
                            sai3: '',
                            ent4: '',
                            sai4: '',
                            ent5: '',
                            sai5: ''
                        },
                        motivo: batida.Observacoes || '',
                        attachments: [],
                        hasInconsistency: false,
                        empresa: batida._empresa || 'N/A',
                        empresaId: batida._empresaId || '',
                        rawData: batida
                    });
                }

                const func = funcionariosMap.get(key);
                
                // DEBUG: Log para investigar afastamentos
                if (batida.Entrada1 === 'A. INSS' || batida.Entrada1 === 'AFASTAMENTO INSS') {
                    console.log('?? AFASTAMENTO DETECTADO:', {
                        nome: batida._funcionarioNome,
                        reg: reg,
                        data: dataFormatada,
                        entrada1: batida.Entrada1,
                        saida1: batida.Saida1,
                        entrada2: batida.Entrada2,
                        saida2: batida.Saida2,
                        entrada3: batida.Entrada3,
                        saida3: batida.Saida3,
                        entrada4: batida.Entrada4,
                        saida4: batida.Saida4,
                        entrada5: batida.Entrada5,
                        saida5: batida.Saida5,
                        observacoes: batida.Observacoes,
                        dadosCompletos: batida
                    });
                }
                
                // Pegar Hor√°rios das entradas/SA√çdas
                // fun√ß√£oo auxiliar para verificar se √£ Hor√°rio v√°lido (HH:MM)
                const isValidTime = (val) => {
                    if (!val) return false;
                    // Verifica se √£ formato de Hor√°rio (ex: 08:00, 12:30)
                    return /^\d{1,2}:\d{2}$/.test(val);
                };
                
                // Lista de status especiais (motivos, n√£o Hor√°rios)
                const statusEspeciais = ['FALTA', 'FERIAS', 'A. INSS', 'AFASTAMENTO INSS', 'A.INSS', 'L.MATER', 'L. MATER', 'LIC.MATERNIDADE'];
                
                // Pegar Hor√°rios OU deixar vazio se for status especial
                func.punches.ent1 = isValidTime(batida.Entrada1) ? batida.Entrada1 : '';
                func.punches.sai1 = isValidTime(batida.Saida1) ? batida.Saida1 : '';
                func.punches.ent2 = isValidTime(batida.Entrada2) ? batida.Entrada2 : '';
                func.punches.sai2 = isValidTime(batida.Saida2) ? batida.Saida2 : '';
                func.punches.ent3 = isValidTime(batida.Entrada3) ? batida.Entrada3 : '';
                func.punches.sai3 = isValidTime(batida.Saida3) ? batida.Saida3 : '';
                func.punches.ent4 = isValidTime(batida.Entrada4) ? batida.Entrada4 : '';
                func.punches.sai4 = isValidTime(batida.Saida4) ? batida.Saida4 : '';
                func.punches.ent5 = isValidTime(batida.Entrada5) ? batida.Entrada5 : '';
                func.punches.sai5 = isValidTime(batida.Saida5) ? batida.Saida5 : '';
                
                // Detectar motivos especiais em qualquer entrada
                const todasEntradas = [
                    batida.Entrada1, batida.Saida1, batida.Entrada2, batida.Saida2,
                    batida.Entrada3, batida.Saida3, batida.Entrada4, batida.Saida4,
                    batida.Entrada5, batida.Saida5
                ];
                
                // Procurar por status especial
                for (const entrada of todasEntradas) {
                    if (entrada && statusEspeciais.includes(entrada)) {
                        if (entrada === 'FALTA') {
                            func.motivo = 'FALTA';
                        } else if (entrada === 'FERIAS') {
                            func.motivo = 'F√ß√£RIAS';
                        } else if (entrada === 'A. INSS' || entrada === 'AFASTAMENTO INSS' || entrada === 'A.INSS') {
                            func.motivo = 'AFASTAMENTO INSS';
                        } else if (entrada === 'L.MATER' || entrada === 'L. MATER' || entrada === 'LIC.MATERNIDADE') {
                            func.motivo = 'LICEN√ß√£A MATERNIDADE';
                        }
                        break; // j√° encontrou o motivo, n√£o precisa continuar
                    }
                }

                // Verificar inconsist√™ncias
                // REGRAS ATUALIZADAS:
                // - Pontos √≠mpares (entrada sem sa√≠da) = inconsist√™ncia
                // - Hor√°rios trocados (ordem errada) = inconsist√™ncia
                // - 6 batidas = NORMAL (n√£o √© inconsist√™ncia)
                // - Dept 400: 2 batidas OK
                // - Domingos: ignorar para departamentos espec√≠ficos
                
                const batidas = [
                    func.punches.ent1, func.punches.sai1,
                    func.punches.ent2, func.punches.sai2,
                    func.punches.ent3, func.punches.sai3,
                    func.punches.ent4, func.punches.sai4,
                    func.punches.ent5, func.punches.sai5
                ].filter(h => h && h !== '--:--');
                
                const totalBatidas = batidas.length;
                
                // Se tem motivo especial (f√©rias, afastamento, falta justificada, etc), N√ÉO √© inconsist√™ncia
                const motivosEspeciais = ['FALTA', 'F√âRIAS', 'AFASTAMENTO INSS', 'LICEN√áA MATERNIDADE', 'FOLGA'];
                const temMotivoEspecial = motivosEspeciais.includes(func.motivo);
                
                // TAREFA 8: Departamento 400 permite apenas 2 batidas (ent1 + sai1)
                const isDept400 = String(func.Departamento || '').includes('400') || String(func.projetoSecullum || '').includes('400');
                
                // TAREFA 9: Verificar se √© domingo e se deve ignorar
                const dataBatida = new Date(func.rawData?.Data || func.date);
                const diaSemana = dataBatida.getDay(); // 0 = Domingo, 6 = S√°bado
                const isDomingo = diaSemana === 0;
                
                // Departamentos que n√£o contabilizam domingos como inconsist√™ncia
                const deptsSemDomingo = {
                    'LARSIL': ['202', '207', '209', '400', '706', '961'],
                    'S5 FLORESTAL': ['400'],
                    'ALR EMPREENDIMENTOS': ['400'],
                    'DS3': ['400']
                };
                
                let ignorarDomingo = false;
                if (isDomingo) {
                    const empresaNome = func.rawData?.['Empresa Nome'] || func.empresaNome || '';
                    const dept = String(func.Departamento || func.projetoSecullum || '');
                    
                    for (const [empresa, depts] of Object.entries(deptsSemDomingo)) {
                        if (empresaNome.includes(empresa)) {
                            if (depts.some(d => dept.includes(d))) {
                                ignorarDomingo = true;
                                break;
                            }
                        }
                    }
                }
                
                // fun√ß√£oo para converter HH:MM em minutos
                const timeToMinutes = (time) => {
                    if (!time) return 0;
                    const [h, m] = time.split(':').map(Number);
                    return h * 60 + m;
                };
                
                // VALIDAR ORDEM DOS HOR√ÅRIOS (tarefa 6: continuar destacando em vermelho)
                let ordemIncorreta = false;
                const horariosOrdenados = [
                    { nome: 'Entrada 1', hora: func.punches.ent1 },
                    { nome: 'Sa√≠da 1', hora: func.punches.sai1 },
                    { nome: 'Entrada 2', hora: func.punches.ent2 },
                    { nome: 'Sa√≠da 2', hora: func.punches.sai2 },
                    { nome: 'Entrada 3', hora: func.punches.ent3 },
                    { nome: 'Sa√≠da 3', hora: func.punches.sai3 },
                    { nome: 'Entrada 4', hora: func.punches.ent4 },
                    { nome: 'Sa√≠da 4', hora: func.punches.sai4 },
                    { nome: 'Entrada 5', hora: func.punches.ent5 },
                    { nome: 'Sa√≠da 5', hora: func.punches.sai5 }
                ].filter(h => h.hora && h.hora !== '--:--');
                
                for (let i = 1; i < horariosOrdenados.length; i++) {
                    const anterior = timeToMinutes(horariosOrdenados[i - 1].hora);
                    const atual = timeToMinutes(horariosOrdenados[i].hora);
                    
                    if (atual <= anterior) {
                        ordemIncorreta = true;
                        console.log(` Ordem incorreta: ${func.name} - ${horariosOrdenados[i - 1].nome} (${horariosOrdenados[i - 1].hora}) >= ${horariosOrdenados[i].nome} (${horariosOrdenados[i].hora})`);
                        break;
                    }
                }
                
                // TAREFA 6: Verificar pontos √≠mpares (entrada sem sa√≠da)
                const pontosImpares = totalBatidas % 2 !== 0; // √çmpar = falta entrada ou sa√≠da
                
                // REGRAS DE INCONSIST√äNCIA:
                let batidaIncorreta = false;
                
                if (isDept400) {
                    // Dept 400: aceita 2 batidas (ent1 + sai1), qualquer outro n√∫mero √© inconsist√™ncia
                    batidaIncorreta = totalBatidas !== 2;
                } else if (ignorarDomingo) {
                    // Domingo nos departamentos especificados: n√£o √© inconsist√™ncia
                    batidaIncorreta = false;
                } else {
                    // Regra geral:
                    // - Pontos √≠mpares = inconsist√™ncia
                    // - Ordem incorreta = inconsist√™ncia  
                    // - 6 batidas = OK (n√£o √© inconsist√™ncia)
                    // - 4 batidas = OK (n√£o √© inconsist√™ncia)
                    // - Outros n√∫meros pares >= 2 = OK
                    batidaIncorreta = pontosImpares || ordemIncorreta;
                }
                
                if (batidaIncorreta && !temMotivoEspecial) {
                    func.hasInconsistency = true;
                }
            });

            return Array.from(funcionariosMap.values());
        }

        // fun√ß√µes auxiliares
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function getDayOfWeek(dateString) {
            const days = ['domingo', 'segunda-feira', 'ter√ß√£a-feira', 'quarta-feira', 'quinta-feira', 'sexta-feira', 'S√≥bado'];
            
            let date;
            
            // Formato estranho: 27T00:00:00/10/2025
            const strangeMatch = dateString.match(/^(\d{1,2})T\d{2}:\d{2}:\d{2}\/(\d{1,2})\/(\d{4})/);
            if (strangeMatch) {
                const [_, dia, mes, ano] = strangeMatch;
                date = new Date(ano, parseInt(mes) - 1, parseInt(dia));
            }
            // Se est√© no formato dd/mm/yyyy
            else if (dateString.includes('/') && !dateString.includes('T')) {
                const parts = dateString.split('/');
                date = new Date(parts[2], parts[1] - 1, parts[0]);
            } 
            // Se est√© no formato ISO (YYYY-MM-DD)
            else if (dateString.includes('-')) {
                date = new Date(dateString.split('T')[0] + 'T00:00:00');
            } 
            // Outro formato
            else {
                date = new Date(dateString);
            }
            
            return days[date.getDay()];
        }

        function formatDateBR(dateString) {
            if (!dateString) return '';
            
            // Formato estranho: 27T00:00:00/10/2025 ou similar
            // Precisamos extrair: dia, m√©s, ano
            
            // Tentar extrair padr√£o: DDT00:00:00/MM/YYYY
            const strangeMatch = dateString.match(/^(\d{1,2})T\d{2}:\d{2}:\d{2}\/(\d{1,2})\/(\d{4})/);
            if (strangeMatch) {
                const [_, dia, mes, ano] = strangeMatch;
                return `${dia.padStart(2, '0')}/${mes.padStart(2, '0')}/${ano}`;
            }
            
            // Se j√° est√© em formato brasileiro (DD/MM/YYYY)
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
                const parts = dateString.split('/');
                return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
            }
            
            // Se est√© em formato ISO (YYYY-MM-DD)
            if (/^\d{4}-\d{1,2}-\d{1,2}/.test(dateString)) {
                const [year, month, day] = dateString.split('-').map(p => p.split('T')[0]);
                return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
            }
            
            // Retornar original se n√£o conseguir formatar
            return dateString;
        }

        // ==========================================
        // DADOS REAIS DA API
        // ==========================================
        let allEmployees = [];

        let showOnlyInconsistencies = false;
        let selectedEmployees = [];
        let useDigitalSignature = false;
        let isAPIConnected = false;
        
        // ?? CORRE√ß√£√£O: Flags de controle para evitar race conditions
        let renderingTable = false;
        let loadingAnexos = false;

        // ?? CORRE√ß√£√£O: Event delegation - executar apenas UMA VEZ
        (function initEventListeners() {
            const tableBody = document.getElementById('employeeTable');
            
            // Checkboxes
            tableBody.addEventListener('change', (e) => {
                if (!e.target.classList.contains('employee-checkbox')) return;
                handleCheckboxChange(e);
            });
            
            // Edi√ß√£o inline (duplo clique)
            tableBody.addEventListener('dblclick', (e) => {
                const cell = e.target.closest('td[data-punch]');
                if (cell && !cell.classList.contains('editing')) {
                    startInlineEdit(cell);
                }
            });
            
            console.log('? Event listeners inicializados (event delegation)');
        })();

        function handleCheckboxChange(e) {
            e.stopPropagation();
            const uniqueId = e.target.dataset.id;
            
            if (e.target.checked) {
                if (!selectedEmployees.includes(uniqueId)) {
                    selectedEmployees.push(uniqueId);
                }
            } else {
                selectedEmployees = selectedEmployees.filter(id => id !== uniqueId);
            }
            
            const row = e.target.closest('tr');
            if (row) row.classList.toggle('selected', e.target.checked);
        }

        // Conectar √£ API (apenas autentica√ß√£oO)
        async function connectToAPI() {
            const apiStatus = document.getElementById('apiStatus');
            
            apiStatus.innerHTML = '? Autenticando...';
            
            const authenticated = await authenticateAPI();
            
            if (authenticated) {
                isAPIConnected = true;
                
                apiStatus.className = 'api-status connected';
                apiStatus.innerHTML = '<span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block;"></span> API Conectada';
                
                console.log(`? API conectada com ${API_CONFIG.companies.length} empresa(s)`);
                
                return true;
            } else {
                apiStatus.className = 'api-status disconnected';
                apiStatus.innerHTML = '<span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: inline-block;"></span> Erro na conex√£o';
                return false;
            }
        }

        // Buscar dados do Per√≠odo
        async function searchPeriod() {
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            const apiStatus = document.getElementById('apiStatus');
            
            if (!dateStart || !dateEnd) {
                showAlert('Aten√£oo', 'Por favor, selecione as datas de In√≠cio e fim!', 'warning');
                return;
            }
            
            // Calcular dias do Per√≠odo
            const start = new Date(dateStart);
            const end = new Date(dateEnd);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Avisar se o Per√≠odo for muito longo
            if (diffDays > 365) {
                showAlert(
                    'Per√≠odo Muito Longo!',
                    `voc√™ est√° buscando ${diffDays} dias de dados!\n\nIsso pode:\n‚Ä¢ Demorar muito tempo (v√°rios minutos)\n‚Ä¢ Sobrecarregar a API\n‚Ä¢ Causar erros de timeout\n\nüí° Sugest√£o: Busque Per√≠odos menores (1 m√™s por vez)`,
                    'warning'
                );
                return;
            } else if (diffDays > 90) {
                console.warn(`?? Per√≠odo longo: ${diffDays} dias. Pode demorar...`);
            }
            
            showLoading(`Buscando ${diffDays} dias de dados...`);
            apiStatus.innerHTML = `? Buscando ${diffDays} dias de dados...`;
            const startTime = performance.now();
            
            const apiData = await fetchEmployeesFromAPI(dateStart, dateEnd);
            
            const endTime = performance.now();
            const timeElapsed = ((endTime - startTime) / 1000).toFixed(2);
            
            if (apiData && apiData.length > 0) {
                allEmployees.length = 0;
                allEmployees.push(...apiData);
                
                // Ordenar alfabeticamente ao carregar
                allEmployees.sort((a, b) => a.name.localeCompare(b.name));
                
                // FAZER MATCH COM SQL AZURE (buscar L√≠der e PROJETO)
                const cpfs = [...new Set(allEmployees.map(emp => emp.cpf).filter(cpf => cpf))];
                const sqlData = await getColaboradoresBatchCPF(cpfs);
                
                // Fazer match por CPF
                allEmployees.forEach(emp => {
                    if (emp.cpf) {
                        const cpfLimpo = emp.cpf.replace(/[^\d]/g, '');
                        const sqlColab = sqlColaboradoresCache[cpfLimpo];
                        if (sqlColab) {
                            emp.nomeLider = sqlColab.NOME_LIDER || sqlColab.Lider || null;
                            emp.projeto = sqlColab.PROJETO || sqlColab.Projeto || null;
                        } else {
                            emp.nomeLider = null;
                            emp.projeto = null;
                        }
                    }
                });
                
                // CARREGAR ANEXOS E IDS EM PARALELO
                await carregarAnexos().catch(err => console.error('? Erro ao carregar anexos:', err));
                await carregarIDs().catch(err => console.error('? Erro ao carregar IDs:', err));
                
                hideLoading();
                apiStatus.className = 'api-status connected';
                apiStatus.innerHTML = `?? ${apiData.length} registros (${timeElapsed}s)`;
                
                renderTable();
                
                showAlert(
                    'Dados Carregados!',
                    `${apiData.length} registros carregados em ${timeElapsed}s`,
                    'success'
                );
            } else {
                hideLoading();
                showAlert('Sem Dados', 'Nenhum registro encontrado neste Per√≠odo!', 'warning');
                apiStatus.className = 'api-status connected';
                apiStatus.innerHTML = '<span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%; display: inline-block;"></span> API Conectada';
            }
        }
        
        // ?? CARREGAR ANEXOS DIRETO DO AZURE SQL (TABELA ANEXOS)
        async function carregarAnexos() {
            loadingAnexos = true;
            
            try {
                const dataInicio = document.getElementById('dateStart').value;
                const dataFim = document.getElementById('dateEnd').value;
                
                // Buscar empresas selecionadas corretamente
                const companies = API_CONFIG.selectedCompanies.includes('all') 
                    ? API_CONFIG.companies 
                    : API_CONFIG.companies.filter(c => API_CONFIG.selectedCompanies.includes(c.id));
                
                const empresasSelecionadas = companies.map(c => c.id);
                
                for (let empresaId of empresasSelecionadas) {
                    // Buscar anexos de cada dia do Per√≠odo
                    const inicio = new Date(dataInicio);
                    const fim = new Date(dataFim);
                    
                    for (let d = new Date(inicio); d <= fim; d.setDate(d.getDate() + 1)) {
                        const dataStr = d.toISOString().split('T')[0];
                        
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/anexos/${dataStr}/${empresaId}`);
                            
                            if (!response.ok) {
                                continue; // Nenhum anexo nesta data
                            }
                            
                            const anexos = await response.json();
                            
                            if (Array.isArray(anexos) && anexos.length > 0) {
                                
                                
                                // ? FAZER MATCH COM FUNCION√ÅRIOS USANDO CPF + DATA (identificador √∫nico)
                                anexos.forEach(anexo => {
                                    
                                    
                                    // Normalizar data do anexo (pode vir como 2025-10-24T00:00:00.000Z ou 2025-10-24)
                                    const dataAnexo = anexo.data.split('T')[0];
                                    
                                    // ? BUSCAR FUNCION√ÅRIO POR CPF + DATA (exato, n√£o parcial!)
                                    const emp = allEmployees.find(e => {
                                        // Match CPF exato (remover pontos e tra√£os para comparar apenas n√ß√£meros)
                                        const cpfEmp = String(e.cpf || '').replace(/[.\-]/g, '').trim();
                                        const cpfAnexo = String(anexo.cpf || '').replace(/[.\-]/g, '').trim();
                                        
                                        if (cpfEmp !== cpfAnexo || !cpfEmp) return false;
                                        
                                        // Normalizar data do FUNCION√ÅRIO
                                        let dataEmp = '';
                                        if (e.rawData?.Data) {
                                            // Tentar formato estranho da API: 27T00:00:00/10/2025 -> 2025-10-27
                                            const partsStrange = e.rawData.Data.match(/(\d+)T\d{2}:\d{2}:\d{2}\/(\d+)\/(\d{4})/);
                                            if (partsStrange) {
                                                const dia = partsStrange[1].padStart(2, '0');
                                                const mes = partsStrange[2].padStart(2, '0');
                                                const ano = partsStrange[3];
                                                dataEmp = `${ano}-${mes}-${dia}`;
                                            } else {
                                                // Formato ISO normal: 2025-10-24T00:00:00
                                                dataEmp = e.rawData.Data.split('T')[0];
                                            }
                                        } else if (e.date) {
                                            dataEmp = e.date.split('T')[0];
                                        }
                                        
                                        // Match DATA exata
                                        const match = dataEmp === dataAnexo;
                                        
                                        if (match) {
                                            
                                        }
                                        
                                        return match;
                                    });
                                    
                                    if (emp) {
                                        emp.anexoId = anexo.id; // ?? ID da tabela ANEXOS
                                        emp.anexoUrl = anexo.blob_url;
                                        emp.anexoDate = dataAnexo; // ?? Guardar data do anexo
                                        emp.motivo = anexo.motivo_detectado || emp.motivo;
                                        emp.attachments = [anexo.blob_filename];
                                        
                                        
                                        
                                        // ?? CARREGAR PERGUNTAS E APROVa√ß√£ES DO RH DO BANCO DE DADOS
                                        if (anexo.perguntas_rh && anexo.perguntas_rh !== '{}') {
                                            try {
                                                const allData = JSON.parse(anexo.perguntas_rh);
                                                
                                                // Separar perguntas de aprova√ß√£es
                                                emp.questions = {};
                                                emp.approved = {};
                                                
                                                for (const [key, value] of Object.entries(allData)) {
                                                    if (key.endsWith('_approved')) {
                                                        // √£ uma aprova√ß√£o (ex: "ent1_approved")
                                                        const punchType = key.replace('_approved', '');
                                                        emp.approved[punchType] = value;
                                                    } else {
                                                        // √£ uma pergunta normal
                                                        emp.questions[key] = value;
                                                    }
                                                }
                                                
                                                const numPerguntas = Object.keys(emp.questions).length;
                                                const numAprovacoes = Object.keys(emp.approved).length;
                                                
                                                if (numPerguntas > 0) {
                                                    
                                                }
                                                if (numAprovacoes > 0) {
                                                    
                                                }
                                            } catch (err) {
                                                console.warn(`?? Erro ao parsear perguntas_rh para ${emp.name}:`, err);
                                                emp.questions = {};
                                                emp.approved = {};
                                            }
                                        } else {
                                            emp.questions = {};
                                            emp.approved = {};
                                        }
                                        
                                        // ? n√£o PREENCHER BATIDAS DO SQL!
                                        // A tabela deve mostrar APENAS dados da Secullum
                                        // Os Hor√°rios salvos no anexo S√≥o apenas backup/hist√≥rico
                                        
                                        
                                    } else {
                                        console.warn(`?? Anexo n√£o vinculado: REG ${anexo.reg} - ${dataAnexo} (FUNCION√ÅRIO n√£o encontrado)`);
                                    }
                                });
                            }
                        } catch (err) {
                            console.warn(`?? Erro ao buscar anexos de ${dataStr}:`, err.message);
                        }
                    }
                }
                
                console.log('? Carregamento de anexos conclu√ß√£do!');
                
            } catch (err) {
                console.error('? Erro ao carregar anexos:', err);
            } finally {
                loadingAnexos = false;
            }
        }

        // Carregar perguntas e aprova√ß√£es de TODOS os FUNCION√ÅRIOs (mesmo sem anexo)
        async function carregarPerguntasEAprovacoes() {
            try {
                const dataInicio = document.getElementById('dateStart').value;
                const dataFim = document.getElementById('dateEnd').value;
                
                const companies = API_CONFIG.selectedCompanies.includes('all') 
                    ? API_CONFIG.companies 
                    : API_CONFIG.companies.filter(c => API_CONFIG.selectedCompanies.includes(c.id));
                
                const empresasSelecionadas = companies.map(c => c.id);
                
                // ? ADICIONAR empresa_id = 0 (registros sem empresa espec√ß√£fica)
                if (!empresasSelecionadas.includes('0')) {
                    empresasSelecionadas.push('0');
                }
                
                console.log('?? Empresas a consultar (incluindo 0):', empresasSelecionadas);
                
                for (let empresaId of empresasSelecionadas) {
                    const inicio = new Date(dataInicio);
                    const fim = new Date(dataFim);
                    
                    for (let d = new Date(inicio); d <= fim; d.setDate(d.getDate() + 1)) {
                        const dataStr = d.toISOString().split('T')[0];
                        
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/anexos/${dataStr}/${empresaId}`, {
                                headers: getAuthHeaders()
                            });
                            
                            if (!response.ok) continue;
                            
                            const anexos = await response.json();
                            
                            if (Array.isArray(anexos) && anexos.length > 0) {
                                
                                anexos.forEach(anexo => {
                                    if (!anexo.perguntas_rh) return;
                                    
                                    // ? IGNORAR se perguntas_rh for "{}" vazio
                                    if (anexo.perguntas_rh === '{}') return;
                                    
                                    // ? MATCH APENAS POR CPF + DATA (n√£o filtrar por empresa)
                                    // Coment√©rios S√≥o do CPF, n√£o da empresa!
                                    
                                    // Buscar FUNCION√ÅRIO por CPF e DATA
                                    const cpfAnexo = (anexo.cpf || '').replace(/\D/g, '');
                                    const dataAnexo = dataStr;
                                    
                                    // DEBUG: Log de busca
                                    if (anexo.perguntas_rh && anexo.perguntas_rh !== '{}') {
                                    
                                        
                                    }
                                    
                                    const emp = allEmployees.find(e => {
                                        const cpfEmp = (e.cpf || '').replace(/\D/g, '');
                                        if (cpfEmp !== cpfAnexo || !cpfEmp) return false;
                                        
                                        let dataEmp = null;
                                        if (e.rawData?.Data) {
                                            const partsStrange = e.rawData.Data.match(/^(\d{1,2})T\d{2}:\d{2}:\d{2}\/(\d{1,2})\/(\d{4})/);
                                            if (partsStrange) {
                                                const dia = partsStrange[1].padStart(2, '0');
                                                const mes = partsStrange[2].padStart(2, '0');
                                                const ano = partsStrange[3];
                                                dataEmp = `${ano}-${mes}-${dia}`;
                                            } else {
                                                dataEmp = e.rawData.Data.split('T')[0];
                                            }
                                        } else if (e.date) {
                                            // Converter formato brasileiro DD/MM/YYYY para ISO YYYY-MM-DD
                                            const partsBR = e.date.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
                                            if (partsBR) {
                                                dataEmp = `${partsBR[3]}-${partsBR[2]}-${partsBR[1]}`;
                                            } else {
                                                dataEmp = e.date.split('T')[0];
                                            }
                                        }
                                        
                                        return dataEmp === dataAnexo;
                                    });
                                    
                                    if (emp) {
                                        try {
                                            const allData = JSON.parse(anexo.perguntas_rh);
                                            
                                            emp.questions = emp.questions || {};
                                            emp.approved = emp.approved || {};
                                            
                                            for (const [key, value] of Object.entries(allData)) {
                                                if (key.endsWith('_approved')) {
                                                    const punchType = key.replace('_approved', '');
                                                    emp.approved[punchType] = value;
                                                } else {
                                                    emp.questions[key] = value;
                                                }
                                            }
                                            
                                        } catch (err) {
                                            console.warn(`?? Erro ao parsear perguntas_rh:`, err);
                                        }
                                    } else {
                                        // DEBUG: FUNCION√ÅRIO n√£o encontrado
                                        console.warn(`?? Anexo n√£o vinculado: CPF=${cpfAnexo}, Data=${dataAnexo}, Perguntas:`, anexo.perguntas_rh);
                                    }
                                });
                            }
                        } catch (err) {
                            // Silenciar erros de dias sem dados
                        }
                    }
                }
                
                console.log('? Perguntas e aprova√ß√£es carregadas!');
            } catch (err) {
                console.error('? Erro ao carregar perguntas/aprova√ß√£es:', err);
            }
        }

        // ?? Carregar IDs de impresS√≥o (alias para carregarIdsImpressao)
        async function carregarIDs() {
            return await carregarIdsImpressao();
        }
        
        // ?? Carregar IDs de impresS√≥o de TODOS os FUNCION√ÅRIOs
        async function carregarIdsImpressao() {
            try {
                // Carregar IDs do banco de dados
                
                // Montar array com todos os registros (REG + DATA + EMPRESA_ID)
                const registros = allEmployees.map(emp => ({
                    reg: emp.reg,
                    data: emp.date,
                    empresa_id: emp.empresaId || emp.companyId || 0
                }));
                
                if (registros.length === 0) return;
                
                const response = await fetch(`${API_BASE_URL}/api/justificativa/buscar-ids`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ registros })
                });
                
                if (!response.ok) {
                    console.warn('?? Erro ao buscar IDs do banco');
                    return;
                }
                
                const { ids } = await response.json();
                
                // Atribuir IDs aos FUNCION√ÅRIOs
                allEmployees.forEach(emp => {
                    // Normalizar data
                    let dataNormalizada = emp.date;
                    if (emp.date.includes('/')) {
                        const [dia, mes, ano] = emp.date.split('/');
                        dataNormalizada = `${ano}-${mes}-${dia}`;
                    } else if (emp.date.includes('T')) {
                        dataNormalizada = emp.date.split('T')[0];
                    }
                    
                    const empresaId = emp.empresaId || emp.companyId || 0;
                    const key = `${emp.reg}_${dataNormalizada}_${empresaId}`;
                    if (ids[key]) {
                        emp.id = ids[key];
                    }
                });
                
                console.log(`? IDs carregados! ${Object.keys(ids).length} encontrado(s)`);
                
            } catch (err) {
                console.error('? Erro ao carregar IDs do banco:', err);
            }
        }

        // Desconectar da API
        function disconnectFromAPI() {
            allEmployees.length = 0;
            isAPIConnected = false;
            
            const apiStatus = document.getElementById('apiStatus');
            
            apiStatus.className = 'api-status disconnected';
            apiStatus.innerHTML = '<span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: inline-block;"></span> API Desconectada';
            
            renderTable();
        }

        // Configurar credenciais
        function configureAPI() {
            const currentBaseURL = API_CONFIG.baseURL || '';
            
            const message = '‚öôÔ∏è CONFIGURA√á√ÉO DA URL BASE DA API\n\n' +
                'üìù Digite a URL base do SmartPoint:\n\n' +
                'üí° Exemplos comuns:\n' +
                '1Ô∏è‚É£  https://api.secullum.com.br/SmartPoint\n' +
                '2Ô∏è‚É£  https://prd.secullum.com.br/SmartPoint\n' +
                '3Ô∏è‚É£  https://sistema.secullum.com.br/SmartPoint\n' +
                '4Ô∏è‚É£  https://app.secullum.com.br/SmartPoint\n' +
                '5Ô∏è‚É£  https://cliente.secullum.com.br/SmartPoint\n\n' +
                `?? URL Atual: ${currentBaseURL || '(n√£o configurada)'}\n\n` +
                '?? IMPORTANTE: n√£o inclua "/IntegracaoExterna"\n' +
                '?? Entre em contato com o suporte Secullum se n√£o souber a URL';
            
            const newBaseURL = prompt(message, currentBaseURL || 'https://');
            
            if (newBaseURL && newBaseURL.trim() && newBaseURL !== 'https://') {
                API_CONFIG.baseURL = newBaseURL.trim().replace(/\/$/, ''); // Remove barra final
                alert(`? URL Base configurada com sucesso!\n\n?? ${API_CONFIG.baseURL}\n\n?? Agora clique em "Conectar API Secullum" para testar.`);
            } else if (newBaseURL === '' || newBaseURL === 'https://') {
                alert('? Por favor, digite uma URL v√°lida!\n\n?? Dica: Entre em contato com o suporte da Secullum para obter a URL correta da sua instala√ß√£o.');
            }
        }

        // ==========================================
        // fun√ß√µes DE sele√ß√£o√£O DE EMPRESA
        // ==========================================
        function selectCompany(companyId, button) {
            if (companyId === 'all') {
                API_CONFIG.selectedCompanies = ['all'];
                document.querySelectorAll('.btn-company').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            } else {
                // Remove 'all' se existir
                if (API_CONFIG.selectedCompanies.includes('all')) {
                    API_CONFIG.selectedCompanies = [];
                    document.querySelector('.btn-company[data-company="all"]').classList.remove('active');
                }

                // Toggle empresa espec√ß√£fica
                const index = API_CONFIG.selectedCompanies.indexOf(companyId);
                if (index > -1) {
                    API_CONFIG.selectedCompanies.splice(index, 1);
                    button.classList.remove('active');
                } else {
                    API_CONFIG.selectedCompanies.push(companyId);
                    button.classList.add('active');
                }

                // Se nenhuma empresa selecionada, volta para 'all'
                if (API_CONFIG.selectedCompanies.length === 0) {
                    API_CONFIG.selectedCompanies = ['all'];
                    document.querySelector('.btn-company[data-company="all"]').classList.add('active');
                }
            }

            
        }

        function initCompanyButtons() {
            const container = document.getElementById('companyButtons');
            
            // Limpar bot√©es existentes (exceto o bot√£oo "TODAS")
            const allButton = container.querySelector('[data-company="all"]');
            container.innerHTML = '';
            if (allButton) {
                container.appendChild(allButton);
            }
            
            // Adicionar bot√µes das empresas
            API_CONFIG.companies.forEach(company => {
                const btn = document.createElement('button');
                btn.className = 'btn-company';
                btn.setAttribute('data-company', company.id);
                btn.onclick = () => selectCompany(company.id, btn);
                btn.innerHTML = `üè¢ ${company.name}`;
                btn.style.borderColor = company.color;
                btn.style.color = company.color;
                container.appendChild(btn);
            });
        }

        // Recarregar dados com as empresas selecionadas
        async function reloadData() {
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            
            if (!dateStart || !dateEnd) {
                alert('?? Por favor, selecione as datas de In√≠cio e fim!');
                return;
            }
            
            document.getElementById('apiStatus').innerHTML = '? Carregando...';
            const startTime = performance.now();
            
            const apiData = await fetchEmployeesFromAPI(dateStart, dateEnd);
            
            const endTime = performance.now();
            const timeElapsed = ((endTime - startTime) / 1000).toFixed(2);
            
            if (apiData && apiData.length > 0) {
                allEmployees.length = 0;
                allEmployees.push(...apiData);
                
                // Ordenar alfabeticamente ao carregar
                allEmployees.sort((a, b) => a.name.localeCompare(b.name));
                
                // FAZER MATCH COM SQL AZURE (buscar L√≠der e PROJETO)
                console.log('?? Buscando dados complementares do SQL Azure...');
                const cpfs = [...new Set(allEmployees.map(emp => emp.cpf).filter(cpf => cpf))];
                const sqlData = await getColaboradoresBatchCPF(cpfs);
                
                // Fazer match por CPF
                allEmployees.forEach(emp => {
                    if (emp.cpf) {
                        const cpfLimpo = emp.cpf.replace(/[^\d]/g, '');
                        const sqlColab = sqlColaboradoresCache[cpfLimpo];
                        if (sqlColab) {
                            emp.nomeLider = sqlColab.NOME_LIDER || sqlColab.Lider || null;
                            emp.projeto = sqlColab.PROJETO || sqlColab.Projeto || null;
                        } else {
                            emp.nomeLider = null;
                            emp.projeto = null;
                        }
                    }
                    
                    // Adicionar departamento Secullum como fallback para projeto
                    if (!emp.projeto && emp.rawData?.Departamento) {
                        const dept = emp.rawData.Departamento;
                        if (typeof dept === 'object' && dept.Codigo) {
                            emp.departamentoSecullum = dept.Codigo;
                        } else if (typeof dept === 'string') {
                            emp.departamentoSecullum = dept;
                        }
                    }
                });
                
                // ?? CARREGAR ANEXOS E PERGUNTAS
                try {
                    await carregarAnexos();
                } catch (err) {
                    console.error('? Erro ao carregar anexos:', err);
                }
                
                // ?? CARREGAR IDs DE IMPRESS√≥O
                try {
                    await carregarIdsImpressao();
                } catch (err) {
                    console.error('? Erro ao carregar IDs de impresS√≥o:', err);
                }
                
                renderTable();
                alert(`? ${apiData.length} registros carregados!\n?? Tempo de busca: ${timeElapsed}s`);
            } else {
                alert('?? Nenhum registro encontrado neste Per√≠odo!');
            }
            
            document.getElementById('apiStatus').innerHTML = `<span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block;"></span> API Conectada (${timeElapsed}s)`;
        }

        // ==========================================
        // RENDERIZa√ß√£O DA TABELA
        // ==========================================
        // Renderizar tabela
        function renderTable() {
            // ?? CORRE√ß√£√£O: Evitar renderiza√ß√£es simult√©neas
            if (renderingTable) {
                console.warn('? j√° est√© renderizando, ignorando chamada duplicada');
                return;
            }
            renderingTable = true;
            
            try {
                console.log('üé® [renderTable] Iniciando renderiza√ß√£o...');
                console.log(`üìä allEmployees.length: ${allEmployees.length}`);
                
                const tbody = document.getElementById('employeeTable');
                const searchName = document.getElementById('searchName')?.value.toLowerCase().trim() || '';
                const searchLider = document.getElementById('searchLider')?.value.toLowerCase().trim() || '';
                const searchProject = document.getElementById('searchProject')?.value.trim() || '';
                
                console.log(`üîç Filtros: nome="${searchName}", lider="${searchLider}", projeto="${searchProject}", inconsist√™ncias=${showOnlyInconsistencies}`);
                
                // Filtrar por Inconsist√™ncias
                let displayedEmployees = showOnlyInconsistencies 
                    ? allEmployees.filter(emp => emp.hasInconsistency)
                    : allEmployees;
                
                console.log(`‚úÖ Ap√≥s filtro de inconsist√™ncias: ${displayedEmployees.length} funcion√°rios`);
                
                // Filtrar por nome (se houver busca)
                if (searchName) {
                    displayedEmployees = displayedEmployees.filter(emp => 
                        emp.name.toLowerCase().includes(searchName)
                    );
                }
                
                // Filtrar por L√≠der (se houver busca)
                if (searchLider) {
                    displayedEmployees = displayedEmployees.filter(emp => 
                        emp.nomeLider && emp.nomeLider.toLowerCase().includes(searchLider)
                    );
                }
                
                // Filtrar por projeto (se houver busca) - busca em SQL Azure E Secullum
                if (searchProject) {
                    displayedEmployees = displayedEmployees.filter(emp => {
                        const projetoSQL = emp.projeto ? String(emp.projeto).includes(searchProject) : false;
                        const deptSecullum = emp.departamentoSecullum ? String(emp.departamentoSecullum).includes(searchProject) : false;
                        return projetoSQL || deptSecullum;
                    });
                }
                
                // ORDENAR ALFABETICAMENTE POR NOME
                displayedEmployees.sort((a, b) => a.name.localeCompare(b.name));

            tbody.innerHTML = displayedEmployees.map((emp, index) => {
                // ? COMPARAR PROJETOS: Extrair 3 primeiros n√ß√£meros
                const extrairNumeros = (str) => {
                    if (!str) return '';
                    const numeros = String(str).match(/\d+/);
                    if (numeros && numeros[0]) {
                        return numeros[0].substring(0, 3);
                    }
                    return '';
                };
                
                const projetoBDO = extrairNumeros(emp.projeto);
                const projetoSEC = extrairNumeros(emp.projetoSecullum);
                
                // Se ambos existem e S√≥o diferentes, destacar em amarelo
                const projetoDiferente = projetoBDO && projetoSEC && projetoBDO !== projetoSEC;
                const corDestaque = projetoDiferente ? 'background: #fef3c7; font-weight: 700;' : '';
                
                // VALIDAR ORDEM cronol√≥gica PARA DESTACAR c√©lulas ERRADAS
                const timeToMinutes = (time) => {
                    if (!time || time === '--:--') return -1;
                    const [h, m] = time.split(':').map(Number);
                    return h * 60 + m;
                };
                
                // fun√ß√£oo helper: retorna motivo se existir, sen√£o retorna Hor√°rio
                const getMotivoOuHorario = (horario, motivo) => {
                    const motivosEspeciais = ['FALTA', 'F√ß√£RIAS', 'AFASTAMENTO INSS', 'LICEN√ß√£A MATERNIDADE', 'FOLGA'];
                    if (motivosEspeciais.includes(motivo)) {
                        return motivo;
                    }
                    return horario || '--:--';
                };
                
                const horariosOrdenados = [
                    { col: 'ent1', hora: emp.punches.ent1 },
                    { col: 'sai1', hora: emp.punches.sai1 },
                    { col: 'ent2', hora: emp.punches.ent2 },
                    { col: 'sai2', hora: emp.punches.sai2 },
                    { col: 'ent3', hora: emp.punches.ent3 },
                    { col: 'sai3', hora: emp.punches.sai3 },
                    { col: 'ent4', hora: emp.punches.ent4 },
                    { col: 'sai4', hora: emp.punches.sai4 },
                    { col: 'ent5', hora: emp.punches.ent5 },
                    { col: 'sai5', hora: emp.punches.sai5 }
                ].filter(h => h.hora && h.hora !== '--:--');
                
                // Marcar quais colunas est√©o fora de ordem
                const colunasErradas = new Set();
                
                for (let i = 1; i < horariosOrdenados.length; i++) {
                    const anterior = timeToMinutes(horariosOrdenados[i - 1].hora);
                    const atual = timeToMinutes(horariosOrdenados[i].hora);
                    
                    if (atual <= anterior) {
                        colunasErradas.add(horariosOrdenados[i].col);
                        colunasErradas.add(horariosOrdenados[i - 1].col);
                    }
                }
                
                // fun√ß√£oo para retornar classe correta
                const getTimeClass = (punchType, value) => {
                    if (colunasErradas.has(punchType)) {
                        return 'error-time'; // VERMELHO ESCURO
                    } else if (value) {
                        return 'present'; // VERDE
                    } else if (punchType === 'ent1' || punchType === 'sai1' || punchType === 'ent2' || punchType === 'sai2') {
                        return 'missing'; // VERMELHO CLARO (obrigat√©rio)
                    } else {
                        return 'optional'; // CINZA (opcional)
                    }
                };
                
                // ? ID √∫nico: REG + DATA (para selecionar dia espec√ß√£fico, n√£o todos os dias do colaborador)
                const uniqueId = `${emp.reg}_${emp.date}`;
                
                return `
                <tr class="${emp.hasInconsistency ? 'inconsistency' : ''} ${selectedEmployees.includes(uniqueId) ? 'selected' : ''}">
                    <td style="width: 40px;">
                        <input type="checkbox" 
                               class="employee-checkbox" 
                               data-reg="${emp.reg}"
                               data-date="${emp.date}"
                               data-id="${uniqueId}"
                               ${selectedEmployees.includes(uniqueId) ? 'checked' : ''}
                               style="width: 18px; height: 18px; cursor: pointer;">
                    </td>
                    <td class="center" style="font-weight: bold; color: #6b7280; width: 50px;">
                        ${emp.id ? `#${emp.id}` : '-'}
                    </td>
                    <td style="font-family: 'Courier New', monospace; font-weight: 600; font-size: 12px; width: 80px;">
                        ${emp.reg}
                        <button onclick="refreshEmployee('${emp.reg}', '${emp.date}', ${emp.empresaId})" 
                                style="background: none; border: none; cursor: pointer; font-size: 14px; margin-left: 4px; opacity: 0.6; transition: all 0.2s;"
                                onmouseover="this.style.opacity='1'; this.style.transform='rotate(180deg)'"
                                onmouseout="this.style.opacity='0.6'; this.style.transform='rotate(0deg)'"
                                title="Atualizar este funcion√°rio">
                            üîÑ
                        </button>
                    </td>
                    <td style="font-weight: 600; font-size: 11px; min-width: 150px; max-width: 180px; color: #7c3aed;">${emp.nomeLider || '-'}</td>
                    <td style="font-weight: 600; font-size: 11px; min-width: 100px; max-width: 120px; color: #000; ${corDestaque}">${emp.projeto || '-'}</td>
                    <td style="font-weight: 600; font-size: 11px; min-width: 120px; max-width: 140px; color: #000; ${corDestaque}">${emp.projetoSecullum || '-'}</td>
                    <td style="font-weight: 600; font-size: 12px; min-width: 180px; max-width: 220px;">${emp.name}</td>
                    <td style="font-family: 'Courier New', monospace; font-size: 12px; width: 140px;">${emp.cpf ? emp.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : 'N/A'}</td>
                    <td style="font-weight: 600; font-size: 12px; min-width: 140px;">${emp.city}</td>
                    <td class="center" style="font-size: 12px; width: 100px;">${emp.date}</td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" 
                        data-reg="${emp.reg}" 
                        data-date="${emp.date}" 
                        data-punch="ent1"
                        data-name="${emp.name}"
                        onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('ent1') && !emp.approved?.ent1 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent1\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.ent1 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent1\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.ent1 ? 'approved' : getTimeClass('ent1', emp.punches.ent1)}" style="font-size: 13px; font-family: 'Courier New', monospace;">
                            ${getMotivoOuHorario(emp.punches.ent1, emp.motivo)}
                        </span>
                        ${emp.questions?.ent1 ? '<span class="has-question" title="' + emp.questions.ent1 + '">\ud83d\udcac</span>' : ''}
                        ${emp.approved?.ent1 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.ent1 + '">\u2705</span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="sai1" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('sai1') && !emp.approved?.sai1 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai1\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.sai1 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai1\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.sai1 ? 'approved' : getTimeClass('sai1', emp.punches.sai1)}">${getMotivoOuHorario(emp.punches.sai1, emp.motivo)}</span>
                        ${emp.questions?.sai1 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.sai1 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.sai1 + '"></span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="ent2" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('ent2') && !emp.approved?.ent2 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent2\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.ent2 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent2\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.ent2 ? 'approved' : getTimeClass('ent2', emp.punches.ent2)}">${getMotivoOuHorario(emp.punches.ent2, emp.motivo)}</span>
                        ${emp.questions?.ent2 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.ent2 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.ent2 + '"></span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="sai2" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('sai2') && !emp.approved?.sai2 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai2\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.sai2 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai2\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.sai2 ? 'approved' : getTimeClass('sai2', emp.punches.sai2)}">${getMotivoOuHorario(emp.punches.sai2, emp.motivo)}</span>
                        ${emp.questions?.sai2 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.sai2 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.sai2 + '"></span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="ent3" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('ent3') && !emp.approved?.ent3 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent3\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.ent3 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent3\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.ent3 ? 'approved' : getTimeClass('ent3', emp.punches.ent3)}">${getMotivoOuHorario(emp.punches.ent3, emp.motivo)}</span>
                        ${emp.questions?.ent3 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.ent3 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.ent3 + '"></span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="sai3" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('sai3') && !emp.approved?.sai3 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai3\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.sai3 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai3\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.sai3 ? 'approved' : getTimeClass('sai3', emp.punches.sai3)}">${getMotivoOuHorario(emp.punches.sai3, emp.motivo)}</span>
                        ${emp.questions?.sai3 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.sai3 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.sai3 + '"></span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="ent4" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('ent4') && !emp.approved?.ent4 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent4\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.ent4 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent4\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.ent4 ? 'approved' : getTimeClass('ent4', emp.punches.ent4)}">${getMotivoOuHorario(emp.punches.ent4, emp.motivo)}</span>
                        ${emp.questions?.ent4 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.ent4 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.ent4 + '"></span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="sai4" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('sai4') && !emp.approved?.sai4 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai4\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.sai4 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai4\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.sai4 ? 'approved' : getTimeClass('sai4', emp.punches.sai4)}">${getMotivoOuHorario(emp.punches.sai4, emp.motivo)}</span>
                        ${emp.questions?.sai4 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.sai4 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.sai4 + '"></span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="ent5" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('ent5') && !emp.approved?.ent5 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent5\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.ent5 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'ent5\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.ent5 ? 'approved' : getTimeClass('ent5', emp.punches.ent5)}">${getMotivoOuHorario(emp.punches.ent5, emp.motivo)}</span>
                        ${emp.questions?.ent5 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.ent5 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.ent5 + '"></span>' : ''}
                    </td>
                    <td class="center punch-cell" style="width: 100px; position: relative; cursor: pointer;" data-reg="${emp.reg}" data-date="${emp.date}" data-punch="sai5" data-name="${emp.name}" onclick="showSwapMenu(event, this)">
                        ${colunasErradas.has('sai5') && !emp.approved?.sai5 ? '<span class="approve-icon" onclick="approveSwappedTime(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai5\', \'' + emp.name + '\')" title="Aprovar Hor√°rio trocado"></span>' : ''}
                        ${emp.punches.sai5 ? '<span class="question-icon" onclick="askQuestion(event, \'' + emp.reg + '\', \'' + emp.date + '\', \'sai5\', \'' + emp.name + '\')" title="Adicionar pergunta"></span>' : ''}
                        <span class="punch-time ${emp.approved?.sai5 ? 'approved' : getTimeClass('sai5', emp.punches.sai5)}">${getMotivoOuHorario(emp.punches.sai5, emp.motivo)}</span>
                        ${emp.questions?.sai5 ? '<span class="has-question" title="$1"></span>' : ''}
                        ${emp.approved?.sai5 ? '<span class="approved-badge" title="Aprovado por RH: ' + emp.approved.sai5 + '"></span>' : ''}
                    </td>
                    <td class="center" style="width: 70px; font-weight: bold; color: #7c3aed; font-size: 14px;">
                        ${emp.anexoId ? `#${emp.anexoId}` : '-'}
                    </td>
                    <td style="font-size: 12px; min-width: 150px; max-width: 200px;">
                        ${emp.motivo || '-'}
                    </td>
                    <td class="center" style="width: 100px;">
                        ${emp.anexoUrl ? `
                            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                                <a href="${emp.anexoUrl}" target="_blank" style="font-size: 11px; color: #3b82f6; text-decoration: none; font-weight: 600;">
                                    ?? Ver imagem
                                </a>
                                <button class="upload-btn" style="font-size: 10px; padding: 2px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="handleFileUpload(event, '${emp.reg}', '${emp.date}')">
                                    ?? Substituir
                                </button>
                            </div>
                        ` : `
                            <button class="upload-btn" style="font-size: 11px; padding: 5px 10px;" onclick="handleFileUpload(event, '${emp.reg}', '${emp.date}')">
                                ?? Anexar
                            </button>
                        `}
                    </td>
                    <td class="center" style="width: 90px;">
                        <span class="status-badge ${emp.hasInconsistency ? 'error' : 'ok'}" style="font-size: 11px; padding: 5px 10px;">
                            ${emp.hasInconsistency ? 'INCONS.' : 'OK'}
                        </span>
                    </td>
                </tr>
                `;
            }).join('');

            // ?? CORRE√ß√£√£O: Restaurar checkboxes selecionados
            displayedEmployees.forEach(emp => {
                const uniqueId = `${emp.reg}_${emp.date}`;
                if (selectedEmployees.includes(uniqueId)) {
                    const checkbox = tbody.querySelector(`.employee-checkbox[data-id="${uniqueId}"]`);
                    const row = checkbox?.closest('tr');
                    if (checkbox) checkbox.checked = true;
                    if (row) row.classList.add('selected');
                }
            });

            // TAREFA 7: Configurar drag-and-drop ap√≥s renderizar tabela
            setupDragAndDrop();
            
            } finally {
                renderingTable = false;
            }
        }

        // Simular OCR - Extrair Hor√°rios e justificativa da imagem
        function simulateOCR(fileName) {
            // Simula√ß√£o de extra√ß√£o de dados
            const possibleTimes = ['07:30', '11:30', '12:30', '17:30', '18:00', '19:00'];
            const possibleReasons = [
                'Esquecimento do cart√©o',
                'm√©quina do ponto quebrada',
                'Atendimento emergencial',
                'Reuni√£o externa',
                'Visita ao cliente',
                'Problema no sistema'
            ];
            
            // Simula que extraiu um Hor√°rio aleat√©rio e uma justificativa
            const extractedTime = possibleTimes[Math.floor(Math.random() * possibleTimes.length)];
            const extractedReason = possibleReasons[Math.floor(Math.random() * possibleReasons.length)];
            
            return {
                time: extractedTime,
                reason: extractedReason
            };
        }

        // Upload de arquivo
        // ==========================================
        // SISTEMA DE ANEXOS (CTRL+V + OCR + Azure Blob)
        // ==========================================
        
        let currentAnexoEmployee = null;
        let currentAnexoImage = null;
        let currentOCRData = null;
        
        // Abrir modal de anexo
        function handleFileUpload(event, reg, date) {
            
            
            // Normalizar data para compara√ß√£o (pode vir 2025-10-25 ou 25/10/2025)
            let dataComparacao = date;
            if (date.includes('/')) {
                // Converter DD/MM/YYYY ? YYYY-MM-DD
                const [dia, mes, ano] = date.split('/');
                dataComparacao = `${ano}-${mes}-${dia}`;
            }
            
            // Buscar FUNCION√ÅRIO por REG E DATA
            const employee = allEmployees.find(emp => {
                // Normalizar data do employee tamb√©m
                let empData = emp.date;
                if (emp.rawData?.Data) {
                    empData = emp.rawData.Data.split('T')[0]; // 2025-10-25T00:00:00 ? 2025-10-25
                }
                
                const match = emp.reg === reg && empData === dataComparacao;
                if (match) {
                    
                }
                return match;
            });
            
            if (!employee) {
                console.error(`? FUNCION√ÅRIO n√£o encontrado: REG=${reg}, Data=${dataComparacao}`);
                alert('Erro: FUNCION√ÅRIO n√£o encontrado!');
                return;
            }
            
            abrirModalAnexo(employee);
        }
        
        async function abrirModalAnexo(employee) {
            currentAnexoEmployee = employee;
            currentAnexoImage = null;
            currentOCRData = null;
            
            
            
            document.getElementById('modalAnexoInfo').textContent = `REG: ${employee.reg} | ${employee.name} | Data: ${employee.date}`;
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('ocrStatus').style.display = 'none';
            document.getElementById('ocrResult').style.display = 'none';
            document.getElementById('btnConfirmarAnexo').style.display = 'none';
            
            // VERIFICAR SE j√° EXISTE ANEXO (S√≥ para avisar Usu√°rio)
            let anexoExistenteId = null;
            try {
                const dataFormatada = employee.rawData?.Data?.split('T')[0] || employee.date;
                const empresaId = employee.empresaId || employee.companyId;
                
                const response = await fetch(`${API_BASE_URL}/api/anexos/${dataFormatada}/${employee.reg}`, {
                    headers: getAuthHeaders()
                });
                
                // Se retornou 404, n√£o existe anexo (normal)
                if (response.status === 404) {
                    
                } else if (response.ok) {
                    const anexo = await response.json();
                    
                    if (anexo && anexo.blob_url) {
                        // j√° EXISTE ANEXO - Perguntar o que fazer
                        const confirmacao = confirm(
                            `?? j√° EXISTE UM ANEXO PARA ESTE FUNCION√ÅRIO NESTA DATA!\n\n` +
                            `?? REG: ${employee.reg}\n` +
                            `?? Nome: ${employee.name}\n` +
                            `?? Data: ${dataFormatada}\n` +
                            `?? Motivo salvo: ${anexo.motivo_detectado || '(n√£o informado)'}\n\n` +
                            `Deseja SUBSTITUIR o anexo existente?\n\n` +
                            `? OK = Substituir anexo\n` +
                            `? Cancelar = Ver anexo atual`
                        );
                        
                        if (!confirmacao) {
                            // Usu√°rio quer VER o anexo atual
                            window.open(anexo.blob_url, '_blank');
                            return;
                        }
                        
                        
                    }
                } else {
                    console.warn(`?? Erro ao verificar anexo existente: ${response.status}`);
                }
            } catch (err) {
                console.warn('?? Erro ao verificar anexo:', err.message);
            }
            
            document.getElementById('modalAnexo').style.display = 'flex';
            
            // Ativar √°rea de drop
            setupDropZone();
        }
        
        function fecharModalAnexo() {
            document.getElementById('modalAnexo').style.display = 'none';
            currentAnexoEmployee = null;
            currentAnexoImage = null;
            currentOCRData = null;
        }
        
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            // Click para selecionar arquivo
            dropZone.onclick = () => fileInput.click();
            
            // Arquivo selecionado
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) processarImagem(file);
            };
            
            // CTRL+V (Colar)
            document.addEventListener('paste', handlePaste);
            
            // Drag & Drop
            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            };
            
            dropZone.ondragleave = () => {
                dropZone.classList.remove('dragover');
            };
            
            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processarImagem(file);
                }
            };
        }
        
        // CTRL+V - Colar imagem
        function handlePaste(e) {
            // S√≥ processar se modal estiver aberto
            if (document.getElementById('modalAnexo').style.display !== 'flex') return;
            
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    processarImagem(blob);
                    break;
                }
            }
        }
        
        // PR√ß√£-PROCESSAMENTO DE IMAGEM para melhorar OCR (VERS√≥O OTIMIZADA)
        async function preprocessarImagem(file) {
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Escala 4x para melhor resolu√ß√£√£o
                        const scale = 4;
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        
                        ctx.imageSmoothingEnabled = false;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        // ConverS√≥o para escala de cinza + contraste extremo
                        for (let i = 0; i < data.length; i += 4) {
                            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                            const contrast = 4.0; // Aumentado de 3.5 para 4.0
                            let adjusted = ((gray - 128) * contrast) + 128;
                            adjusted = Math.max(0, Math.min(255, adjusted));
                            
                            // Binariza√ß√£o com threshold 140 (reduzido para pegar manuscrito)
                            const binary = adjusted > 140 ? 255 : 0;
                            data[i] = data[i + 1] = data[i + 2] = binary;
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        
                        console.log(`?? Pr√ß√£-processamento: escala ${scale}x, contraste 4.0, threshold 140`);
                        
                        canvas.toBlob((blob) => resolve(blob), 'image/png');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        // ==========================================
        // AZURE COMPUTER VISION API - OCR Manuscrito
        // ==========================================
        
        // Cache da chave Azure Vision
        let azureVisionConfig = null;
        
        async function getAzureVisionConfig() {
            if (azureVisionConfig) return azureVisionConfig;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/azure-vision-config`);
                if (response.ok) {
                    azureVisionConfig = await response.json();
                    return azureVisionConfig;
                }
            } catch (err) {
                console.warn('?? n√£o foi posS√≥vel obter config Azure Vision do servidor');
            }
            
            // Fallback: valores vazios (vai falhar mas n√£o exp√©e credenciais)
            return { apiKey: '', endpoint: 'https://testedeocr123.cognitiveservices.azure.com/' };
        }
        
        async function extrairDadosComGoogleVision(imageBase64) {
            const config = await getAzureVisionConfig();
            const API_KEY = config.apiKey;
            const ENDPOINT = config.endpoint;
            
            if (!API_KEY) {
                throw new Error('Chave Azure Vision n√£o configurada no servidor');
            }
            
            
            
            try {
                // ?? REDIMENSIONAR imagem se muito grande
                let base64Content = imageBase64.split(',')[1];
                
                // Verificar tamanho
                const tamanhoMB = (base64Content.length * 3 / 4) / (1024 * 1024);
                
                if (tamanhoMB > 4) {
                    console.log('?? Imagem muito grande, redimensionando...');
                    
                    const img = await new Promise((resolve, reject) => {
                        const image = new Image();
                        image.onload = () => resolve(image);
                        image.onerror = reject;
                        image.src = imageBase64;
                    });
                    
                    const maxSize = 1500;
                    let newWidth = img.width;
                    let newHeight = img.height;
                    
                    if (img.width > maxSize || img.height > maxSize) {
                        if (img.width > img.height) {
                            newWidth = maxSize;
                            newHeight = (img.height * maxSize) / img.width;
                        } else {
                            newHeight = maxSize;
                            newWidth = (img.width * maxSize) / img.height;
                        }
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    imageBase64 = canvas.toDataURL('image/jpeg', 0.85);
                    base64Content = imageBase64.split(',')[1];
                    
                    const novoTamanho = (base64Content.length * 3 / 4) / (1024 * 1024);
                    console.log(`? Imagem redimensionada: ${novoTamanho.toFixed(2)} MB (${newWidth}x${newHeight})`);
                }
                
                // Converter base64 para blob bin√ß√£rio
                const byteCharacters = atob(base64Content);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/octet-stream' });
                
                // Azure Computer Vision - Read API (OCR para manuscrito)
                const analyzeUrl = `${ENDPOINT}vision/v3.2/read/analyze?language=pt`;
                
                
                
                const response = await fetch(analyzeUrl, {
                    method: 'POST',
                    headers: {
                        'Ocp-Apim-Subscription-Key': API_KEY,
                        'Content-Type': 'application/octet-stream'
                    },
                    body: blob
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('? Resposta da API:', errorText);
                    throw new Error(`Azure Vision API error: ${response.status} - ${errorText}`);
                }
                
                // Azure retorna URL para buscar o resultado
                const operationLocation = response.headers.get('Operation-Location');
                
                
                // Poll at√© resultado estar pronto
                let result;
                let attempts = 0;
                const maxAttempts = 10;
                
                while (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Esperar 1 segundo
                    
                    const resultResponse = await fetch(operationLocation, {
                        headers: {
                            'Ocp-Apim-Subscription-Key': API_KEY
                        }
                    });
                    
                    result = await resultResponse.json();
                    
                    
                    
                    if (result.status === 'succeeded') {
                        console.log('? OCR conclu√ß√£do pelo Azure Computer Vision!');
                        break;
                    } else if (result.status === 'failed') {
                        console.error('? Azure OCR falhou:', result);
                        throw new Error('Azure OCR falhou');
                    }
                    
                    attempts++;
                }
                
                if (result.status !== 'succeeded') {
                    throw new Error('Timeout ao processar OCR');
                }
                
                // Extrair texto de todas as linhas
                const analyzeResult = result.analyzeResult;
                let fullText = '';
                
                if (analyzeResult && analyzeResult.readResults) {
                    console.log(`?? Azure retornou ${analyzeResult.readResults.length} p√°gina(s)`);
                    for (const page of analyzeResult.readResults) {
                        
                        for (const line of page.lines) {
                            fullText += line.text + '\n';
                        }
                    }
                } else {
                    console.warn('?? analyzeResult est√© vazio ou n√£o tem readResults');
                }
                
                console.log('??????????????????????????????????');
                console.log('?? TEXTO COMPLETO DETECTADO PELO AZURE:');
                console.log('??????????????????????????????????');
                console.log(fullText);
                console.log('??????????????????????????????????');
                console.log(`?? Total de caracteres: ${fullText.length}`);
                
                // ? DETECTAR CHECKBOX MARCADO PELO TEXTO DO AZURE (antes da an√ß√£lise de pixels)
                let motivoDetectado = 'Esqueceu de registrar o Ponto'; // Default
                let motivoDetectadoPorTexto = false;
                
                
                
                const motivosPossiveis = [
                    'Esqueceu de registrar o Ponto',
                    'Falha no App',
                    'Falta',
                    'Folga',
                    'Hora Parada',
                    'Maquina Ponto com defeito',
                    'Registro em duplicidade',
                    'Registro indevido'
                ];
                
                // ?? NOVA ESTRat√©GIA: Bolinha marcada √£ a que n√£o tem "O" antes do texto
                // Azure l√© "O Motivo" para bolinhas vazias, e apenas "Motivo" para marcada
                const linhasTexto = fullText.split('\n');
                const motivosSemBolinha = [];
                
                for (const motivo of motivosPossiveis) {
                    // Procurar se existe linha com "O Motivo" (bolinha vazia)
                    const temBolinhaVazia = linhasTexto.some(linha => {
                        const linhaNormalizada = linha.trim().toLowerCase();
                        const motivoNormalizado = motivo.toLowerCase();
                        // Verifica se linha √£ exatamente "O Motivo" ou "o Motivo"
                        return linhaNormalizada === `o ${motivoNormalizado}` || 
                               linhaNormalizada.startsWith(`o ${motivoNormalizado}`);
                    });
                    
                    if (!temBolinhaVazia) {
                        // Este motivo n√£o tem "O" antes = bolinha est√© MARCADA
                        const existeTexto = linhasTexto.some(linha => {
                            const linhaNormalizada = linha.trim().toLowerCase();
                            const motivoNormalizado = motivo.toLowerCase();
                            return linhaNormalizada === motivoNormalizado || 
                                   linhaNormalizada.includes(motivoNormalizado);
                        });
                        
                        if (existeTexto) {
                            motivosSemBolinha.push(motivo);
                            
                        }
                    } else {
                        console.log(`   ? "${motivo}" tem "O" antes ? vazio`);
                    }
                }
                
                if (motivosSemBolinha.length === 1) {
                    motivoDetectado = motivosSemBolinha[0];
                    motivoDetectadoPorTexto = true;
                    console.log(`   ?? DETECTADO: ${motivoDetectado}`);
                } else if (motivosSemBolinha.length > 1) {
                    console.log(`   ?? m√©ltiplos motivos sem "O": ${motivosSemBolinha.join(', ')}`);
                    motivoDetectado = motivosSemBolinha[0]; // Pega o primeiro
                    motivoDetectadoPorTexto = true;
                } else {
                    console.log('   ?? Nenhum motivo sem "O" detectado, usando an√ß√£lise visual...');
                }
                
                // ?? ESTRat√©GIA FINAL: DETECTAR Hor√°rioS Ap√©S "BATIDO"
                // Layout do formul√©rio:
                // - Hor√°rios preenchidos aparecem primeiro (07:05, 12:40, 07:05)
                // - Depois aparecem as palavras "BATIDO BATIDO BATIDO"
                // - Depois aparecem Hor√°rios manuscritos (17:25)
                // - Depois aparece "ANULAR BATIDA ANULAR BATIDA"
                
                const horarios = [];
                const linhas = fullText.split('\n');
                let dentroSecaoHorarios = false;
                let encontrouBatido = false; // Nova flag
                
                
                
                // ? PRIMEIRA PASSADA: Contar quantos "BATIDO" existem
                let contadorBatido = 0;
                let dentroSecaoTemp = false;
                for (let i = 0; i < linhas.length; i++) {
                    const linha = linhas[i].trim();
                    if (linha.includes('Hor√°rioS') || linha.includes('preencher somente')) {
                        dentroSecaoTemp = true;
                    }
                    if (linha.includes('JUSTIFICATIVA')) {
                        dentroSecaoTemp = false;
                        break;
                    }
                    if (dentroSecaoTemp && linha === 'BATIDO') {
                        contadorBatido++;
                    }
                }
                
                
                // ? SEGUNDA PASSADA: Ler Hor√°rios e pular os primeiros N (que S√≥o batidos)
                let horariosEncontrados = [];
                
                for (let i = 0; i < linhas.length; i++) {
                    const linha = linhas[i].trim();
                    
                    // Detectar In√≠cio da se√ß√£√£o de Hor√°rios
                    if (linha.includes('Hor√°rioS') || linha.includes('preencher somente')) {
                        dentroSecaoHorarios = true;
                        console.log(`   ? Linha ${i}: In√≠cio da se√ß√£√£o de Hor√°rios`);
                        continue;
                    }
                    
                    // Detectar fim da se√ß√£√£o (JUSTIFICATIVA ou Assinatura)
                    if (linha.includes('JUSTIFICATIVA') || linha.includes('Assinatura')) {
                        if (dentroSecaoHorarios) {
                            console.log(`   ?? Linha ${i}: Fim da se√ß√£√£o (${linha.substring(0, 30)}...)`);
                            break;
                        }
                    }
                    
                    // Se estamos na se√ß√£√£o de Hor√°rios
                    if (dentroSecaoHorarios) {
                        // Ignorar linhas com palavras-chave de layout
                        if (linha === 'Hor√°rio' || linha === 'BATIDO' || linha.includes('ANULAR')) {
                            console.log(`   ?? Linha ${i}: Ignorado (palavra-chave): ${linha}`);
                            continue;
                        }
                        
                        // ? NORMALIZAR Hor√°rio: aceitar "07: 50", "11,20", "12:30"
                        const linhaNormalizada = linha.replace(/\s+/g, '').replace(',', ':');
                        const matchHorario = linhaNormalizada.match(/^(\d{1,2}):(\d{2})$/);
                        
                        if (matchHorario) {
                            const h = parseInt(matchHorario[1]);
                            const m = parseInt(matchHorario[2]);
                            
                            // Validar se √£ Hor√°rio v√°lido
                            if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
                                const horario = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                                horariosEncontrados.push({ horario, linhaOriginal: linha, indice: i });
                            }
                        }
                    }
                }
                
                // ? REGRA: Os primeiros N Hor√°rios S√≥o BATIDOS, os demais S√≥o MANUSCRITOS
                horariosEncontrados.forEach((item, idx) => {
                    if (idx < contadorBatido) {
                        console.log(`   ? Linha ${item.indice}: Hor√°rio IGNORADO (j√° batido): ${item.horario}`);
                    } else {
                        if (!horarios.includes(item.horario)) {
                            horarios.push(item.horario);
                            console.log(`   ?? Linha ${item.indice}: Hor√°rio MANUSCRITO: ${item.horario} (original: "${item.linhaOriginal}")`);
                        }
                    }
                });
                
                
                
                // EXTRAIR MOTIVO COM DETEC√ß√£√£O VISUAL DO CHECKBOX MARCADO
                // ?? Se n√£o foi detectado pelo texto, usar an√ß√£lise de pixels
                
                try {
                    // S√≥ fazer an√ß√£lise visual se n√£o detectou pelo texto
                    if (!motivoDetectadoPorTexto) {
                        console.log(`?? Criando canvas para an√ß√£lise de checkbox...`);
                    
                        // Criar canvas da imagem para an√ß√£lise de pixels
                        const canvas = document.createElement('canvas');
                        const img = new Image();
                        img.src = imageBase64; // ? USAR O PAR√ß√£METRO DA fun√ß√£oO
                        
                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                
                                resolve();
                            };
                            img.onerror = (err) => {
                                console.error(`? Erro ao carregar imagem:`, err);
                                reject(err);
                            };
                        });
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        
                        
                        // Detectar checkbox marcado visualmente (X preto)
                        const motivo = detectarCheckboxMarcado(canvas);
                        if (motivo) {
                            motivoDetectado = motivo;
                            console.log(`?? Motivo detectado VISUALMENTE: ${motivoDetectado}`);
                        } else {
                            console.log(`?? Motivo (padr√£o, nenhum X detectado): ${motivoDetectado}`);
                        }
                    } else {
                        console.log(`?? Motivo detectado pelo TEXTO do Azure: ${motivoDetectado}`);
                    }
                } catch (err) {
                    console.warn(`?? Erro ao detectar checkbox visual, usando padr√£o:`, err);
                    console.log(`?? Motivo (padr√£o): ${motivoDetectado}`);
                }
                
                // EXTRAIR ID
                let idDetectado = null;
                const idMatch = fullText.match(/ID\s*IMP\s*:\s*(\d{1,3})/i);
                if (idMatch) {
                    idDetectado = idMatch[1];
                    console.log(`?? ID detectado: #${idDetectado}`);
                }
                
                // ?? DETECTAR ASSINATURAS (FUNCION√ÅRIO E L√≠der)
                let assinaturaFuncionarioDetectada = false;
                let assinaturaLiderDetectada = false;
                try {
                    const canvas = document.createElement('canvas');
                    const img = new Image();
                    img.src = imageBase64;
                    
                    await new Promise((resolve, reject) => {
                        img.onload = () => resolve();
                        img.onerror = reject;
                    });
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // Detectar ambas as assinaturas e mostrar debug
                    const resultados = detectarAssinaturas(canvas);
                    assinaturaFuncionarioDetectada = resultados.funcionario;
                    assinaturaLiderDetectada = resultados.lider;
                    
                    console.log('??????????????????????????????????');
                    console.log('?? RESULTADO DETEC√ß√£√£O DE ASSINATURAS');
                    console.log('??????????????????????????????????');
                    console.log(`?? FUNCION√ÅRIO: ${assinaturaFuncionarioDetectada ? '? ASSINADO' : '? n√£o ASSINADO'}`);
                console.log(`?? L√≠der: ${assinaturaLiderDetectada ? '? ASSINADO' : '? n√£o ASSINADO'}`);
                console.log('??????????????????????????????????');
                } catch (err) {
                    console.warn('?? Erro ao detectar assinaturas:', err);
                }
                
                // TAREFA 3: INTELIG√äNCIA NA ORDEM DOS HOR√ÅRIOS
                // Detectar os Hor√°rios j√° BATIDOS no Secullum e preencher slots de forma inteligente
                // Se falta ent1 mas tem ent2 (por ex: falta, folga), deixar ent1 vazio e preencher ent2
                const horariosOrdenados = organizarHorariosPDF(horarios, currentAnexoEmployee);
                
                return {
                    id: idDetectado,
                    assinaturaFuncionario: assinaturaFuncionarioDetectada,
                    assinaturaLider: assinaturaLiderDetectada,
                    ent1: horariosOrdenados.ent1 || null,
                    sai1: horariosOrdenados.sai1 || null,
                    ent2: horariosOrdenados.ent2 || null,
                    sai2: horariosOrdenados.sai2 || null,
                    ent3: horariosOrdenados.ent3 || null,
                    sai3: horariosOrdenados.sai3 || null,
                    ent4: horariosOrdenados.ent4 || null,
                    sai4: horariosOrdenados.sai4 || null,
                    ent5: horariosOrdenados.ent5 || null,
                    sai5: horariosOrdenados.sai5 || null,
                    motivo: motivoDetectado,
                    confidence: {
                        ent1: horariosOrdenados.ent1 ? 95 : 0,
                        sai1: horariosOrdenados.sai1 ? 95 : 0,
                        ent2: horariosOrdenados.ent2 ? 95 : 0,
                        sai2: horariosOrdenados.sai2 ? 95 : 0,
                        ent3: horariosOrdenados.ent3 ? 95 : 0,
                        sai3: horariosOrdenados.sai3 ? 95 : 0,
                        ent4: horariosOrdenados.ent4 ? 95 : 0,
                        sai4: horariosOrdenados.sai4 ? 95 : 0,
                        ent5: horariosOrdenados.ent5 ? 95 : 0,
                        sai5: horariosOrdenados.sai5 ? 95 : 0,
                        motivo: motivoDetectado ? 90 : 0
                    },
                    fullText: fullText
                };
                
            } catch (error) {
                console.error('? Erro Azure Vision API:', error);
                throw error;
            }
        }

        // TAREFA 3: Organizar hor√°rios do PDF de forma inteligente
        // Comparar com hor√°rios j√° batidos para preencher os slots corretos
        function organizarHorariosPDF(horariosOCR, employee) {
            console.log('üìã TAREFA 3: Organizando hor√°rios do PDF...');
            console.log('   Hor√°rios OCR extra√≠dos:', horariosOCR);
            
            if (!employee || !employee.punches) {
                console.log('   ‚ö†Ô∏è Sem dados do funcion√°rio, usando ordem sequencial');
                return {
                    ent1: horariosOCR[0] || null,
                    sai1: horariosOCR[1] || null,
                    ent2: horariosOCR[2] || null,
                    sai2: horariosOCR[3] || null,
                    ent3: horariosOCR[4] || null,
                    sai3: horariosOCR[5] || null,
                    ent4: horariosOCR[6] || null,
                    sai4: horariosOCR[7] || null,
                    ent5: horariosOCR[8] || null,
                    sai5: horariosOCR[9] || null
                };
            }

            // Pegar hor√°rios j√° batidos no Secullum
            const batidosSecullum = [
                { slot: 'ent1', horario: employee.punches.ent1 },
                { slot: 'sai1', horario: employee.punches.sai1 },
                { slot: 'ent2', horario: employee.punches.ent2 },
                { slot: 'sai2', horario: employee.punches.sai2 },
                { slot: 'ent3', horario: employee.punches.ent3 },
                { slot: 'sai3', horario: employee.punches.sai3 },
                { slot: 'ent4', horario: employee.punches.ent4 },
                { slot: 'sai4', horario: employee.punches.sai4 },
                { slot: 'ent5', horario: employee.punches.ent5 },
                { slot: 'sai5', horario: employee.punches.sai5 }
            ];

            console.log('   Hor√°rios j√° batidos no Secullum:');
            batidosSecullum.forEach(b => {
                if (b.horario && b.horario !== '--:--') {
                    console.log(`   ‚úÖ ${b.slot}: ${b.horario}`);
                }
            });

            // ESTRAT√âGIA: 
            // 1. Identificar quais slots est√£o vazios no Secullum
            // 2. Preencher apenas os slots vazios com os hor√°rios do OCR
            // 3. Manter ordem cronol√≥gica (mais cedo primeiro)
            
            const slotsVazios = batidosSecullum
                .filter(b => !b.horario || b.horario === '--:--')
                .map(b => b.slot);

            console.log('   Slots vazios para preencher:', slotsVazios);

            // Se n√£o h√° slots vazios, retornar os hor√°rios batidos
            if (slotsVazios.length === 0) {
                console.log('   ‚ö†Ô∏è Todos os slots j√° preenchidos, mantendo hor√°rios batidos');
                return {
                    ent1: employee.punches.ent1,
                    sai1: employee.punches.sai1,
                    ent2: employee.punches.ent2,
                    sai2: employee.punches.sai2,
                    ent3: employee.punches.ent3,
                    sai3: employee.punches.sai3,
                    ent4: employee.punches.ent4,
                    sai4: employee.punches.sai4,
                    ent5: employee.punches.ent5,
                    sai5: employee.punches.sai5
                };
            }

            // Ordenar hor√°rios do OCR cronologicamente
            const horariosOrdenados = [...horariosOCR].sort((a, b) => {
                const [ha, ma] = a.split(':').map(Number);
                const [hb, mb] = b.split(':').map(Number);
                return (ha * 60 + ma) - (hb * 60 + mb);
            });

            console.log('   Hor√°rios OCR ordenados:', horariosOrdenados);

            // Preencher resultado: manter batidos + adicionar OCR nos slots vazios
            const resultado = {
                ent1: employee.punches.ent1 || null,
                sai1: employee.punches.sai1 || null,
                ent2: employee.punches.ent2 || null,
                sai2: employee.punches.sai2 || null,
                ent3: employee.punches.ent3 || null,
                sai3: employee.punches.sai3 || null,
                ent4: employee.punches.ent4 || null,
                sai4: employee.punches.sai4 || null,
                ent5: employee.punches.ent5 || null,
                sai5: employee.punches.sai5 || null
            };

            // Preencher slots vazios com hor√°rios do OCR
            let indiceOCR = 0;
            for (const slot of slotsVazios) {
                if (indiceOCR < horariosOrdenados.length) {
                    resultado[slot] = horariosOrdenados[indiceOCR];
                    console.log(`   üìù Preenchendo ${slot} com ${horariosOrdenados[indiceOCR]}`);
                    indiceOCR++;
                }
            }

            console.log('   ‚úÖ Resultado final:', resultado);
            return resultado;
        }        // ?? BUSCA DIN√ß√£MICA: Detecta TODAS as batidas (n√£o S√≥ 4 fixas)
        function detectarCaixasAmarelas(canvas) {
            
            
            // ?? GRID AUTOm√©TICO: Detecta quantas colunas e linhas existem
            // Baseado na imagem: primeira linha Y√ß√£300, segunda linha Y√ß√£380, etc
            const regioes = [];
            
            const larguraCampo = 170;
            const alturaCampo = 75;
            const espacamentoX = 200; // Espa√£o entre colunas
            const espacamentoY = 95;  // Espa√£o entre linhas
            
            const inicioX = 160;
            const inicioY = 300; // Come√ß√£a mais alto para pegar primeira linha
            
            const maxColunas = 5; // m√°ximo 5 por linha (como na imagem 1)
            const maxLinhas = 3;  // m√°ximo 3 linhas (cobre at√© 15 batidas)
            
            let indice = 1;
            
            for (let linha = 0; linha < maxLinhas; linha++) {
                for (let coluna = 0; coluna < maxColunas; coluna++) {
                    const x = inicioX + (coluna * espacamentoX);
                    const y = inicioY + (linha * espacamentoY);
                    
                    regioes.push({
                        x: x,
                        y: y,
                        w: larguraCampo,
                        h: alturaCampo,
                        nome: `Batida ${indice}`,
                        linha: linha + 1,
                        coluna: coluna + 1
                    });
                    
                    indice++;
                }
            }
            
            
            
            // ?? DEBUG VISUAL: Desenhar ret√©ngulos nas regi√ß√£es buscadas
            const debugCanvas = document.createElement('canvas');
            const debugCtx = debugCanvas.getContext('2d');
            debugCanvas.width = canvas.width;
            debugCanvas.height = canvas.height;
            debugCtx.drawImage(canvas, 0, 0);
            
            // Desenhar TODAS as regi√ß√£es em azul (busca direta, sem detec√ß√£√£o de cor)
            for (const regiao of regioes) {
                debugCtx.strokeStyle = 'blue';
                debugCtx.lineWidth = 3;
                debugCtx.strokeRect(regiao.x, regiao.y, regiao.w, regiao.h);
                
                // Label
                debugCtx.fillStyle = 'blue';
                debugCtx.font = 'bold 16px Arial';
                debugCtx.fillText(regiao.nome, regiao.x + 5, regiao.y - 5);
            }
            
            // Abrir janela com debug
            try {
                const debugUrl = debugCanvas.toDataURL();
                const debugWindow = window.open('', '_blank', 'width=1200,height=800');
                if (debugWindow) {
                    debugWindow.document.write(`
                        <html>
                        <head><title>Debug - Regi√ß√£es de Busca</title></head>
                        <body style="margin:0;background:#000;display:flex;justify-content:center;align-items:center;">
                            <div style="text-align:center;">
                                <h2 style="color:white;">?? Regi√ß√£es de Busca Fixas</h2>
                                <p style="color:cyan;">√£ AZUL = Busca OCR direta (sem detec√ß√£√£o de cor)</p>
                                <img src="${debugUrl}" style="border:2px solid white;max-width:100%;"/>
                                <p style="color:yellow;">Y atual: 460 | Ajuste se necesS√≥rio!</p>
                            </div>
                        </body>
                        </html>
                    `);
                }
            } catch (e) {
                console.warn('?? n√£o foi posS√≥vel abrir janela de debug');
            }
            
            return regioes; // Retorna TODAS as regi√ß√£es (busca direta)
        }
        
        // OCR em regi√£o espec√ß√£fica (crop)
        async function ocrRegion(canvas, region) {
            const cropCanvas = document.createElement('canvas');
            const ctx = cropCanvas.getContext('2d');
            
            cropCanvas.width = region.w;
            cropCanvas.height = region.h;
            
            ctx.drawImage(canvas, 
                region.x, region.y, region.w, region.h,
                0, 0, region.w, region.h
            );
            
            // Pr√ß√£-processar crop
            const blob = await new Promise(resolve => {
                cropCanvas.toBlob(resolve, 'image/png');
            });
            
            const processedBlob = await preprocessarImagem(new File([blob], 'crop.png'));
            
            const result = await Tesseract.recognize(processedBlob, 'por', {
                tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                tessedit_char_whitelist: '0123456789:ENTRADAS√≥RIO ',
                tessedit_min_orientation_margin: '7.0',
                classify_bln_numeric_mode: '1'
            });
            
            return result.data;
        }
        
        // Detectar checkbox marcado - AN√ß√£LISE PERCENTUAL MELHORADA
        function detectarCheckboxMarcado(canvas) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            console.log(`??? An√ß√£lise de checkbox em imagem ${canvas.width}x${canvas.height}`);
            
            // ? COORDENADAS DOS CHECKBOXES (quadradinhos, n√£o o texto)
            // Baseado na imagem 954x641:
            // - Checkboxes ficam √£ ESQUERDA do texto
            // - Linha 1: Y ~ 385 (60% da altura)
            // - Linha 2: Y ~ 410 (64% da altura)
            // - Margem esquerda dos checkboxes: 5%, depois +20% entre cada um
            
            const largura = canvas.width;
            const altura = canvas.height;
            
            const checkboxes = [
                // Linha 1 (Y = 60%)
                // ? AJUSTE CR√ß√£TICO: Quadradinhos ficam BEM √£ ESQUERDA, antes do texto
                // Baseado na imagem: checkbox tem ~15px, fica a ~50px da esquerda
                { x: Math.round(largura * 0.045), y: Math.round(altura * 0.601), label: 'Esqueceu de registrar o Ponto' },
                { x: Math.round(largura * 0.275), y: Math.round(altura * 0.601), label: 'Falha no App' },
                { x: Math.round(largura * 0.515), y: Math.round(altura * 0.601), label: 'Falta' },
                { x: Math.round(largura * 0.755), y: Math.round(altura * 0.601), label: 'Folga' },
                // Linha 2 (Y = 64%)
                { x: Math.round(largura * 0.045), y: Math.round(altura * 0.641), label: 'Hora Parada' },
                { x: Math.round(largura * 0.275), y: Math.round(altura * 0.641), label: 'Maquina Ponto com defeito' },
                { x: Math.round(largura * 0.515), y: Math.round(altura * 0.641), label: 'Registro em duplicidade' },
                { x: Math.round(largura * 0.655), y: Math.round(altura * 0.641), label: 'Registro indevido' }
            ];
            
            console.log(`?? Analisando ${checkboxes.length} checkboxes...`);
            
            // ?? DEBUG VISUAL: Desenhar c√ß√£rculos vermelhos nas coordenadas
            const debugCanvas = document.createElement('canvas');
            const debugCtx = debugCanvas.getContext('2d');
            debugCanvas.width = canvas.width;
            debugCanvas.height = canvas.height;
            debugCtx.drawImage(canvas, 0, 0);
            
            debugCtx.strokeStyle = 'red';
            debugCtx.lineWidth = 3;
            debugCtx.fillStyle = 'red';
            debugCtx.font = '14px Arial';
            
            // ? NOVA ESTRat√©GIA: Pegar o checkbox com MAIOR % de preto
            let maxPreto = 0;
            let checkboxMarcado = null;
            
            checkboxes.forEach((cb, index) => {
                // Desenhar c√ß√£rculo vermelho
                debugCtx.beginPath();
                debugCtx.arc(cb.x, cb.y, 10, 0, 2 * Math.PI);
                debugCtx.stroke();
                
                // Desenhar n√ß√£mero
                debugCtx.fillText(`${index + 1}`, cb.x + 15, cb.y + 5);
                
                // Analisar √°rea 18x18
                const tamanho = 18;
                const imageData = ctx.getImageData(cb.x - tamanho/2, cb.y - tamanho/2, tamanho, tamanho);
                const data = imageData.data;
                
                let pixelsPretos = 0;
                let pixelsTotal = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Contar pixels pretos/escuros
                    if (r + g + b < 350) {
                        pixelsPretos++;
                    }
                    pixelsTotal++;
                }
                
                const percentualPreto = (pixelsPretos / pixelsTotal) * 100;
                
                console.log(`?? ${cb.label} (${cb.x},${cb.y}): ${percentualPreto.toFixed(1)}% preto`);
                
                // Guardar o que tiver MAIS preto
                if (percentualPreto > maxPreto) {
                    maxPreto = percentualPreto;
                    checkboxMarcado = cb.label;
                }
            });
            
            // ?? Abrir imagem de debug automaticamente em nova aba
            const debugUrl = debugCanvas.toDataURL('image/png');
            console.log('?? IMAGEM DE DEBUG GERADA!');
            console.log('??? Abrindo imagem com c√ß√£rculos vermelhos em nova aba...');
            console.log('?? Legenda: 1=Esqueceu, 2=Falha no App, 3=Falta, 4=Folga, 5=Hora Parada, 6=Maquina defeito, 7=Duplicidade, 8=Indevido');
            
            // Abrir em nova aba automaticamente
            const debugWindow = window.open();
            if (debugWindow) {
                debugWindow.document.write(`<img src="${debugUrl}" style="max-width:100%; height:auto;">`);
                debugWindow.document.title = 'Debug - posi√ß√£oes dos Checkboxes';
            } else {
                console.log('?? Pop-up bloqueado! Cole este link numa nova aba:');
                console.log(debugUrl);
            }
            
            // ? Retornar o checkbox com MAIOR concentra√ß√£o de preto (se > 15%)
            if (maxPreto > 15) {
                
                return checkboxMarcado;
            }
            
            console.log('?? Nenhum checkbox com concentra√ß√£o suficiente, usando padr√£o');
            return 'Esqueceu de registrar o Ponto';
        }
        
        // ==========================================
        // DETEC√ß√£√£O DE ASSINATURAS (FUNCION√ÅRIO E L√≠der)
        // ==========================================
        function detectarAssinaturas(canvas) {
            console.log('?? Iniciando detec√ß√£√£o de assinaturas (FUNCION√ÅRIO + L√≠der)...');
            
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const largura = canvas.width;
            const altura = canvas.height;
            
            // ?? REGI√ß√£ES DAS ASSINATURAS
            // Baseado na imagem fornecida:
            
            // FUNCION√ÅRIO (lado esquerdo inferior)
            // Regi√£o focada ACIMA do nome impresso "ADEMIR QUEIROZ DE SOUSA"
            const regiaoFuncionario = {
                x: Math.round(largura * 0.05),  // 5% da largura
                y: Math.round(altura * 0.80),   // 80% da altura (√°rea da assinatura manuscrita)
                w: Math.round(largura * 0.40),  // 40% da largura
                h: Math.round(altura * 0.10),   // 10% da altura (S√≥ a √°rea da assinatura, n√£o o texto)
                nome: 'FUNCION√ÅRIO',
                cor: '#3b82f6'  // Azul
            };
            
            // L√≠der (lado direito inferior)
            // Regi√£o focada ACIMA do nome impresso "JO√£O CARLOS ALMEIDA LOPES"
            const regiaoLider = {
                x: Math.round(largura * 0.52),  // 52% da largura (metade direita)
                y: Math.round(altura * 0.80),   // 80% da altura (√°rea da assinatura manuscrita)
                w: Math.round(largura * 0.43),  // 43% da largura
                h: Math.round(altura * 0.10),   // 10% da altura (S√≥ a √°rea da assinatura)
                nome: 'L√≠der',
                cor: '#10b981'  // Verde
            };
            
            const regioes = [regiaoFuncionario, regiaoLider];
            
            // ?? DEBUG VISUAL: Criar canvas com ret√©ngulos coloridos
            const debugCanvas = document.createElement('canvas');
            const debugCtx = debugCanvas.getContext('2d');
            debugCanvas.width = canvas.width;
            debugCanvas.height = canvas.height;
            debugCtx.drawImage(canvas, 0, 0);
            
            // Analisar cada regi√£o
            const resultados = {};
            
            regioes.forEach(regiao => {
                console.log(`\n?? Analisando ${regiao.nome}:`);
                console.log(`   Regi√£o: X=${regiao.x}, Y=${regiao.y}, W=${regiao.w}, H=${regiao.h}`);
                
                // Extrair dados da regi√£o
                const imageData = ctx.getImageData(regiao.x, regiao.y, regiao.w, regiao.h);
                const data = imageData.data;
                
                // An√ß√£lise de pixels
                let pixelsEscuros = 0;
                let pixelsTotal = 0;
                let pixelsMuitoEscuros = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const luminosidade = (r + g + b) / 3;
                    
                    pixelsTotal++;
                    
                    if (luminosidade < 180) {
                        pixelsEscuros++;
                    }
                    
                    if (luminosidade < 100) {
                        pixelsMuitoEscuros++;
                    }
                }
                
                const percentualEscuros = (pixelsEscuros / pixelsTotal) * 100;
                const percentualMuitoEscuros = (pixelsMuitoEscuros / pixelsTotal) * 100;
                
                console.log(`   ?? Pixels escuros (<180): ${percentualEscuros.toFixed(2)}%`);
                console.log(`   ?? Pixels muito escuros (<100): ${percentualMuitoEscuros.toFixed(2)}%`);
                
                // Crit√©rio de detec√ß√£√£o (threshold ajustado para distinguir assinatura manuscrita de texto impresso)
                // Texto impresso: ~1-2% pixels escuros
                // Assinatura manuscrita: ~5-10% pixels escuros
                const temAssinatura = percentualMuitoEscuros > 3 || percentualEscuros > 5;
                
                console.log(`   ${temAssinatura ? '? ASSINADO' : '? n√£o ASSINADO'}`);
                
                // Guardar resultado (usar chaves fixas para evitar problemas)
                if (regiao.nome === 'FUNCION√ÅRIO') {
                    resultados.funcionario = temAssinatura;
                } else if (regiao.nome === 'L√≠der') {
                    resultados.lider = temAssinatura;
                }
                
                // Desenhar ret√©ngulo colorido
                debugCtx.strokeStyle = temAssinatura ? regiao.cor : '#ef4444'; // Verde/Azul se assinado, Vermelho se n√£o
                debugCtx.lineWidth = 4;
                debugCtx.strokeRect(regiao.x, regiao.y, regiao.w, regiao.h);
                
                // Desenhar label
                debugCtx.fillStyle = temAssinatura ? regiao.cor : '#ef4444';
                debugCtx.font = 'bold 24px Arial';
                const label = `${temAssinatura ? '?' : '?'} ${regiao.nome.toUpperCase()}`;
                const textMetrics = debugCtx.measureText(label);
                const padding = 10;
                
                // Fundo do texto
                debugCtx.fillRect(
                    regiao.x, 
                    regiao.y - 40, 
                    textMetrics.width + padding * 2, 
                    35
                );
                
                // Texto
                debugCtx.fillStyle = 'white';
                debugCtx.fillText(label, regiao.x + padding, regiao.y - 12);
                
                // Adicionar percentuais
                debugCtx.font = '14px Arial';
                debugCtx.fillStyle = temAssinatura ? regiao.cor : '#ef4444';
                const stats = `${percentualMuitoEscuros.toFixed(1)}% preto | ${percentualEscuros.toFixed(1)}% escuro`;
                debugCtx.fillText(stats, regiao.x + 10, regiao.y + 25);
            });
            
            // ?? Mostrar imagem de debug
            const debugUrl = debugCanvas.toDataURL('image/png');
            const debugWindow = window.open('', '_blank', 'width=1000,height=800');
            if (debugWindow) {
                debugWindow.document.write(`
                    <html>
                        <head>
                            <title>?? Detec√ß√£√£o de Assinaturas</title>
                            <style>
                                body { 
                                    margin: 0; 
                                    padding: 20px; 
                                    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
                                    font-family: Arial, sans-serif;
                                }
                                .container {
                                    background: rgba(30, 41, 59, 0.95);
                                    border-radius: 15px;
                                    padding: 20px;
                                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                                }
                                h1 { 
                                    color: #e2e8f0; 
                                    margin: 0 0 15px 0;
                                    font-size: 28px;
                                }
                                .stats {
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 15px;
                                    margin-bottom: 20px;
                                }
                                .stat-box {
                                    padding: 15px;
                                    border-radius: 10px;
                                    text-align: center;
                                }
                                .stat-box.funcionario { background: #dbeafe; border: 3px solid #3b82f6; }
                                .stat-box.lider { background: #d1fae5; border: 3px solid #10b981; }
                                .stat-box.unsigned { background: #fee2e2; border: 3px solid #ef4444; }
                                .stat-box h3 { margin: 0 0 5px 0; font-size: 18px; }
                                .stat-box .status { font-size: 32px; margin: 5px 0; }
                                .stat-box .label { font-size: 14px; color: #64748b; }
                                img { 
                                    max-width: 100%; 
                                    border: 3px solid #cbd5e1; 
                                    border-radius: 10px;
                                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                }
                                .info {
                                    margin-top: 15px;
                                    padding: 15px;
                                    background: #f1f5f9;
                                    border-left: 4px solid #3b82f6;
                                    border-radius: 5px;
                                    font-size: 13px;
                                    color: #475569;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h1>?? Detec√ß√£√£o de Assinaturas</h1>
                                <div class="stats">
                                    <div class="stat-box ${resultados.funcionario ? 'funcionario' : 'unsigned'}">
                                        <h3>?? FUNCION√ÅRIO</h3>
                                        <div class="status">${resultados.funcionario ? '?' : '?'}</div>
                                        <div class="label">${resultados.funcionario ? 'ASSINADO' : 'n√£o ASSINADO'}</div>
                                    </div>
                                    <div class="stat-box ${resultados.lider ? 'lider' : 'unsigned'}">
                                        <h3>?? L√≠der</h3>
                                        <div class="status">${resultados.lider ? '?' : '?'}</div>
                                        <div class="label">${resultados.lider ? 'ASSINADO' : 'n√£o ASSINADO'}</div>
                                    </div>
                                </div>
                                <img src="${debugUrl}">
                                <div class="info">
                                    <strong>?? Legenda:</strong><br>
                                    ?? Ret√©ngulo AZUL = Regi√£o do FUNCION√ÅRIO<br>
                                    ?? Ret√©ngulo VERDE = Regi√£o do L√≠der<br>
                                    ?? Ret√©ngulo VERMELHO = Assinatura n√£o detectada<br><br>
                                    <strong>Limiar de detec√ß√£√£o:</strong> =2% pixels muito escuros OU =6% pixels escuros
                                </div>
                            </div>
                        </body>
                    </html>
                `);
            }
            
            return resultados;
        }
        
        // ==========================================
        // EXTRa√ß√£O DE ID DO PDF (VERS√≥O CORRIGIDA FINAL)
        // ==========================================
        async function extrairIdDoPDF(canvas) {
            console.log('?? Iniciando extra√ß√£o de ID (posi√ß√£oo: ID IMP)...');
            console.log('?? DimenS√≥es do canvas original:', canvas.width + 'x' + canvas.height);
            
            try {
                // ? REGI√£O CORRETA: "ID IMP: XX" na SEGUNDA linha do cabe√ß√£alho
                // Layout: [Nome/Cidade/Data] na linha 1, [REG/Projeto/ID IMP] na linha 2
                // ID IMP est√© no canto direito da segunda linha do cabe√ß√£alho
                const idRegion = { 
                    x: 700,  // Mais √£ esquerda para capturar "ID IMP:" completo
                    y: 175,  // Ajustado para linha 2 do cabe√ß√£alho
                    w: 150,  // Largura maior para capturar "ID IMP: XX" completo
                    h: 40    // Altura maior para garantir captura
                };
                
                console.log(`?? Buscando na regi√£o: X=${idRegion.x}, Y=${idRegion.y}, W=${idRegion.w}, H=${idRegion.h}`);
                
                // Crop da regi√£o
                const cropCanvas = document.createElement('canvas');
                const ctx = cropCanvas.getContext('2d');
                
                // Ampliar 4x para melhor leitura
                const scale = 4;
                cropCanvas.width = idRegion.w * scale;
                cropCanvas.height = idRegion.h * scale;
                
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(canvas, 
                    idRegion.x, idRegion.y, idRegion.w, idRegion.h,
                    0, 0, cropCanvas.width, cropCanvas.height
                );
                
                // Processamento de imagem: binariza√ß√£o forte
                const imageData = ctx.getImageData(0, 0, cropCanvas.width, cropCanvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Converter para escala de cinza
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    
                    // Binariza√ß√£o AGRESSIVA: texto preto vs fundo branco
                    // Threshold mais alto para melhor contraste
                    const binary = gray < 180 ? 0 : 255;
                    data[i] = data[i + 1] = data[i + 2] = binary;
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                // OCR otimizado
                const blob = await new Promise(resolve => cropCanvas.toBlob(resolve, 'image/png'));
                
                const result = await Tesseract.recognize(blob, 'por', {
                    tessedit_char_whitelist: '0123456789IDIMP: ',
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
                    preserve_interword_spaces: '1'
                });
                
                // ?? DEBUG VISUAL: Mostrar imagem processada e abrir em nova aba
                const debugUrl = cropCanvas.toDataURL();
                console.log('??? Regi√£o processada (copie o link abaixo e cole em nova aba):');
                console.log(debugUrl);
                console.log('?? Tamanho da regi√£o: ' + cropCanvas.width + 'x' + cropCanvas.height + 'px');
                
                // Abrir automaticamente em nova janela para visualiza√ß√£o
                try {
                    const debugWindow = window.open();
                    if (debugWindow) {
                        debugWindow.document.write(`<img src="${debugUrl}" style="border: 2px solid red;"/>`);
                        debugWindow.document.write(`<p>Regi√£o: X=${idRegion.x}, Y=${idRegion.y}, W=${idRegion.w}, H=${idRegion.h}</p>`);
                    }
                } catch (e) {
                    console.warn('?? n√£o foi posS√≥vel abrir janela de debug (popup bloqueado?)');
                }
                
                // ? verifica√ß√£oO SEGURA: checar se result existe antes de acessar propriedades
                if (!result || !result.data) {
                    console.error('? OCR n√£o retornou dados v√°lidos:', result);
                    return null;
                }
                
                const textoExtraido = result.data.text || '';
                const confidence = result.data.confidence || 0;
                
                console.log(`   ?? Texto extra√ß√£do: "${textoExtraido.trim()}"`);
                console.log(`   ?? Confian√ß√£a: ${Math.round(confidence)}%`);
                
                if (!textoExtraido) {
                    console.warn('   ?? OCR n√£o retornou texto');
                    return null;
                }
                
                // ? EXTRAIR ID: APENAS se tiver "ID IMP" pr√≥ximo ao n√ß√£mero
                // Padr√£o 1: "ID IMP: 22" ou "ID IMP 22" ou "IDIMP:22"
                let match = textoExtraido.match(/ID\s*IMP\s*:?\s*(\d{1,3})/i);
                
                // Padr√£o 2: N√ß√£mero ISOLADO de 1-2 d√ß√£gitos (ID IMP geralmente √£ < 100)
                // IMPORTANTE: n√£o capturar n√ß√£meros de data (evita "17" de "17/11")
                if (!match) {
                    // Procurar n√ß√£mero que n√£o est√© pr√≥ximo de barra (/)
                    const textoLimpo = textoExtraido.replace(/\d{1,2}\/\d{1,2}(\/\d{2,4})?/g, ''); // Remove datas
                    match = textoLimpo.match(/\b(\d{1,2})\b/); // N√ß√£meros de 1-2 d√ß√£gitos SOMENTE
                }
                
                if (match && match[1]) {
                    const id = parseInt(match[1]);
                    
                    // Validar se est√© em range v√°lido (1-99, expandido para permitir at√© 200 se necesS√≥rio)
                    if (id > 0 && id <= 200) {
                        console.log(`? ID detectado: #${id} (confian√ß√£a: ${Math.round(confidence)}%)`);
                        return id.toString();
                    } else {
                        console.warn(`   ?? N√ß√£mero encontrado (${id}) mas fora do range v√°lido (1-200)`);
                    }
                } else {
                    console.warn('   ?? Nenhum padr√£o de ID encontrado no texto');
                }
                
                // ?? FALLBACK: Tentar regi√ß√£es alternativas
                console.log('?? Tentando regi√ß√£es alternativas...');
                
                const alternativeRegions = [
                    { x: 650, y: 175, w: 200, h: 40, desc: 'Regi√£o ampla esquerda' },
                    { x: 680, y: 160, w: 160, h: 45, desc: 'Mais alto' },
                    { x: 720, y: 190, w: 140, h: 35, desc: 'Centro-direita' },
                    { x: 750, y: 175, w: 120, h: 40, desc: 'Extrema direita' },
                    { x: 600, y: 170, w: 250, h: 50, desc: 'Regi√£o MUITO ampla (√öltima tentativa)' }
                ];
                
                for (const altRegion of alternativeRegions) {
                    console.log(`   ?? Tentando: ${altRegion.desc} (X=${altRegion.x}, Y=${altRegion.y})`);
                    
                    const altCanvas = document.createElement('canvas');
                    const altCtx = altCanvas.getContext('2d');
                    const altScale = 4;
                    
                    altCanvas.width = altRegion.w * altScale;
                    altCanvas.height = altRegion.h * altScale;
                    altCtx.imageSmoothingEnabled = false;
                    altCtx.drawImage(canvas, 
                        altRegion.x, altRegion.y, altRegion.w, altRegion.h,
                        0, 0, altCanvas.width, altCanvas.height
                    );
                    
                    // Pr√ß√£-processamento
                    const altImageData = altCtx.getImageData(0, 0, altCanvas.width, altCanvas.height);
                    const altData = altImageData.data;
                    for (let i = 0; i < altData.length; i += 4) {
                        const gray = 0.299 * altData[i] + 0.587 * altData[i + 1] + 0.114 * altData[i + 2];
                        const binary = gray < 160 ? 0 : 255;
                        altData[i] = altData[i + 1] = altData[i + 2] = binary;
                    }
                    altCtx.putImageData(altImageData, 0, 0);
                    
                    const altBlob = await new Promise(resolve => altCanvas.toBlob(resolve, 'image/png'));
                    
                    // Tentar com PSM.SINGLE_LINE primeiro
                    let altResult = await Tesseract.recognize(altBlob, 'por', {
                        tessedit_char_whitelist: '0123456789IDIMP: ',
                        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE
                    });
                    
                    // Se falhar, tentar com PSM.AUTO
                    if (!altResult?.data?.text || altResult.data.text.trim() === '') {
                        console.log('      ?? PSM.SINGLE_LINE falhou, tentando PSM.AUTO...');
                        altResult = await Tesseract.recognize(altBlob, 'por', {
                            tessedit_char_whitelist: '0123456789IDIMP: ',
                            tessedit_pageseg_mode: Tesseract.PSM.AUTO
                        });
                    }
                    
                    if (altResult?.data?.text) {
                        const altTexto = altResult.data.text.trim();
                        console.log(`      ?? Texto alternativo: "${altTexto}"`);
                        
                        const altMatch = altTexto.match(/ID\s*IMP\s*:?\s*(\d{1,3})/i) || 
                                        altTexto.replace(/\d{1,2}\/\d{1,2}/g, '').match(/\b(\d{1,2})\b/);
                        
                        if (altMatch?.[1]) {
                            const altId = parseInt(altMatch[1]);
                            if (altId > 0 && altId <= 200) {
                                console.log(`? ID detectado na regi√£o alternativa: #${altId}`);
                                return altId.toString();
                            }
                        }
                    }
                }
                
            } catch (err) {
                console.error('? Erro ao extrair ID:', err);
                console.error('Stack trace:', err.stack);
            }
            
            console.warn('?? ID n√£o encontrado no PDF (tentativas esgotadas)');
            return null;
        }

        
        // ==========================================
        // PROCESSAMENTO DE IMAGEM COM valida√ß√£oO INTELIGENTE
        // ==========================================
        async function processarImagem(file) {
            console.log('?? Processando imagem:', file.name || 'clipboard');
            
            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewArea').style.display = 'block';
                currentAnexoImage = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Mostrar status
            document.getElementById('ocrStatus').style.display = 'block';
            document.getElementById('ocrResult').style.display = 'none';
            document.getElementById('ocrStatusText').textContent = '?? Analisando com Google Vision AI...';
            
            try {
                // Converter para base64
                const readerBase64 = new FileReader();
                const base64Image = await new Promise((resolve) => {
                    readerBase64.onload = (e) => resolve(e.target.result);
                    readerBase64.readAsDataURL(file);
                });
                
                // ======================================
                // ETAPA 1: VALIDAR ID (mant√©m l√©gica existente)
                // ======================================
                document.getElementById('ocrStatusText').textContent = '?? Verificando ID do formul√©rio...';
                
                const dadosExtraidos = await extrairDadosComGoogleVision(base64Image);
                
                const idEncontrado = dadosExtraidos.id;
                const idEsperado = currentAnexoEmployee?.id;
                
                console.log('');
                
                console.log('');
                
                // ?? CASO 1: IDs diferentes OU n√£o detectado = PERGUNTAR
                if (idEsperado && idEncontrado && parseInt(idEncontrado) !== parseInt(idEsperado)) {
                    const continuar = confirm(
                        `?? ID DIFERENTE!\n\n` +
                        `ID esperado: #${idEsperado}\n` +
                        `ID detectado: #${idEncontrado}\n\n` +
                        `Deseja continuar mesmo assim?`
                    );
                    
                    if (!continuar) {
                        document.getElementById('ocrStatus').style.display = 'none';
                        return;
                    }
                }
                
                // ?? CASO 2: n√£o leu ID = PERGUNTAR
                if (idEsperado && !idEncontrado) {
                    const continuar = confirm(
                        `?? ID n√£o DETECTADO\n\n` +
                        `n√£o foi posS√≥vel ler o ID automaticamente.\n\n` +
                        `?? FUNCION√ÅRIO: ${currentAnexoEmployee.name}\n` +
                        `?? ID esperado: #${idEsperado}\n\n` +
                        `Deseja continuar?`
                    );
                    
                    if (!continuar) {
                        document.getElementById('ocrStatus').style.display = 'none';
                        return;
                    }
                }
                
                // ? CASO 3: IDs batem
                if (idEncontrado && idEsperado && parseInt(idEncontrado) === parseInt(idEsperado)) {
                    console.log(`??? ID VALIDADO COM SUCESSO! ???`);
                }
                
                // ?? CASO 4: Primeiro formul√©rio
                if (!idEsperado) {
                    console.log(`?? FUNCION√ÅRIO ainda n√£o possui ID no sistema`);
                }
                
                // ======================================
                // ETAPA 2: USAR DADOS DO GOOGLE VISION
                // ======================================
                
                currentOCRData = dadosExtraidos;
                
                // Esconder status e mostrar resultado
                document.getElementById('ocrStatus').style.display = 'none';
                mostrarResultadoOCR(dadosExtraidos);
                document.getElementById('btnConfirmarAnexo').style.display = 'block';
                
            } catch (err) {
                console.error('? Erro no OCR:', err);
                console.error('Stack:', err.stack);
                document.getElementById('ocrStatusText').textContent = '?? Erro - voc√™ pode continuar manualmente';
                document.getElementById('btnConfirmarAnexo').style.display = 'block';
            }
        }

        
        // ?? fun√ß√£oO ANTIGA - n√£o MAIS USADA (substitu√ß√£da por extrairIdDoPDF(canvas))
        /*
        function extrairIdDoPDF_OLD(texto, palavrasComConfidencia = []) {
            console.log('?? Buscando ID no PDF...');
            
            // m√©TODO 1: Buscar padr√£o "ID #22" no texto completo
            const patterns = [
                /ID\s*#\s*(\d+)/i,
                /ID#(\d+)/i,
                /ID:(\d+)/i,
                /ID\s+(\d+)/i,
                /\bI\s*D\s*#?\s*(\d+)/i
            ];
            
            for (const pattern of patterns) {
                const match = texto.match(pattern);
                if (match) {
                    const id = match[1];
                    // Validar que n√£o √£ REG, Projeto ou Data
                    if (parseInt(id) < 200 && id.length <= 3) {
                        console.log(`?? ID encontrado (m√©todo 1 - texto): #${id}`);
                        return id;
                    }
                }
            }
            
            // m√©TODO 2: Buscar "#" seguido de n√ß√£mero pequeno em qualquer lugar
            const hashMatch = texto.match(/#\s*(\d{1,3})\b/);
            if (hashMatch) {
                const id = hashMatch[1];
                if (parseInt(id) > 0 && parseInt(id) < 200) {
                    console.log(`?? ID encontrado (m√©todo 2 - hash): #${id}`);
                    return id;
                }
            }
            
            // m√©TODO 3: Buscar em palavras com alta confian√ß√£a no CANTO SUPERIOR DIREITO
            if (palavrasComConfidencia && palavrasComConfidencia.length > 0) {
                console.log('?? Analisando posi√ß√£oes das palavras...');
                
                const candidatosID = [];
                
                palavrasComConfidencia.forEach((word, index) => {
                    // Procurar n√ß√£meros de 1-3 d√ß√£gitos no canto superior direito
                    const match = word.text.match(/^#?(\d{1,3})$/);
                    if (match && word.confidence > 80) {
                        const id = match[1];
                        const x = word.bbox.x0;
                        const y = word.bbox.y0;
                        const num = parseInt(id);
                        
                        // ID deve estar: TOPO (Y < 250) e DIREITA (X > 550)
                        // N√ß√£mero pequeno (< 200) para diferenciar de REG/Projeto
                        if (num > 0 && num < 200 && x > 550 && y < 250) {
                            candidatosID.push({
                                id: id,
                                confidence: word.confidence,
                                x: x,
                                y: y,
                                score: x - (y * 2) // Prioriza X alto e Y baixo (n√ß√£meros positivos)
                            });
                        }
                    }
                });
                
                // Ordenar por score (prioriza topo-direito)
                candidatosID.sort((a, b) => b.score - a.score);
                
                if (candidatosID.length > 0) {
                    const melhor = candidatosID[0];
                    console.log(`?? ID encontrado (m√©todo 3 - posi√ß√£oo): #${melhor.id}`);
                    console.log(`   X=${Math.round(melhor.x)}, Y=${Math.round(melhor.y)}, Score=${Math.round(melhor.score)}, Confian√ß√£a=${Math.round(melhor.confidence)}%`);
                    if (candidatosID.length > 1) {
                        console.log(`   Rejeitados: ${candidatosID.slice(1).map(c => `#${c.id} (X=${Math.round(c.x)}, Y=${Math.round(c.y)}, Score=${Math.round(c.score)})`).join(', ')}`);
                    }
                    return melhor.id;
                }
            }
            
            console.warn('?? ID n√£o encontrado no PDF');
            return null;
        }
        */

        // ?? fun√ß√£oO ANTIGA - n√£o MAIS USADA (sistema h√ß√£brido agora detecta caixas automaticamente)
        /*
        // ?? EXTRa√ß√£O MELHORADA COM valida√ß√£oO INTELIGENTE
        function extrairDadosOCRMelhorado(texto, palavrasFiltradas, ocrData) {
            console.log('?? Iniciando extra√ß√£o melhorada de dados...');
            
            const dados = {
                ent1: null,
                sai1: null,
                ent2: null,
                sai2: null,
                ent3: null,
                sai3: null,
                motivo: null,
                confidence: {
                    ent1: 0,
                    sai1: 0,
                    ent2: 0,
                    sai2: 0,
                    ent3: 0,
                    sai3: 0,
                    motivo: 0
                }
            };
            
            // EXTRa√ß√£O DE Hor√°rioS COM valida√ß√£oO
            const horariosEncontrados = [];
            
            // Buscar Hor√°rios nas palavras filtradas (confian√ß√£a > 70%)
            for (let i = 0; i < palavrasFiltradas.length; i++) {
                const word = palavrasFiltradas[i];
                
                // Padr√£o 1: HH:MM
                const match1 = word.text.match(/^(\d{1,2}):(\d{2})$/);
                if (match1) {
                    const hora = parseInt(match1[1]);
                    const min = parseInt(match1[2]);
                    
                    if (hora >= 0 && hora <= 23 && min >= 0 && min <= 59) {
                        horariosEncontrados.push({
                            horario: `${hora.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`,
                            confidence: word.confidence,
                            posicao: word.bbox.x0
                        });
                        console.log(`? Hor√°rio detectado: ${hora}:${min} (confian√ß√£a: ${Math.round(word.confidence)}%)`);
                    }
                }
                
                // Padr√£o 2: HHMM (4 d√ß√£gitos)
                const match2 = word.text.match(/^(\d{4})$/);
                if (match2) {
                    const valor = match2[1];
                    const hora = parseInt(valor.substring(0, 2));
                    const min = parseInt(valor.substring(2, 4));
                    
                    if (hora >= 0 && hora <= 23 && min >= 0 && min <= 59) {
                        if (parseInt(valor) < 2020 || parseInt(valor) > 2030) {
                            horariosEncontrados.push({
                                horario: `${hora.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`,
                                confidence: word.confidence,
                                posicao: word.bbox.x0
                            });
                            console.log(`? Hor√°rio detectado (4 d√ß√£gitos): ${hora}:${min} (confian√ß√£a: ${Math.round(word.confidence)}%)`);
                        }
                    }
                }
                
                // Padr√£o 3: HH MM (dois n√ß√£meros separados por espa√£o) - "07 10"
                const match3 = word.text.match(/^(\d{2})$/);
                if (match3 && i + 1 < palavrasFiltradas.length) {
                    const nextWord = palavrasFiltradas[i + 1];
                    const match4 = nextWord.text.match(/^(\d{2})$/);
                    
                    if (match4) {
                        const hora = parseInt(match3[1]);
                        const min = parseInt(match4[1]);
                        
                        // Verificar se pr√ß√£xima palavra est√© pr√ß√£xima horizontalmente (mesmo Hor√°rio)
                        const distancia = Math.abs(nextWord.bbox.x0 - (word.bbox.x0 + 30));
                        const distanciaVertical = Math.abs(nextWord.bbox.y0 - word.bbox.y0);
                        
                        console.log(`?? Par "${word.text}" + "${nextWord.text}": X1=${Math.round(word.bbox.x0)}, X2=${Math.round(nextWord.bbox.x0)}, distH=${Math.round(distancia)}px, distV=${Math.round(distanciaVertical)}px`);
                        
                        if (distancia < 80 && distanciaVertical < 20 && hora >= 0 && hora <= 23 && min >= 0 && min <= 59) {
                            horariosEncontrados.push({
                                horario: `${hora.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`,
                                confidence: (word.confidence + nextWord.confidence) / 2,
                                posicao: word.bbox.x0
                            });
                            console.log(`? Hor√°rio detectado (espa√ß√£ado): ${hora}:${min} (confian√ß√£a: ${Math.round((word.confidence + nextWord.confidence) / 2)}%)`);
                            i++; // Pular pr√ß√£xima palavra j√° processada
                        } else {
                            const motivos = [];
                            if (distancia >= 80) motivos.push('muito distante');
                            if (distanciaVertical >= 20) motivos.push('n√£o alinhado');
                            if (hora < 0 || hora > 23 || min < 0 || min > 59) motivos.push('inv√°lido');
                            console.log(`? Rejeitado: ${motivos.join(', ')}`);
                        }
                    }
                }
            }
            
            // Ordenar Hor√°rios por posi√ß√£oo (esquerda ? direita, cima ? baixo)
            horariosEncontrados.sort((a, b) => a.posicao - b.posicao);
            
            console.log(`?? Total de Hor√°rios v√°lidos encontrados: ${horariosEncontrados.length}`);
            
            // Atribuir Hor√°rios aos campos (m√°ximo 6: ent1, sai1, ent2, sai2, ent3, sai3)
            const campos = ['ent1', 'sai1', 'ent2', 'sai2', 'ent3', 'sai3'];
            horariosEncontrados.slice(0, 6).forEach((h, index) => {
                if (campos[index]) {
                    dados[campos[index]] = h.horario;
                    dados.confidence[campos[index]] = Math.round(h.confidence);
                }
            });
            
            // EXTRa√ß√£O DE MOTIVO COM DETEC√ß√£√£O DE CHECKBOX MARCADO
            const textoLower = texto.toLowerCase();
            const distanciaMax = 100;
            
            // Buscar marca√ß√£es "X" com alta confian√ß√£a
            const marcacoesX = palavrasFiltradas.filter(word => 
                /^[xX????]$/.test(word.text) && word.confidence > 60
            );
            
            console.log(`? Marca√ß√£es "X" encontradas (confian√ß√£a > 60%): ${marcacoesX.length}`);
            
            // Lista de justificativas
            const justificativasMap = [
                { palavras: ['esquec', 'registr.*ponto'], motivo: 'Esqueceu de registrar o Ponto' },
                { palavras: ['falha.*app', 'app'], motivo: 'Falha no App' },
                { palavras: ['falta'], motivo: 'Falta' },
                { palavras: ['folga'], motivo: 'Folga' },
                { palavras: ['hora.*parada', 'parada'], motivo: 'Hora Parada' },
                { palavras: ['maquina.*defeito', 'm√©quina.*defeito', 'defeito'], motivo: 'Maquina Ponto com defeito' },
                { palavras: ['duplicidade', 'duplicado'], motivo: 'Registro em duplicidade' },
                { palavras: ['indevido'], motivo: 'Registro indevido' }
            ];
            
            let motivoDetectado = null;
            let menorDistancia = Infinity;
            let confidenciaMotivo = 0;
            
            justificativasMap.forEach(item => {
                item.palavras.forEach(palavra => {
                    const regex = new RegExp(palavra, 'i');
                    const match = textoLower.search(regex);
                    
                    if (match !== -1) {
                        // Procurar "X" pr√≥ximo
                        marcacoesX.forEach(xWord => {
                            const dist = Math.abs(xWord.bbox.x0 - match);
                            if (dist < distanciaMax && dist < menorDistancia) {
                                menorDistancia = dist;
                                motivoDetectado = item.motivo;
                                confidenciaMotivo = Math.round(xWord.confidence);
                                console.log(`? Motivo detectado: "${item.motivo}" (confian√ß√£a: ${confidenciaMotivo}%, dist√©ncia: ${dist})`);
                            }
                        });
                    }
                });
            });
            
            dados.motivo = motivoDetectado;
            dados.confidence.motivo = confidenciaMotivo;
            
            console.log('?? Extra√ß√£o finalizada:', dados);
            return dados;
        }
        */

        // Extrair Hor√°rios e motivo do texto OCR (fun√ß√£oO ANTIGA - MANTER COMO FALLBACK)
        function extrairDadosOCR(texto) {
            console.log('?? Texto OCR completo:', texto);
            
            const dados = {
                ent1: null,
                sai1: null,
                ent2: null,
                sai2: null,
                ent3: null,
                sai3: null,
                ent4: null,
                sai4: null,
                ent5: null,
                sai5: null,
                motivo: null
            };
            
            // MELHORAR DETEC√ß√£√£O DE Hor√°rioS
            // Procurar m√©ltiplos padr√ß√£es
            const horariosEncontrados = [];
            
            // Padr√£o 1: HH:MM ou HH MM (com separador)
            const regex1 = /\b(\d{1,2})\s*[:\s]\s*(\d{2})\b/g;
            let match;
            
            while ((match = regex1.exec(texto)) !== null) {
                let hora = parseInt(match[1]);
                let min = parseInt(match[2]);
                
                if (hora >= 0 && hora <= 23 && min >= 0 && min <= 59) {
                    horariosEncontrados.push({
                        hora: match[1].padStart(2, '0'),
                        min: match[2].padStart(2, '0'),
                        original: match[0],
                        posicao: match.index,
                        tipo: 'separado'
                    });
                }
            }
            
            // Padr√£o 2: HHMM (4 d√ß√£gitos juntos) - NOVO!
            const regex2 = /\b(\d{4})\b/g;
            
            while ((match = regex2.exec(texto)) !== null) {
                const valor = match[1];
                const hora = parseInt(valor.substring(0, 2));
                const min = parseInt(valor.substring(2, 4));
                
                console.log(`?? Padr√£o2 encontrado: "${valor}" ? Hora=${hora}, Min=${min}`);
                
                // FILTROS DE valida√ß√£oO
                // 1. Validar se pode ser Hor√°rio
                if (hora < 0 || hora > 23 || min < 0 || min > 59) {
                    console.log(`   ? Rejeitado: Hor√°rio inv√°lido (hora ${hora}, min ${min})`);
                    continue;
                }
                
                // 2. Ignorar anos (2024, 2025, etc)
                if (parseInt(valor) >= 2000 && parseInt(valor) <= 2100) {
                    console.log(`   ? Rejeitado: parece ano (${valor})`);
                    continue;
                }
                
                // 3. Ignorar se vier depois de "Data:" ou "/" (contexto de data)
                const contextoAntes = texto.substring(Math.max(0, match.index - 20), match.index);
                if (/data:\s*\d+\/\d+\/$/i.test(contextoAntes)) {
                    console.log(`   ? Rejeitado: contexto de data (${contextoAntes})`);
                    continue;
                }
                if (/\/\d+\/$/i.test(contextoAntes)) {
                    console.log(`   ? Rejeitado: contexto de barra (${contextoAntes})`);
                    continue;
                }
                
                const horarioStr = `${hora.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                
                // n√£o adicionar se j√° existe (evitar duplicata)
                const jaExiste = horariosEncontrados.find(h => `${h.hora}:${h.min}` === horarioStr);
                
                if (!jaExiste) {
                    console.log(`   ? Aceito: ${horarioStr}`);
                    horariosEncontrados.push({
                        hora: hora.toString().padStart(2, '0'),
                        min: min.toString().padStart(2, '0'),
                        original: match[0],
                        posicao: match.index,
                        tipo: '4digitos'
                    });
                } else {
                    console.log(`   ?? Duplicado: ${horarioStr}`);
                }
            }
            
            // Ordenar por posi√ß√£oo no texto
            horariosEncontrados.sort((a, b) => a.posicao - b.posicao);
            
            console.log('? Hor√°rios detectados:', horariosEncontrados);
            
            // Filtrar duplicatas por valor
            const horariosLimpos = [];
            horariosEncontrados.forEach(h => {
                const horarioStr = `${h.hora}:${h.min}`;
                if (!horariosLimpos.find(hl => hl === horarioStr)) {
                    horariosLimpos.push(horarioStr);
                }
            });
            
            console.log('? Hor√°rios √∫nicos:', horariosLimpos);
            
            // Atribuir Hor√°rios detectados
            if (horariosLimpos.length >= 1) dados.ent1 = horariosLimpos[0];
            if (horariosLimpos.length >= 2) dados.sai1 = horariosLimpos[1];
            if (horariosLimpos.length >= 3) dados.ent2 = horariosLimpos[2];
            if (horariosLimpos.length >= 4) dados.sai2 = horariosLimpos[3];
            if (horariosLimpos.length >= 5) dados.ent3 = horariosLimpos[4];
            if (horariosLimpos.length >= 6) dados.sai3 = horariosLimpos[5];
            
            // DETECTAR MOTIVO com m√©ltiplas estrat√©gias
            const textoLower = texto.toLowerCase();
            
            // 1. Procurar por "X" ou marca√ß√£es pr√≥ximo √£s palavras-chave
            const distanciaMax = 100; // aumentado para captar melhor
            
            // Lista de palavras-chave para cada justificativa
            const justificativasMap = [
                { palavras: ['esquec', 'registr.*ponto'], motivo: 'Esqueceu de registrar o Ponto' },
                { palavras: ['falha.*app', 'app'], motivo: 'Falha no App' },
                { palavras: ['falta'], motivo: 'Falta' },
                { palavras: ['folga'], motivo: 'Folga' },
                { palavras: ['hora.*parada', 'parada'], motivo: 'Hora Parada' },
                { palavras: ['maquina.*defeito', 'm√©quina.*defeito', 'defeito'], motivo: 'Maquina Ponto com defeito' },
                { palavras: ['duplicidade', 'duplicado'], motivo: 'Registro em duplicidade' },
                { palavras: ['indevido'], motivo: 'Registro indevido' }
            ];
            
            // Procurar "X", checkboxes marcados, ou qualquer S√≥mbolo de marca√ß√£o
            // Melhorado para captar mais varia√ß√£es
            const regexX = /\b[xX????]\b|\\[xX\\]|\(\\s*[xX]\\s*\)|\[[xX]\]/g;
            const xMatches = [];
            let xMatch;
            while ((xMatch = regexX.exec(texto)) !== null) {
                xMatches.push(xMatch.index);
            }
            
            console.log('? Marca√ß√£es "X" encontradas em:', xMatches);
            
            // Verificar qual op√©√£o tem "X" mais pr√≥ximo
            let motivoDetectado = null;
            let menorDistancia = Infinity;
            
            justificativasMap.forEach(item => {
                item.palavras.forEach(palavra => {
                    const regex = new RegExp(palavra, 'i');
                    const match = textoLower.search(regex);
                    
                    if (match !== -1) {
                        xMatches.forEach(xPos => {
                            const dist = Math.abs(xPos - match);
                            if (dist < distanciaMax && dist < menorDistancia) {
                                menorDistancia = dist;
                                motivoDetectado = item.motivo;
                                console.log(`? Motivo detectado: "${item.motivo}" (dist√©ncia: ${dist} do "X")`);
                                console.log(`? Motivo detectado: "${item.motivo}" (dist√©ncia: ${dist} do "X")`);
                            }
                        });
                    }
                });
            });
            
            dados.motivo = motivoDetectado;
            console.log('?? Motivo detectado:', motivoDetectado);
            
            return dados;
        }
        
        // ?? Mostrar resultado do OCR COM INDICADORES DE CONFIAN√ß√£A
        function mostrarResultadoOCR(dados) {
            // fun√ß√£oo auxiliar para cor do indicador baseado na confian√ß√£a
            const getConfidenceColor = (confidence) => {
                if (confidence >= 80) return '#10b981'; // Verde
                if (confidence >= 60) return '#f59e0b'; // Amarelo
                return '#ef4444'; // Vermelho
            };
            
            const getConfidenceBadge = (confidence, label) => {
                if (!confidence || confidence === 0) return '';
                const color = getConfidenceColor(confidence);
                return `<span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background: ${color}; color: white; border-radius: 12px; font-size: 10px; font-weight: 600;">${confidence}%</span>`;
            };
            
            // ?? BUSCAR Hor√°rioS j√° BATIDOS do FUNCION√ÅRIO
            const horariosJaBatidos = {
                ent1: currentAnexoEmployee?.punches?.ent1 || currentAnexoEmployee?.ent1,
                sai1: currentAnexoEmployee?.punches?.sai1 || currentAnexoEmployee?.sai1,
                ent2: currentAnexoEmployee?.punches?.ent2 || currentAnexoEmployee?.ent2,
                sai2: currentAnexoEmployee?.punches?.sai2 || currentAnexoEmployee?.sai2,
                ent3: currentAnexoEmployee?.punches?.ent3 || currentAnexoEmployee?.ent3,
                sai3: currentAnexoEmployee?.punches?.sai3 || currentAnexoEmployee?.sai3
            };
            
            console.log('?? Hor√°rios j√° batidos:', horariosJaBatidos);
            
            // fun√ß√£oo para criar campo (bloqueado se j√° batido, edit√©vel se vazio)
            const criarCampo = (id, label, valorOCR, valorJaBatido, confidence) => {
                const jaBatido = valorJaBatido && valorJaBatido !== '--:--';
                const valor = jaBatido ? valorJaBatido : (valorOCR || '');
                const bloqueado = jaBatido ? 'disabled' : '';
                const corBorda = jaBatido ? '#94a3b8' : getConfidenceColor(confidence || 0);
                const bgColor = jaBatido ? '#f1f5f9' : 'white';
                const badge = jaBatido ? '<span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background: #64748b; color: white; border-radius: 12px; font-size: 10px; font-weight: 600;">?? j√° BATIDO</span>' : getConfidenceBadge(confidence, label);
                
                return `
                    <div>
                        <label style="font-size: 12px; color: #065f46; font-weight: 500;">
                            ${label}: ${badge}
                        </label>
                        <input type="time" id="${id}" value="${valor}" ${bloqueado}
                               style="width: 100%; padding: 6px; border: 2px solid ${corBorda}; border-radius: 4px; background: ${bgColor}; cursor: ${jaBatido ? 'not-allowed' : 'text'};">
                    </div>
                `;
            };
            
            let html = `
                <div style="margin-bottom: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div style="padding: 12px; background: ${dados.assinaturaFuncionario ? '#dbeafe' : '#fee2e2'}; border-left: 4px solid ${dados.assinaturaFuncionario ? '#3b82f6' : '#ef4444'}; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">${dados.assinaturaFuncionario ? '?' : '?'}</span>
                            <div>
                                <div style="font-weight: 600; color: ${dados.assinaturaFuncionario ? '#1e40af' : '#991b1b'}; font-size: 14px;">
                                    ?? FUNCION√ÅRIO
                                </div>
                                <div style="font-size: 11px; color: ${dados.assinaturaFuncionario ? '#1e40af' : '#b91c1c'}; margin-top: 2px;">
                                    ${dados.assinaturaFuncionario ? 'ASSINADO' : 'n√£o ASSINADO'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 12px; background: ${dados.assinaturaLider ? '#d1fae5' : '#fee2e2'}; border-left: 4px solid ${dados.assinaturaLider ? '#10b981' : '#ef4444'}; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">${dados.assinaturaLider ? '?' : '?'}</span>
                            <div>
                                <div style="font-weight: 600; color: ${dados.assinaturaLider ? '#065f46' : '#991b1b'}; font-size: 14px;">
                                    ?? L√≠der
                                </div>
                                <div style="font-size: 11px; color: ${dados.assinaturaLider ? '#047857' : '#b91c1c'}; margin-top: 2px;">
                                    ${dados.assinaturaLider ? 'ASSINADO' : 'n√£o ASSINADO'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; color: #065f46; margin-bottom: 8px;">
                        ?? Motivo: ${getConfidenceBadge(dados.confidence?.motivo, 'Motivo')}
                    </label>
                    <select id="ocrMotivo" style="width: 100%; padding: 8px; border: 2px solid ${getConfidenceColor(dados.confidence?.motivo || 0)}; border-radius: 6px; font-size: 14px;">
                        <option value="">-- Selecione --</option>
                        <option value="Esqueceu de registrar o Ponto" ${dados.motivo === 'Esqueceu de registrar o Ponto' ? 'selected' : ''}>Esqueceu de registrar o Ponto</option>
                        <option value="Falha no App" ${dados.motivo === 'Falha no App' ? 'selected' : ''}>Falha no App</option>
                        <option value="Falta" ${dados.motivo === 'Falta' ? 'selected' : ''}>Falta</option>
                        <option value="Folga" ${dados.motivo === 'Folga' ? 'selected' : ''}>Folga</option>
                        <option value="Hora Parada" ${dados.motivo === 'Hora Parada' ? 'selected' : ''}>Hora Parada</option>
                        <option value="Maquina Ponto com defeito" ${dados.motivo === 'Maquina Ponto com defeito' ? 'selected' : ''}>Maquina Ponto com defeito</option>
                        <option value="Registro em duplicidade" ${dados.motivo === 'Registro em duplicidade' ? 'selected' : ''}>Registro em duplicidade</option>
                        <option value="Registro indevido" ${dados.motivo === 'Registro indevido' ? 'selected' : ''}>Registro indevido</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 8px;">
                    <label style="display: block; font-weight: 600; color: #065f46; margin-bottom: 8px;">? Hor√°rios (corrija se necesS√≥rio):</label>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    ${criarCampo('ocrEnt1', 'Entrada 1', dados.ent1, horariosJaBatidos.ent1, dados.confidence?.ent1)}
                    ${criarCampo('ocrSai1', 'SA√çda 1', dados.sai1, horariosJaBatidos.sai1, dados.confidence?.sai1)}
                    ${criarCampo('ocrEnt2', 'Entrada 2', dados.ent2, horariosJaBatidos.ent2, dados.confidence?.ent2)}
                    ${criarCampo('ocrSai2', 'SA√çda 2', dados.sai2, horariosJaBatidos.sai2, dados.confidence?.sai2)}
                    ${criarCampo('ocrEnt3', 'Entrada 3', dados.ent3, horariosJaBatidos.ent3, dados.confidence?.ent3)}
                    ${criarCampo('ocrSai3', 'SA√çda 3', dados.sai3, horariosJaBatidos.sai3, dados.confidence?.sai3)}
                </div>
                
                <div style="margin-top: 12px; padding: 12px; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 4px;">
                    <div style="font-size: 12px; color: #1e40af; line-height: 1.5;">
                        <strong>?? Indicadores:</strong><br>
                        <span style="color: #64748b;">??</span> Cinza: Hor√°rio j√° batido (bloqueado)<br>
                        <span style="color: #10b981;">?</span> Verde (=80%): Alta confian√ß√£a<br>
                        <span style="color: #f59e0b;">?</span> Amarelo (60-80%): m√©dia confian√ß√£a - revisar<br>
                        <span style="color: #ef4444;">?</span> Vermelho (<60%): Baixa confian√ß√£a - corrigir
                    </div>
                </div>
            `;
            
            document.getElementById('ocrResultContent').innerHTML = html;
            document.getElementById('ocrResult').style.display = 'block';
        }
        
        // Confirmar e enviar anexo
        async function confirmarAnexo() {
            if (!currentAnexoEmployee || !currentAnexoImage) {
                alert('? Erro: Nenhuma imagem selecionada');
                return;
            }
            
            // ?? VALIDAR ASSINATURAS ANTES DE ENVIAR
            if (currentOCRData && (currentOCRData.assinaturaFuncionario === false || currentOCRData.assinaturaLider === false)) {
                const faltantes = [];
                if (!currentOCRData.assinaturaFuncionario) faltantes.push('?? FUNCION√ÅRIO');
                if (!currentOCRData.assinaturaLider) faltantes.push('?? L√≠der');
                
                const confirmar = confirm(
                    `?? ASSINATURAS FALTANDO\n\n` +
                    `As seguintes assinaturas n√£o foram detectadas:\n${faltantes.join('\n')}\n\n` +
                    `Deseja prosseguir mesmo assim?\n\n` +
                    `? OK = Aceitar sem assinatura\n` +
                    `? Cancelar = n√£o enviar`
                );
                
                if (!confirmar) {
                    console.log('? Usu√°rio cancelou envio por falta de assinaturas');
                    return;
                }
                
                console.log('?? Usu√°rio aceitou enviar sem assinaturas completas');
            }
            
            const btn = document.getElementById('btnConfirmarAnexo');
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            
            try {
                // LER VALORES EDITADOS PELO Usu√°rio
                const motivoEditado = document.getElementById('ocrMotivo')?.value || '';
                const ent1 = document.getElementById('ocrEnt1')?.value || '';
                const sai1 = document.getElementById('ocrSai1')?.value || '';
                const ent2 = document.getElementById('ocrEnt2')?.value || '';
                const sai2 = document.getElementById('ocrSai2')?.value || '';
                const ent3 = document.getElementById('ocrEnt3')?.value || '';
                const sai3 = document.getElementById('ocrSai3')?.value || '';
                
                // Atualizar currentOCRData com valores editados
                currentOCRData = {
                    motivo: motivoEditado,
                    ent1: ent1,
                    sai1: sai1,
                    ent2: ent2,
                    sai2: sai2,
                    ent3: ent3,
                    sai3: sai3
                };
                
                console.log('?? Dados finais (editados pelo Usu√°rio):', currentOCRData);
                
                // ?? USAR SEMPRE A DATA DA TABELA, IGNORAR rawData.Data
                let dataFormatted = currentAnexoEmployee.date;
                
                console.log(`?? Data da TABELA (USANDO ESTA): ${currentAnexoEmployee.date}`);
                console.log(`?? Data da API rawData (IGNORANDO): ${currentAnexoEmployee.rawData?.Data}`);
                
                // Formato estranho da API: 28T00:00:00/10/2025 -> 2025-10-28
                const strangeMatch = dataFormatted.match(/^(\d{1,2})T\d{2}:\d{2}:\d{2}\/(\d{1,2})\/(\d{4})/);
                if (strangeMatch) {
                    const dia = strangeMatch[1].padStart(2, '0');
                    const mes = strangeMatch[2].padStart(2, '0');
                    const ano = strangeMatch[3];
                    dataFormatted = `${ano}-${mes}-${dia}`;
                    console.log(`? Formato estranho detectado, convertido para: ${dataFormatted}`);
                } else if (dataFormatted.includes('T')) {
                    // Formato ISO: 2025-10-28T00:00:00
                    dataFormatted = dataFormatted.split('T')[0];
                } else if (dataFormatted.includes('/')) {
                    // Formato BR: 28/10/2025 -> 2025-10-28
                    const parts = dataFormatted.split('/');
                    if (parts.length === 3) {
                        dataFormatted = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        console.log(`?? Formato BR detectado, convertido para: ${dataFormatted}`);
                    }
                }
                
                console.log(`?? Data formatada final para envio: ${dataFormatted}`);
                
                // Preparar dados (usando CPF + DATA como chave √£nica)
                const payload = {
                    cpf: currentAnexoEmployee.cpf,  // ? CPF como identificador √∫nico
                    reg: currentAnexoEmployee.reg,
                    data: dataFormatted,
                    empresa_id: currentAnexoEmployee.empresaId || currentAnexoEmployee.companyId,
                    empresa_nome: currentAnexoEmployee.city,
                    funcionario_nome: currentAnexoEmployee.name,
                    imageBase64: currentAnexoImage,
                    motivo: currentOCRData.motivo,
                    horarios: currentOCRData,
                    ocr_texto: JSON.stringify(currentOCRData),
                    perguntas_rh: JSON.stringify(currentAnexoEmployee.questions || {})
                };
                
                console.log('?? Enviando anexo com data:', payload.data);
                
                // Upload pro servidor (Azure Blob + SQL)
                // O servidor far√ß√£ UPDATE automaticamente se registro j√° existir (REG+DATA+EMPRESA_ID)
                const response = await fetch(`${API_BASE_URL}/api/anexos/upload`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('? Anexo salvo:', result);
                    
                    // BUSCAR a refer√ß√£ncia correta do FUNCION√ÅRIO em allEmployees
                    const dataFormatada = currentAnexoEmployee.rawData?.Data?.split('T')[0] || currentAnexoEmployee.date;
                    const empRef = allEmployees.find(e => 
                        e.reg === currentAnexoEmployee.reg && 
                        (e.rawData?.Data?.split('T')[0] === dataFormatada || e.date === dataFormatada)
                    );
                    
                    if (empRef) {
                        // Atualizar refer√ß√£ncia com anexo
                        empRef.anexoUrl = result.blobUrl;
                        empRef.motivo = result.motivo || empRef.motivo;
                        empRef.attachments = [result.filename];
                        empRef.id = empRef.id || currentAnexoEmployee.id; // Manter ID
                        
                        // PREENCHER OS CAMPOS NA TABELA
                        empRef.punches.ent1 = currentOCRData.ent1 || empRef.punches.ent1;
                        empRef.punches.sai1 = currentOCRData.sai1 || empRef.punches.sai1;
                        empRef.punches.ent2 = currentOCRData.ent2 || empRef.punches.ent2;
                        empRef.punches.sai2 = currentOCRData.sai2 || empRef.punches.sai2;
                        empRef.punches.ent3 = currentOCRData.ent3 || empRef.punches.ent3;
                        empRef.punches.sai3 = currentOCRData.sai3 || empRef.punches.sai3;
                        
                        // n√£o marcar como pendingOCR (vamos enviar direto)
                        empRef.ocrData = currentOCRData;
                        
                        console.log('?? Campos preenchidos na tabela');
                        console.log('   Ent1:', empRef.punches.ent1, 'Sai1:', empRef.punches.sai1);
                        console.log('   Ent2:', empRef.punches.ent2, 'Sai2:', empRef.punches.sai2);
                        console.log('   Ent3:', empRef.punches.ent3, 'Sai3:', empRef.punches.sai3);
                        
                        // Re-renderizar tabela
                        renderTable();
                        
                        // FECHAR MODAL PRIMEIRO
                        fecharModalAnexo();
                        
                        // ?? ENVIAR AUTOMATICAMENTE PARA SECULLUM (SEM CHECKBOX)
                        console.log('?? Enviando automaticamente para Secullum...');
                        showLoading('Enviando para Secullum...');
                        
                        try {
                            await enviarParaSecullum(empRef, true); // true = autoEnvio sem popup
                            
                            hideLoading();
                            
                            // Montar string de Hor√°rios enviados (usar empRef.punches que √£ garantido)
                            const horariosStr = [
                                empRef.punches?.ent1, 
                                empRef.punches?.sai1, 
                                empRef.punches?.ent2, 
                                empRef.punches?.sai2, 
                                empRef.punches?.ent3, 
                                empRef.punches?.sai3
                            ].filter(h => h).join(', ');
                            
                            showAlert(
                                'Sucesso!',
                                `? Anexo salvo e Hor√°rios enviados para Secullum!\n\n` +
                                `?? Arquivo: ${result.filename}\n` +
                                `?? Motivo: ${result.motivo || 'n√£o detectado'}\n` +
                                `? Hor√°rios: ${horariosStr}`,
                                'success'
                            );
                            
                        } catch (err) {
                            hideLoading();
                            console.error('? Erro ao enviar para Secullum:', err);
                            showAlert('Erro', `Anexo salvo mas erro ao enviar para Secullum:\n${err.message}`, 'error');
                        }
                    } else {
                        throw new Error('FUNCION√ÅRIO n√£o encontrado em allEmployees');
                    }
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
                
            } catch (err) {
                console.error('? Erro ao enviar anexo:', err);
                alert(`? Erro ao enviar anexo:\n${err.message}`);
            } finally {
                // ? Sempre resetar bot√£oo (sucesso ou erro)
                btn.disabled = false;
                btn.textContent = 'Confirmar Anexo';
            }
        }
        
        // Enviar Hor√°rios OCR para Secullum (quando Usu√°rio clica no checkbox verde)
        async function enviarParaSecullum(empRef, autoEnvio = false) {
            console.log(`?? Enviando Hor√°rios para Secullum: REG=${empRef.reg}, Data=${empRef.date}`);
            
            if (!empRef) {
                alert('? Erro: FUNCION√ÅRIO n√£o encontrado!');
                return;
            }
            
            // Se for inverS√≥o (pendingSwap), mostrar popup de confirma√ß√£o
            if (empRef.pendingSwap && !autoEnvio) {
                if (!confirm(`? Confirmar envio para Secullum?\n\nFUNCION√ÅRIO: ${empRef.name}\nData: ${empRef.date}\n\nHor√°rios:\n` +
                             `Ent1: ${empRef.punches?.ent1 || '--:--'} | Sai1: ${empRef.punches?.sai1 || '--:--'}\n` +
                             `Ent2: ${empRef.punches?.ent2 || '--:--'} | Sai2: ${empRef.punches?.sai2 || '--:--'}\n` +
                             `Ent3: ${empRef.punches?.ent3 || '--:--'} | Sai3: ${empRef.punches?.sai3 || '--:--'}`)) {
                    return;
                }
            }
            
            showLoading('Enviando para Secullum...');
            
            try {
                let sucessos = 0;
                let erros = 0;
                let periodoEncerrado = false;
                
                // Se h√° invers√µes/movimenta√ß√µes pendentes, usar endpoint de TROCA
                if (empRef.pendingSwap || empRef.movedPunches) {
                    console.log('üîÑ Enviando TROCA de hor√°rios para Secullum...');
                    
                    const numeroFolha = empRef.rawData?.Funcionario?.NumeroFolha || empRef.NumeroFolha;
                    
                    if (!numeroFolha) {
                        throw new Error('NumeroFolha n√£o encontrado!');
                    }
                    
                    // Pegar informa√ß√µes da troca (√∫ltima movimenta√ß√£o)
                    const trocas = empRef.movedPunches || empRef.swappedPunches || [];
                    
                    if (trocas.length === 0) {
                        console.warn('‚ö†Ô∏è Nenhuma troca registrada, pulando envio');
                        hideLoading();
                        return;
                    }
                    
                    // Enviar cada troca individualmente
                    for (const troca of trocas) {
                        try {
                            // Mapear nome interno (ent1, sai1) para nome da API (Entrada1, Saida1)
                            const mapColuna = (punch) => {
                                const map = {
                                    'ent1': 'Entrada1', 'sai1': 'Saida1',
                                    'ent2': 'Entrada2', 'sai2': 'Saida2',
                                    'ent3': 'Entrada3', 'sai3': 'Saida3',
                                    'ent4': 'Entrada4', 'sai4': 'Saida4',
                                    'ent5': 'Entrada5', 'sai5': 'Saida5'
                                };
                                return map[punch] || punch;
                            };
                            
                            const colunaOrigem = mapColuna(troca.from || troca.punch1);
                            const colunaDestino = mapColuna(troca.to || troca.punch2);
                            
                            const payload = {
                                NumeroFolha: numeroFolha,
                                Data: empRef.rawData?.Data || empRef.date,
                                ColunaOrigem: colunaOrigem,
                                ColunaDestino: colunaDestino
                            };
                            
                            console.log(`üîÑ Trocando ${colunaOrigem} ‚Üî ${colunaDestino}`);
                            console.log('üì¶ Payload:', payload);
                            
                            const apiResponse = await fetch(`${API_CONFIG.baseURL}/IntegracaoExterna/CartaoPonto/Troca`, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${API_CONFIG.token}`,
                                    'secullumidbancoselecionado': empRef.empresaId || empRef.companyId
                                },
                                body: JSON.stringify(payload)
                            });
                            
                            if (apiResponse.ok) {
                                sucessos++;
                                console.log(`‚úÖ Troca realizada: ${colunaOrigem} ‚Üî ${colunaDestino}`);
                            } else {
                                erros++;
                                const errorText = await apiResponse.text();
                                console.error(`‚ùå Erro ao trocar: ${apiResponse.status} - ${errorText}`);
                            }
                            
                        } catch (err) {
                            erros++;
                            console.error(`‚ùå Erro ao enviar troca:`, err);
                        }
                    }
                    
                    // Limpar flags
                    empRef.swappedPunches = [];
                    empRef.pendingSwap = false;
                    
                } else {
                    // Envio normal (OCR)
                    console.log('?? Verificando Hor√°rios para envio...');
                    console.log('   empRef.ent1:', empRef.ent1);
                    console.log('   empRef.punches.ent1:', empRef.punches?.ent1);
                    console.log('   empRef.sai1:', empRef.sai1);
                    console.log('   empRef.punches.sai1:', empRef.punches?.sai1);
                    
                    const horariosParaEnviar = [
                        { coluna: 'Entrada1', hora: empRef.punches?.ent1 || empRef.ent1 },
                        { coluna: 'Saida1', hora: empRef.punches?.sai1 || empRef.sai1 },
                        { coluna: 'Entrada2', hora: empRef.punches?.ent2 || empRef.ent2 },
                        { coluna: 'Saida2', hora: empRef.punches?.sai2 || empRef.sai2 },
                        { coluna: 'Entrada3', hora: empRef.punches?.ent3 || empRef.ent3 },
                        { coluna: 'Saida3', hora: empRef.punches?.sai3 || empRef.sai3 }
                    ].filter(item => item.hora);
                    
                    const funcionarioId = empRef.rawData?.FuncionarioId || empRef.dadosCompletos?.FuncionarioId;
                    const numeroFolha = empRef.rawData?.Funcionario?.NumeroFolha || empRef.NumeroFolha;
                    
                    if (!funcionarioId) {
                        throw new Error('FuncionarioId n√£o encontrado!');
                    }
                    
                    if (!numeroFolha) {
                        throw new Error('NumeroFolha n√£o encontrado!');
                    }
                    
                    // ‚ö° PARALELIZA√á√ÉO: Enviar TODOS os hor√°rios simultaneamente
                    const promises = horariosParaEnviar.map(async (item) => {
                        try {
                            const payload = {
                                FuncionarioId: funcionarioId,
                                NumeroFolha: numeroFolha,
                                Data: empRef.rawData?.Data || empRef.date,
                                Coluna: item.coluna,
                                Hora: item.hora,
                                Motivo: empRef.motivo || 'Justificativa anexada via OCR',
                                created_by: window.CURRENT_USER || 'Sistema'
                            };
                            
                            const apiResponse = await fetch(`${API_CONFIG.baseURL}/IntegracaoExterna/CartaoPonto/Manual`, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${API_CONFIG.token}`,
                                    'secullumidbancoselecionado': empRef.empresaId || empRef.companyId
                                },
                                body: JSON.stringify(payload)
                            });
                            
                            if (apiResponse.ok) {
                                console.log(`‚úÖ ${item.coluna} enviada: ${item.hora}`);
                                return { success: true, coluna: item.coluna };
                            } else {
                                const errorText = await apiResponse.text();
                                console.warn(`‚ö†Ô∏è Erro ao enviar ${item.coluna}: ${apiResponse.status} - ${errorText}`);
                                return { 
                                    success: false, 
                                    coluna: item.coluna, 
                                    error: errorText,
                                    periodoEncerrado: errorText.includes('Per√≠odo encerrado') || errorText.includes('Per√≠odo fechado')
                                };
                            }
                        } catch (err) {
                            console.error(`‚ùå Erro ao enviar ${item.coluna}:`, err);
                            return { success: false, coluna: item.coluna, error: err.message };
                        }
                    });
                    
                    const results = await Promise.all(promises);
                    
                    sucessos = results.filter(r => r.success).length;
                    erros = results.filter(r => !r.success).length;
                    periodoEncerrado = results.some(r => r.periodoEncerrado);
                    
                    // ‚úÖ INVALIDA√á√ÉO CIR√öRGICA: Se teve sucesso, recarregar funcion√°rio
                    if (sucessos > 0) {
                        console.log('‚ö° Invalidando cache ap√≥s envio...');
                        await invalidateSingleEmployee(empRef.reg, empRef.date, empRef.empresaId || empRef.companyId);
                    }
                    
                    // Remover flag pendingOCR
                    empRef.pendingOCR = false;
                }
                
                hideLoading();
                
                // Recarregar dados
                await searchPeriod();
                
                let mensagem = `?? Envio conclu√ß√£do:\n? ${sucessos} Hor√°rios enviados\n? ${erros} erros`;
                
                if (periodoEncerrado) {
                    mensagem += `\n\n?? ATEn√£oO: Per√≠odo encerrado!\nEntre em contato com o RH.`;
                }
                
                alert(mensagem);
                
            } catch (err) {
                hideLoading();
                console.error('? Erro ao enviar para Secullum:', err);
                alert(`? Erro: ${err.message}`);
            }
        }
        
        // Remover anexo
        async function removeAttachment(reg, date) {
            if (!confirm('?? Deseja realmente remover o anexo?')) return;
            
            try {
                const employee = allEmployees.find(emp => emp.reg === reg);
                if (!employee) return;
                
                // Buscar ID do anexo no SQL
                const response = await fetch(`${API_BASE_URL}/api/anexos/${reg}/${employee.rawData?.Data || date}`, {
                    headers: getAuthHeaders()
                });
                const anexo = await response.json();
                
                if (!anexo || anexo.error) {
                    throw new Error('Anexo n√£o encontrado no servidor');
                }
                
                // Deletar do servidor
                const deleteResponse = await fetch(`${API_BASE_URL}/api/anexos/${anexo.id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const result = await deleteResponse.json();
                
                if (result.success) {
                    employee.anexoUrl = null;
                    employee.attachments = [];
                    employee.motivo = '';
                    
                    renderTable();
                    alert('? Anexo removido com sucesso!');
                } else {
                    throw new Error(result.error || 'Erro ao deletar');
                }
                
            } catch (err) {
                console.error('? Erro ao remover anexo:', err);
                alert(`? Erro ao remover anexo:\n${err.message}`);
            }
        }

        // Remover anexo (verS√≥o antiga - manter compatibilidade)
        function simulateOCR(filename) {
            return { time: '--:--', reason: 'Arquivo: ' + filename };
        }

        // Gerar formul√©rio para um empregado
        // Gerar slots de Hor√°rio SEMPRE com 4 batidas (2 entradas + 2 SA√çdas)
        function generateTimeSlots(punches, questions = {}) {
            let html = '';
            
            // Coletar TODAS as batidas (entrada e SA√çda) em ordem com seus tipos
            const todasBatidas = [
                { time: punches.ent1, type: 'ent1', label: 'Entrada 1' },
                { time: punches.sai1, type: 'sai1', label: 'SA√çda 1' },
                { time: punches.ent2, type: 'ent2', label: 'Entrada 2' },
                { time: punches.sai2, type: 'sai2', label: 'SA√çda 2' },
                { time: punches.ent3, type: 'ent3', label: 'Entrada 3' },
                { time: punches.sai3, type: 'sai3', label: 'SA√çda 3' },
                { time: punches.ent4, type: 'ent4', label: 'Entrada 4' },
                { time: punches.sai4, type: 'sai4', label: 'SA√çda 4' },
                { time: punches.ent5, type: 'ent5', label: 'Entrada 5' },
                { time: punches.sai5, type: 'sai5', label: 'SA√çda 5' }
            ].filter(p => p.time && p.time !== '--:--');
            
            const totalBatidas = todasBatidas.length;
            
            // Se tiver batidas √£mpares (5, 7, 9...), adicionar um slot vazio para justificar
            const totalSlots = (totalBatidas % 2 === 1) ? totalBatidas + 1 : Math.max(totalBatidas, 4);
            
            // Gerar slots para todas as batidas reais
            for (let i = 0; i < totalBatidas; i++) {
                const question = questions[todasBatidas[i].type];
                html += generateTimeSlot(todasBatidas[i].time, todasBatidas[i].label, question);
            }
            
            // Se for √£mpar, adicionar slot vazio para justificar o par
            if (totalBatidas % 2 === 1) {
                html += generateTimeSlot(null, null, null);
            }
            
            // Se tiver menos de 4 batidas (e for par), preencher at√© 4
            const slotsGerados = (totalBatidas % 2 === 1) ? totalBatidas + 1 : totalBatidas;
            if (slotsGerados < 4) {
                for (let i = slotsGerados; i < 4; i++) {
                    html += generateTimeSlot(null, null, null);
                }
            }
            
            return html;
        }

        function generateForm(emp, index, total) {
            return `
                <div class="form-page">
                    <div class="form-border">
                        <div class="form-header">
                            <div class="form-logo">
                                <div class="logo-circle">L</div>
                                <div class="logo-text">LARSIL</div>
                            </div>
                            <div class="form-title">PONTO MANUAL COMPLEMENTAR AO PONTO ELETR√∫nico</div>
                        </div>
                        
                        <div class="form-orientation">
                            <strong>Orienta√ß√£o:</strong> Preencha somente os Hor√°rios que n√£o conseguiu bater e marque a justificativa
                        </div>
                        
                        <div class="form-employee-data">
                            <div class="form-row">
                                <div class="form-field">
                                    <span class="form-field-label">Nome:</span>
                                    <span class="form-field-value" style="font-size: 18px;">${emp.name}</span>
                                </div>
                                <div class="form-field">
                                    <span class="form-field-label">Cidade:</span>
                                    <span class="form-field-value">${emp.city}</span>
                                </div>
                                <div class="form-field">
                                    <span class="form-field-label">Data:</span>
                                    <span class="form-field-value">${emp.date}</span>
                                </div>
                            </div>
                            <div class="form-row-2">
                                <div class="form-field">
                                    <span class="form-field-label">REG:</span>
                                    <span class="form-field-value">${emp.reg}</span>
                                </div>
                                <div class="form-field">
                                    <span class="form-field-label">Projeto:</span>
                                    <span class="form-field-value">${emp.projeto || 'N/A'}</span>
                                </div>
                                <div class="form-field">
                                    <span class="form-field-label">ID IMP:</span>
                                    <span class="form-field-value">${index}</span>
                                </div>
                            </div>
                            <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">(${emp.day})</div>
                        </div>
                        
                        <div class="section-header">Hor√°rioS (preencher somente os que faltaram)</div>
                        
                        <div class="form-times">
                            <div class="times-grid">
                                ${generateTimeSlots(emp.punches, emp.questions || {})}
                            </div>
                        </div>
                        
                        <div class="section-header">JUSTIFICATIVA (marque o motivo)</div>
                        
                        <div class="form-justification">
                            <div class="justification-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div class="checkbox-item">
                                    <input type="radio" name="motivo-${emp.reg}" style="width: 18px; height: 18px; min-width: 18px; min-height: 18px;">
                                    <label>Esqueceu de registrar o Ponto</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="motivo-${emp.reg}" style="width: 18px; height: 18px; min-width: 18px; min-height: 18px;">
                                    <label>Falha no App</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="motivo-${emp.reg}" style="width: 18px; height: 18px; min-width: 18px; min-height: 18px;">
                                    <label>Falta</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="motivo-${emp.reg}" style="width: 18px; height: 18px; min-width: 18px; min-height: 18px;">
                                    <label>Folga</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="motivo-${emp.reg}" style="width: 18px; height: 18px; min-width: 18px; min-height: 18px;">
                                    <label>Hora Parada</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="motivo-${emp.reg}" style="width: 18px; height: 18px; min-width: 18px; min-height: 18px;">
                                    <label>Maquina Ponto com defeito</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="motivo-${emp.reg}" style="width: 18px; height: 18px; min-width: 18px; min-height: 18px;">
                                    <label>Registro em duplicidade</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="motivo-${emp.reg}" style="width: 18px; height: 18px; min-width: 18px; min-height: 18px;">
                                    <label>Registro indevido</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-signatures">
                            <div class="signature-box left">
                                <div class="signature-space"></div>
                                <div class="signature-line">
                                    <div class="signature-name">${emp.name}</div>
                                    <div class="signature-label">Assinatura do FUNCION√ÅRIO</div>
                                </div>
                            </div>
                            <div class="signature-box right">
                                ${useDigitalSignature ? `
                                    <div class="digital-signature">Fabio Oliveira</div>
                                    <div class="signature-line">
                                        <div class="signature-name">FABIO OLIVEIRA</div>
                                        <div class="signature-label">Assinatura digital do L√≠der</div>
                                    </div>
                                ` : `
                                    <div class="signature-space"></div>
                                    <div class="signature-line">
                                        <div class="signature-name">${emp.nomeLider || 'L√≠der n√£o INFORMADO'}</div>
                                        <div class="signature-label">Assinatura do L√≠der</div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    <div class="form-footer">SECULLUM √£ 4573.1197</div>
                </div>
            `;
        }

        function generateTimeSlot(time, label = null, question = null) {
            if (time) {
                return `
                    <div class="time-slot" style="position: relative;">
                        ${question ? `
                            <div style="position: absolute; top: -8px; left: 0; right: 0; background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); padding: 4px 6px; border-radius: 6px 6px 0 0; font-size: 9px; font-weight: 600; text-align: left; box-shadow: 0 2px 4px rgba(251, 146, 60, 0.3); color: #1f2937;">
                                <span style="font-weight: 700;">RH:</span> ${question}
                            </div>
                        ` : ''}
                        <div class="time-value present" style="${question ? 'margin-top: 12px;' : ''}">${time}</div>
                        <div class="time-status batido">BATIDO</div>
                        <div style="margin-top: 3px; font-size: 10px; display: flex; align-items: center;">
                            <input type="checkbox" id="anular_${time.replace(':', '')}" style="margin-right: 5px; width: 14px; height: 14px;">
                            <label for="anular_${time.replace(':', '')}" style="margin: 0; font-weight: normal;">ANULAR BATIDA</label>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="time-slot">
                        <div style="font-weight: 900; font-size: 14px; color: #000; margin-bottom: 8px; text-align: center; letter-spacing: 1px;">
                            ${label || 'Hor√°rio'}
                        </div>
                        <div class="time-value missing">__:__</div>
                    </div>
                `;
            }
        }

        // Event Listeners
        document.getElementById('btnFilter').addEventListener('click', () => {
            showOnlyInconsistencies = !showOnlyInconsistencies;
            const btn = document.getElementById('btnFilter');
            const text = document.getElementById('filterText');
            
            if (showOnlyInconsistencies) {
                btn.classList.add('active');
                text.textContent = 'Mostrando S√≥ Inconsist√™ncias';
            } else {
                btn.classList.remove('active');
                text.textContent = 'Mostrar S√≥ Inconsist√™ncias';
            }
            
            renderTable();
        });

        // ==========================================
        // SISTEMA DE PERGUNTAS
        // ==========================================
        let currentQuestionContext = null;

        // ?? CORRE√ß√£√£O: Salvar perguntas no banco de dados (com merge de dados existentes)
        async function saveQuestionsToDB(employee, dateContext) {
            try {
                let dataFormatted = employee.anexoDate || dateContext;
                if (dataFormatted.includes('/')) {
                    const parts = dataFormatted.split('/');
                    dataFormatted = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                } else if (dataFormatted.includes('T')) {
                    dataFormatted = dataFormatted.split('T')[0];
                }
                
                console.log(`?? Salvando perguntas: ${employee.name} (${dataFormatted})`);
                
                // ?? 1. BUSCAR dados existentes primeiro
                let existingData = {};
                try {
                    const fetchResponse = await fetch(
                        `${API_BASE_URL}/api/anexos/${dataFormatted}/${employee.empresaId || employee.rawData?.Empresa || 0}`,
                        { headers: getAuthHeaders() }
                    );
                    
                    if (fetchResponse.ok) {
                        const anexos = await fetchResponse.json();
                        const anexoExistente = anexos.find(a => 
                            a.cpf?.replace(/\D/g, '') === employee.cpf?.replace(/\D/g, '')
                        );
                        if (anexoExistente?.perguntas_rh) {
                            existingData = JSON.parse(anexoExistente.perguntas_rh);
                            console.log(`?? Dados existentes:`, existingData);
                        }
                    }
                } catch (err) {
                    console.warn('?? n√£o foi posS√≥vel buscar dados existentes');
                }
                
                // ?? 2. MESCLAR dados antigos + novos
                const mergedData = {
                    ...existingData,
                    ...employee.questions,
                    ...employee.approved
                };
                
                console.log(`?? Dados mesclados a salvar:`, mergedData);
                
                // ?? 3. SALVAR
                const response = await fetch(
                    `${API_BASE_URL}/api/anexos/${employee.cpf}/${dataFormatted}/questions`,
                    {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            perguntas_rh: JSON.stringify(mergedData),
                            reg: employee.reg,
                            empresa_id: employee.empresaId || employee.rawData?.Empresa || 0,
                            empresa_nome: employee.city || employee.rawData?.['Empresa Nome'] || 'N/A',
                            funcionario_nome: employee.name || 'N/A'
                        })
                    }
                );
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                console.log('? Perguntas salvas com sucesso');
                
            } catch (err) {
                console.error('? Erro ao salvar perguntas:', err);
                showAlert('Erro', `n√£o foi posS√≥vel salvar: ${err.message}`, 'error');
            }
        }

        // Salvar aprova√ß√£o de Hor√°rio trocado no banco
        async function saveApprovalToDB(employee, dateContext, punchType, approvalComment) {
            try {
                // Mesma l√©gica de formata√ß√£o de data
                let dataFormatted = null;
                
                if (employee.anexoDate) {
                    dataFormatted = employee.anexoDate;
                } else if (dateContext) {
                    if (dateContext.includes('/')) {
                        const parts = dateContext.split('/');
                        dataFormatted = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    } else {
                        dataFormatted = dateContext.split('T')[0];
                    }
                } else {
                    dataFormatted = employee.rawData?.Data 
                        ? employee.rawData.Data.split('T')[0] 
                        : employee.date.split('T')[0];
                }
                
                console.log(`? Salvando aprova√ß√£o: ${employee.name} (CPF: ${employee.cpf}, Data: ${dataFormatted}, ${punchType})`);
                
                // ?? BUSCAR DADOS EXISTENTES DO BANCO PRIMEIRO
                let existingData = {};
                try {
                    const fetchResponse = await fetch(`${API_BASE_URL}/api/anexos/${dataFormatted}/${employee.rawData?.Empresa || 0}`, {
                        headers: getAuthHeaders()
                    });
                    if (fetchResponse.ok) {
                        const anexos = await fetchResponse.json();
                        const anexoExistente = anexos.find(a => 
                            a.cpf?.replace(/\D/g, '') === employee.cpf?.replace(/\D/g, '')
                        );
                        if (anexoExistente && anexoExistente.perguntas_rh) {
                            existingData = JSON.parse(anexoExistente.perguntas_rh);
                            console.log(`?? Dados existentes encontrados:`, existingData);
                        }
                    }
                } catch (err) {
                    console.warn(`?? n√£o foi posS√≥vel buscar dados existentes:`, err);
                }
                
                // Mesclar TUDO: dados existentes + questions atuais + nova aprova√ß√£o
                const approvedKey = `${punchType}_approved`;
                const mergedData = {
                    ...existingData,           // 1. Dados que j√° estavam no banco
                    ...employee.questions,     // 2. Perguntas atuais do objeto
                    ...employee.approved,      // 3. Aprova√ß√£es atuais do objeto
                    [approvedKey]: approvalComment  // 4. Nova aprova√ß√£o
                };
                
                console.log(`?? Dados a salvar (mesclados):`, mergedData);
                
                const response = await fetch(`${API_BASE_URL}/api/anexos/${employee.cpf}/${dataFormatted}/questions`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        perguntas_rh: JSON.stringify(mergedData),
                        reg: employee.reg,
                        empresa_id: employee.rawData?.Empresa || 0,
                        empresa_nome: employee.rawData?.['Empresa Nome'] || 'N/A',
                        funcionario_nome: employee.name || 'N/A'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log(`? Aprova√ß√£o salva:`, result);
                showAlert('Sucesso', `Hor√°rio ${punchType} aprovado para ${employee.name}!`, 'success');
                
            } catch (err) {
                console.error('? Erro ao salvar aprova√ß√£o:', err);
                showAlert('Erro', `n√£o foi posS√≥vel salvar a aprova√ß√£o: ${err.message}`, 'error');
            }
        }

        function askQuestion(event, reg, date, punchType, name) {
            event.stopPropagation(); // Evitar duplo clique na c√ß√£lula
            
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee) return;

            const punchTime = employee.punches[punchType] || '--:--';
            const punchLabel = {
                'ent1': 'Entrada 1',
                'sai1': 'SA√çda 1',
                'ent2': 'Entrada 2',
                'sai2': 'SA√çda 2',
                'ent3': 'Entrada 3',
                'sai3': 'SA√çda 3',
                'ent4': 'Entrada 4',
                'sai4': 'SA√çda 4',
                'ent5': 'Entrada 5',
                'sai5': 'SA√çda 5'
            }[punchType];

            // Armazenar contexto
            currentQuestionContext = { reg, date, punchType };

            // Atualizar modal
            document.getElementById('questionContext').textContent = 
                `${name} - ${punchLabel}: ${punchTime} (${date})`;
            
            // Limpar input anterior
            document.getElementById('questionInput').value = employee.questions?.[punchType] || '';

            // Mostrar modal
            document.getElementById('questionModal').classList.add('active');
            document.getElementById('questionInput').focus();
        }

        // bot√£oo OK do modal
        document.getElementById('questionOkBtn').addEventListener('click', async () => {
            const question = document.getElementById('questionInput').value.trim();
            
            if (!question) {
                const msgType = currentQuestionContext?.isApproval ? 'motivo da aprova√ß√£o' : 'pergunta';
                showAlert('Aten√£oo', `Digite ${msgType} antes de confirmar!`, 'warning');
                return;
            }

            if (currentQuestionContext) {
                const { reg, date, punchType, isApproval } = currentQuestionContext;
                
                console.log(`?? Buscando FUNCION√ÅRIO: REG=${reg}, Data=${date}`);
                
                // ?? Buscar FUNCION√ÅRIO pela DATA E REG (n√£o importa se tem anexo ou n√£o)
                // Se tiver anexo, vai salvar. Se n√£o tiver, vai avisar.
                let employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
                
                if (!employee) {
                    console.warn(`?? FUNCION√ÅRIO n√£o encontrado: REG=${reg}, Data=${date}`);
                    showAlert('Erro', 'FUNCION√ÅRIO n√£o encontrado para esta data.', 'error');
                    return;
                }
                
                console.log(`? FUNCION√ÅRIO encontrado: ${employee.name} - Data: ${employee.date} - Anexo: ${employee.anexoUrl ? 'SIM' : 'n√£o'}`);
                
                if (employee) {
                    if (isApproval) {
                        // ? APROVa√ß√£O DE Hor√°rio TROCADO
                        if (!employee.approved) {
                            employee.approved = {};
                        }
                        employee.approved[punchType] = question;
                        console.log(`? Hor√°rio aprovado: ${employee.name} - ${punchType} - "${question}"`);
                        
                        // Salvar aprova√ß√£o no banco (aguardar para atualizar tabela depois)
                        await saveApprovalToDB(employee, date, punchType, question);
                    } else {
                        // ? PERGUNTA NORMAL DO RH
                        if (!employee.questions) {
                            employee.questions = {};
                        }
                        employee.questions[punchType] = question;
                        console.log(`? Pergunta adicionada: ${employee.name} - ${punchType} - "${question}"`);
                        
                        // Salvar pergunta no banco
                        await saveQuestionsToDB(employee, date);
                    }
                    
                    // Fechar modal
                    document.getElementById('questionModal').classList.remove('active');
                    
                    // Atualizar tabela (agora com dados salvos)
                    renderTable();
                }
            }
        });

        // bot√£oo Cancelar do modal
        document.getElementById('questionCancelBtn').addEventListener('click', () => {
            document.getElementById('questionModal').classList.remove('active');
        });

        // Fechar modal ao clicar fora
        document.getElementById('questionModal').addEventListener('click', (e) => {
            if (e.target.id === 'questionModal') {
                document.getElementById('questionModal').classList.remove('active');
            }
        });

        // ==========================================
        // APROVa√ß√£O DE Hor√°rioS TROCADOS
        // ==========================================
        function approveSwappedTime(event, reg, date, punchType, name) {
            event.stopPropagation();
            
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee) return;

            const punchTime = employee.punches[punchType] || '--:--';
            const punchLabel = {
                'ent1': 'Entrada 1',
                'sai1': 'SA√çda 1',
                'ent2': 'Entrada 2',
                'sai2': 'SA√çda 2',
                'ent3': 'Entrada 3',
                'sai3': 'SA√çda 3',
                'ent4': 'Entrada 4',
                'sai4': 'SA√çda 4',
                'ent5': 'Entrada 5',
                'sai5': 'SA√çda 5'
            }[punchType];

            // Armazenar contexto
            currentQuestionContext = { reg, date, punchType, isApproval: true };

            // Atualizar modal com mensagem de aprova√ß√£o
            document.getElementById('questionContext').textContent = 
                `?? APROVAR Hor√°rio TROCADO\n${name} - ${punchLabel}: ${punchTime} (${date})`;
            
            // Limpar input
            document.getElementById('questionInput').value = '';
            document.getElementById('questionInput').placeholder = 'Digite o motivo da aprova√ß√£o (ex: "Troca autorizada com colega")';

            // Mostrar modal
            document.getElementById('questionModal').classList.add('active');
            document.getElementById('questionInput').focus();
        }

        // Vari√ß√£vel global para rastrear c√ß√£lula selecionada
        let selectedCell = null;

        // ============================================
        // TAREFA 7: MOVIMENTA√á√ÉO LIVRE DE HOR√ÅRIOS
        // Sistema de drag-and-drop para mover hor√°rios livremente
        // ============================================
        let draggedCell = null;
        let draggedData = null;
        let sendToSecullumTimer = null; // Timer para debounce de 2s

        // Configurar drag-and-drop nas c√©lulas de hor√°rio
        function setupDragAndDrop() {
            document.querySelectorAll('.punch-cell').forEach(cell => {
                // Permitir arrastar se tiver hor√°rio
                const reg = cell.dataset.reg;
                const date = cell.dataset.date;
                const punch = cell.dataset.punch;
                const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
                
                if (employee && employee.punches[punch] && employee.punches[punch] !== '--:--') {
                    cell.draggable = true;
                    cell.style.cursor = 'grab';
                } else {
                    cell.draggable = false;
                }

                // Evento: COME√áOU A ARRASTAR
                cell.addEventListener('dragstart', (e) => {
                    const punch = cell.dataset.punch;
                    const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
                    
                    if (!employee || !employee.punches[punch] || employee.punches[punch] === '--:--') {
                        e.preventDefault();
                        return;
                    }

                    draggedCell = cell;
                    draggedData = {
                        reg: cell.dataset.reg,
                        date: cell.dataset.date,
                        punch: cell.dataset.punch,
                        name: cell.dataset.name,
                        time: employee.punches[punch]
                    };

                    cell.style.opacity = '0.5';
                    cell.style.cursor = 'grabbing';
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', punch);
                });

                // Evento: TERMINOU DE ARRASTAR
                cell.addEventListener('dragend', (e) => {
                    if (draggedCell) {
                        draggedCell.style.opacity = '1';
                        draggedCell.style.cursor = 'grab';
                    }
                    draggedCell = null;
                    draggedData = null;
                    
                    // Remover destaque de todas as c√©lulas
                    document.querySelectorAll('.punch-cell').forEach(c => {
                        c.classList.remove('drag-over');
                    });
                });

                // Evento: PASSOU POR CIMA (arrastrando)
                cell.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Permitir drop
                    
                    // Verificar se √© da mesma linha
                    if (draggedData && cell.dataset.reg === draggedData.reg && cell.dataset.date === draggedData.date) {
                        e.dataTransfer.dropEffect = 'move';
                        cell.classList.add('drag-over');
                    }
                });

                // Evento: SAIU DE CIMA
                cell.addEventListener('dragleave', (e) => {
                    cell.classList.remove('drag-over');
                });

                // Evento: SOLTOU (DROP)
                cell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    cell.classList.remove('drag-over');
                    
                    if (!draggedData || !draggedCell) return;
                    
                    // Verificar se √© da mesma linha
                    if (cell.dataset.reg !== draggedData.reg || cell.dataset.date !== draggedData.date) {
                        showAlert('Erro', 'S√≥ √© poss√≠vel mover hor√°rios na mesma linha (mesmo funcion√°rio/data)', 'warning');
                        return;
                    }

                    // N√£o fazer nada se soltou na mesma c√©lula
                    if (cell === draggedCell) return;

                    const targetPunch = cell.dataset.punch;
                    const sourcePunch = draggedData.punch;

                    // Executar movimento
                    movePunchToSlot(draggedData.reg, draggedData.date, sourcePunch, targetPunch, draggedData.name);
                });
            });
        }

        // TAREFA 7: Mover hor√°rio para outro slot (n√£o trocar, mover)
        function movePunchToSlot(reg, date, sourcePunch, targetPunch, name) {
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee) {
                showAlert('Erro', 'Funcion√°rio n√£o encontrado!', 'error');
                return;
            }

            const sourceTime = employee.punches[sourcePunch] || '--:--';
            const targetTime = employee.punches[targetPunch] || '--:--';

            const punchLabels = {
                'ent1': 'Entrada 1', 'sai1': 'Sa√≠da 1',
                'ent2': 'Entrada 2', 'sai2': 'Sa√≠da 2',
                'ent3': 'Entrada 3', 'sai3': 'Sa√≠da 3',
                'ent4': 'Entrada 4', 'sai4': 'Sa√≠da 4',
                'ent5': 'Entrada 5', 'sai5': 'Sa√≠da 5'
            };

            const confirmed = confirm(
                `üîÑ MOVER HOR√ÅRIO?\n\n` +
                `Funcion√°rio: ${name}\n` +
                `Data: ${date}\n\n` +
                `De: ${punchLabels[sourcePunch]} (${sourceTime})\n` +
                `Para: ${punchLabels[targetPunch]} (${targetTime})\n\n` +
                `‚è±Ô∏è Ser√° enviado para Secullum em 2 segundos (debounce)`
            );

            if (!confirmed) return;

            // MOVER hor√°rio (n√£o trocar)
            employee.punches[targetPunch] = sourceTime; // Coloca hor√°rio no destino
            employee.punches[sourcePunch] = '--:--';    // Limpa origem

            // Marcar como pendente de envio
            employee.pendingSwap = true;
            
            // Guardar informa√ß√µeses da movimenta√ß√£o
            if (!employee.movedPunches) {
                employee.movedPunches = [];
            }
            employee.movedPunches.push({
                from: sourcePunch,
                to: targetPunch,
                time: sourceTime,
                timestamp: new Date()
            });

            // Atualizar tabela visualmente
            renderTable();

            // DEBOUNCE: Aguardar 2 segundos antes de enviar para Secullum
            if (sendToSecullumTimer) {
                clearTimeout(sendToSecullumTimer);
                console.log('‚è±Ô∏è Timer cancelado - nova movimenta√ß√£o detectada');
            }

            sendToSecullumTimer = setTimeout(async () => {
                // Mostrar popup de loading
                showAlert('Aguarde', 'üîÑ Enviando hor√°rio para Secullum...', 'info');
                
                try {
                    await enviarParaSecullum(employee);
                    showAlert('Sucesso', `‚úÖ Hor√°rio enviado!\n${punchLabels[sourcePunch]} ‚Üí ${punchLabels[targetPunch]}`, 'success');
                    // Atualizar dados automaticamente
                    await buscarColaboradores();
                } catch (error) {
                    console.error('Erro ao enviar para Secullum:', error);
                    showAlert('Erro', `‚ùå Erro ao enviar:\n${error.message}`, 'error');
                }
                sendToSecullumTimer = null;
            }, 1000); // 1 segundo (otimizado)
        }

        // Mostrar setas de navega√ß√£o ao clicar na c√ß√£lula (igual Secullum)
        function showSwapMenu(event, cell) {
            event.stopPropagation();
            
            // Remover setas antigas
            document.querySelectorAll('.swap-arrow').forEach(arrow => arrow.remove());
            
            const reg = cell.dataset.reg;
            const date = cell.dataset.date;
            const punch = cell.dataset.punch;
            const name = cell.dataset.name;
            
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee || !employee.punches[punch]) return;
            
            // Se j√° est√© selecionada, desselecionar
            if (selectedCell === cell) {
                cell.classList.remove('selected-cell');
                selectedCell = null;
                return;
            }
            
            // Remover sele√ß√£o√£o anterior
            if (selectedCell) {
                selectedCell.classList.remove('selected-cell');
            }
            
            // Marcar c√ß√£lula como selecionada
            cell.classList.add('selected-cell');
            selectedCell = cell;
            
            // Adicionar seta em TODAS as outras c√©lulas com Hor√°rio da MESMA LINHA
            const rowCells = document.querySelectorAll(`.punch-cell[data-reg="${reg}"][data-date="${date}"]`);
            
            rowCells.forEach(targetCell => {
                const targetPunch = targetCell.dataset.punch;
                
                // Ignorar a pr√ß√£pria c√ß√£lula
                if (targetCell === cell) return;
                
                // Verificar se tem Hor√°rio
                if (!employee.punches[targetPunch] || employee.punches[targetPunch] === '--:--') return;
                
                // Adicionar seta √£nica no canto
                const arrow = document.createElement('span');
                arrow.className = 'swap-arrow';
                arrow.textContent = '?';
                arrow.title = 'Trocar Hor√°rios';
                arrow.onclick = (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.swap-arrow').forEach(a => a.remove());
                    cell.classList.remove('selected-cell');
                    selectedCell = null;
                    swapPunches(e, reg, date, punch, targetPunch, name);
                };
                
                targetCell.appendChild(arrow);
            });
            
            // Remover setas ao clicar fora
            setTimeout(() => {
                function closeArrows(e) {
                    if (!e.target.closest('.punch-cell') && !e.target.classList.contains('swap-arrow')) {
                        document.querySelectorAll('.swap-arrow').forEach(arrow => arrow.remove());
                        if (selectedCell) {
                            selectedCell.classList.remove('selected-cell');
                            selectedCell = null;
                        }
                        document.removeEventListener('click', closeArrows);
                    }
                }
                document.addEventListener('click', closeArrows);
            }, 100);
        }
        
        // Inverter batidas LOCALMENTE (n√£o envia para API imediatamente)
        async function swapPunches(event, reg, date, punch1, punch2, name) {
            event.stopPropagation();
            
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee) {
                showAlert('Erro', 'FUNCION√ÅRIO n√£o encontrado!', 'error');
                return;
            }

            const punch1Label = {
                'ent1': 'Entrada 1', 'sai1': 'SA√çda 1',
                'ent2': 'Entrada 2', 'sai2': 'SA√çda 2',
                'ent3': 'Entrada 3', 'sai3': 'SA√çda 3',
                'ent4': 'Entrada 4', 'sai4': 'SA√çda 4',
                'ent5': 'Entrada 5', 'sai5': 'SA√çda 5'
            }[punch1];

            const punch2Label = {
                'ent1': 'Entrada 1', 'sai1': 'SA√çda 1',
                'ent2': 'Entrada 2', 'sai2': 'SA√çda 2',
                'ent3': 'Entrada 3', 'sai3': 'SA√çda 3',
                'ent4': 'Entrada 4', 'sai4': 'SA√çda 4',
                'ent5': 'Entrada 5', 'sai5': 'SA√çda 5'
            }[punch2];

            const time1 = employee.punches[punch1] || '--:--';
            const time2 = employee.punches[punch2] || '--:--';

            const confirmed = confirm(
                `?? TEM CERTEZA QUE DESEJA INVERTER Hor√°rioS?\n\n` +
                `FUNCION√ÅRIO: ${name}\n` +
                `Data: ${date}\n\n` +
                `${punch1Label}: ${time1} ? ${time2}\n` +
                `${punch2Label}: ${time2} ? ${time1}\n\n` +
                `?? Esta a√ß√£o enviar√ß√£ IMEDIATAMENTE para Secullum!`
            );

            if (!confirmed) {
                // Limpar sele√ß√£o√£o
                document.querySelectorAll('.swap-arrow').forEach(arrow => arrow.remove());
                document.querySelectorAll('.selected-cell').forEach(cell => cell.classList.remove('selected-cell'));
                selectedCell = null;
                return;
            }

            try {
                // TROCAR OS Hor√°rioS LOCALMENTE
                const tempTime = employee.punches[punch1];
                employee.punches[punch1] = employee.punches[punch2];
                employee.punches[punch2] = tempTime;

                // Marcar como pendente de envio
                employee.pendingSwap = true;
                
                // Guardar informa√ß√µeses da troca
                if (!employee.swappedPunches) {
                    employee.swappedPunches = [];
                }
                employee.swappedPunches.push({
                    punch1,
                    punch2,
                    time1: employee.punches[punch1], // novo valor
                    time2: employee.punches[punch2]  // novo valor
                });

                // Limpar sele√ß√£o√£o
                document.querySelectorAll('.swap-arrow').forEach(arrow => arrow.remove());
                document.querySelectorAll('.selected-cell').forEach(cell => cell.classList.remove('selected-cell'));
                selectedCell = null;

                // Atualizar tabela visualmente
                renderTable();

                // ENVIAR IMEDIATAMENTE para Secullum
                await enviarParaSecullum(employee);

            } catch (error) {
                console.error('Erro ao inverter batidas:', error);
                showAlert(
                    'Erro ao Inverter',
                    `n√£o foi posS√≥vel inverter as batidas:\n\n${error.message}`,
                    'error'
                );
            }
        }

        // ==========================================
        // MONITOR DE m√©QUINAS DE PONTO
        // ==========================================
        function openMachineMonitor() {
            // Abrir monitor.html em nova guia
            window.open('monitor.html', '_blank');
        }

        // PAINEL DE PRESEN√ß√£A
        function openPresencePanel() {
            // Abrir presenca.html em nova guia
            window.open('presenca.html', '_blank');
        }

        function closeMachineMonitor() {
            document.getElementById('machineMonitorModal').classList.remove('active');
        }

        function logout() {
            // Limpar todos os dados do localStorage
            localStorage.clear();
            sessionStorage.clear();
            
            // Redirecionar para login
            window.location.href = '/login.html';
        }

        async function refreshMachineMonitor() {
            try {
                showLoading('Consultando m√©quinas de todas as empresas...');
                
                // Definir quais bancos consultar
                let bancosParaConsultar = [];
                
                if (API_CONFIG.selectedCompanies.includes('all')) {
                    // Se "TODAS" selecionado, busca de TODAS as empresas
                    bancosParaConsultar = API_CONFIG.companies.map(c => c.id);
                } else {
                    // Sen√£o, busca apenas das empresas selecionadas
                    bancosParaConsultar = API_CONFIG.selectedCompanies;
                }
                
                if (bancosParaConsultar.length === 0) {
                    alert('? Erro: Nenhuma empresa dispon√≠vel!\n\nFa√ß√£a login primeiro.');
                    hideLoading();
                    return;
                }
                
                // Buscar m√©quinas de todas as empresas em paralelo (SEM autentica√ß√£oO)
                const promises = bancosParaConsultar.map(bancoid => {
                    return fetch(`${API_BASE_URL}/api/machine-monitor?bancoid=${bancoid}`)
                        .then(async r => {
                            if (!r.ok) {
                                console.warn(`?? Erro ao consultar banco ${bancoid}: HTTP ${r.status}`);
                                return [];
                            }
                            return r.json();
                        })
                        .catch(err => {
                            console.error(`? Erro ao consultar banco ${bancoid}:`, err);
                            return [];
                        });
                });
                
                const results = await Promise.all(promises);
                const machines = results.flat();
                
                const now = new Date();
                document.getElementById('monitorLastUpdate').textContent = now.toLocaleTimeString('pt-BR');
                
                const content = document.getElementById('machineMonitorContent');
                
                if (machines.length === 0) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Nenhuma m√©quina encontrada</div>';
                    hideLoading();
                    return;
                }
                
                // Ordenar por √öltima sincroniza√ß√£o (mais recente primeiro)
                machines.sort((a, b) => {
                    const dateA = a.lastSync ? new Date(a.lastSync).getTime() : 0;
                    const dateB = b.lastSync ? new Date(b.lastSync).getTime() : 0;
                    return dateB - dateA; // DESC (mais recente primeiro)
                });
                
                // Tabela estilo lista limpa
                let html = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 14px 16px; text-align: left; font-weight: 700; font-size: 13px; letter-spacing: 0.5px;">??? EQUIPAMENTO</th>
                                    <th style="padding: 14px 16px; text-align: center; font-weight: 700; font-size: 13px; letter-spacing: 0.5px;">?? √öltima SINC</th>
                                    <th style="padding: 14px 16px; text-align: center; font-weight: 700; font-size: 13px; letter-spacing: 0.5px;">?? QTD BATIDAS</th>
                                    <th style="padding: 14px 16px; text-align: center; font-weight: 700; font-size: 13px; letter-spacing: 0.5px;">?? H√ß√£ QUANTO TEMPO</th>
                                    <th style="padding: 14px 16px; text-align: center; font-weight: 700; font-size: 13px; letter-spacing: 0.5px;">?? STATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                machines.forEach((machine, index) => {
                    // Verificar se lastSync √£ v√°lido
                    let lastSync = null;
                    if (machine.lastSync && 
                        machine.lastSync !== 'Nunca sincronizado' && 
                        machine.lastSync !== 'Erro ao consultar' &&
                        !machine.lastSync.includes('Nunca') &&
                        !machine.lastSync.includes('Erro')) {
                        try {
                            lastSync = new Date(machine.lastSync);
                            // Validar se a data √£ v√°lida
                            if (isNaN(lastSync.getTime())) {
                                lastSync = null;
                            }
                        } catch (e) {
                            lastSync = null;
                        }
                    }
                    
                    const diffMinutes = lastSync ? Math.floor((now - lastSync) / 60000) : 99999;
                    
                    let statusColor = '#10b981'; // Verde
                    let statusText = '? ONLINE';
                    let bgRow = index % 2 === 0 ? '#f8fafc' : 'white';
                    
                    if (!lastSync || diffMinutes > 60) {
                        statusColor = '#ef4444'; // Vermelho
                        statusText = '? OFFLINE';
                    } else if (diffMinutes > 30) {
                        statusColor = '#f59e0b'; // Amarelo
                        statusText = '?? ALERTA';
                    }
                    
                    const tempoAtras = lastSync 
                        ? (diffMinutes < 1 ? 'Agora' : diffMinutes < 60 ? `${diffMinutes} min` : `${Math.floor(diffMinutes/60)}h ${diffMinutes%60}min`)
                        : 'Nunca';
                    
                    html += `
                        <tr style="background: ${bgRow}; border-bottom: 1px solid #e2e8f0; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='${bgRow}'">
                            <td style="padding: 14px 16px; font-weight: 600; color: #1e293b; font-size: 14px;">
                                ${machine.name}
                                <div style="font-size: 11px; color: #94a3b8; font-weight: 400; margin-top: 2px;">
                                    ?? ${machine.id} √£ ?? ${machine.ip || 'N/A'}
                                </div>
                            </td>
                            <td style="padding: 14px 16px; text-align: center; color: #475569; font-size: 13px;">
                                ${lastSync ? lastSync.toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : '<span style="color: #94a3b8;">Sem dados</span>'}
                            </td>
                            <td style="padding: 14px 16px; text-align: center;">
                                <span style="background: ${machine.totalBatidas > 0 ? '#10b98120' : '#ef444420'}; color: ${machine.totalBatidas > 0 ? '#10b981' : '#ef4444'}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700;">
                                    ${machine.totalBatidas || 0} ${machine.lastSyncCount > 0 ? `(${machine.lastSyncCount} na √öltima)` : ''}
                                </span>
                            </td>
                            <td style="padding: 14px 16px; text-align: center; color: ${statusColor}; font-weight: 700; font-size: 14px;">
                                ${tempoAtras}
                            </td>
                            <td style="padding: 14px 16px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; white-space: nowrap; display: inline-block;">
                                    ${statusText}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                content.innerHTML = html;
                
                hideLoading();
            } catch (err) {
                console.error('? Erro ao buscar m√©quinas:', err);
                showAlert('Erro', 'n√£o foi posS√≥vel consultar as m√©quinas: ' + err.message, 'error');
                hideLoading();
            }
        }

        function exportMachineMonitor() {
            showAlert('Info', 'Use a captura de tela do Windows (Win + Shift + S) para tirar um print do monitor!', 'info');
        }

        // Fechar modal ao clicar fora
        document.getElementById('machineMonitorModal').addEventListener('click', (e) => {
            if (e.target.id === 'machineMonitorModal') {
                closeMachineMonitor();
            }
        });

        // ==========================================
        // DELETAR PONTO (CRUD)
        // ==========================================
        async function deletePunch(event, reg, date, punchType, columnName) {
            event.stopPropagation(); // n√£o abrir Edi√ß√£o
            
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee) {
                showAlert('Erro', 'FUNCION√ÅRIO n√£o encontrado', 'error');
                return;
            }
            
            const currentTime = employee.punches[punchType];
            if (!currentTime || currentTime === '--:--') {
                showAlert('Info', 'n√£o h√ß√£ ponto para apagar neste Hor√°rio', 'info');
                return;
            }
            
            // Confirmar excluS√≥o
            if (!confirm(`?? Tem certeza que deseja APAGAR o ponto?\n\n${employee.name}\n${columnName}: ${currentTime}\nData: ${date}`)) {
                return;
            }
            
            try {
                showLoading('Apagando ponto...');
                
                // Converter data para formato ISO
                let dataFormatted = date;
                if (date.includes('/')) {
                    const parts = date.split('/');
                    dataFormatted = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                }
                if (dataFormatted.includes('T')) {
                    dataFormatted = dataFormatted.split('T')[0];
                }
                
                console.log(`??? Apagando ${columnName}:`, {
                    NumeroFolha: reg,
                    Data: dataFormatted + 'T00:00:00',
                    Coluna: columnName,
                    Hora: '', // Vazio = DELETE
                    Motivo: 'ExcluS√≥o via sistema'
                });
                
                // Enviar para API Secullum (Hora vazia = DELETE)
                const response = await fetch('https://pontowebintegracaoexterna.secullum.com.br/IntegracaoExterna/CartaoPonto/Manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Token': secullumToken
                    },
                    body: JSON.stringify({
                        NumeroFolha: reg,
                        Data: dataFormatted + 'T00:00:00',
                        Coluna: columnName,
                        Hora: null, // NULL = DELETE na API Secullum
                        Motivo: 'ExcluS√≥o via sistema'
                    })
                });
                
                console.log(`?? Status da resposta: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`? Erro:`, errorText);
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`? Ponto apagado com sucesso:`, result);
                
                // Atualizar na mem√©ria
                employee.punches[punchType] = null;
                
                // Atualizar visualmente
                renderTable();
                
                hideLoading();
                showAlert('Sucesso', `Ponto ${columnName} apagado com sucesso!`, 'success');
                
            } catch (err) {
                console.error('? Erro ao apagar ponto:', err);
                hideLoading();
                showAlert('Erro', `n√£o foi posS√≥vel apagar o ponto: ${err.message}`, 'error');
            }
        }

        // ==========================================
        // Edi√ß√£o INLINE (Estilo Excel)
        // ==========================================
        let currentEditingCell = null;

        function startInlineEdit(cell) {
            // Se j√° est√© editando outra c√ß√£lula, cancela
            if (currentEditingCell && currentEditingCell !== cell) {
                cancelInlineEdit(currentEditingCell);
            }

            const reg = cell.dataset.reg;
            const date = cell.dataset.date;
            const punchType = cell.dataset.punch; // ent1, sai1, ent2, etc
            
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee) return;

            // Valor atual
            const currentValue = employee.punches[punchType] || '';

            // Marcar c√ß√£lula como editando
            cell.classList.add('editing');
            currentEditingCell = cell;

            // Criar input
            const input = document.createElement('input');
            input.type = 'time';
            input.className = 'inline-input';
            input.value = currentValue;
            
            // Limpar c√ß√£lula e adicionar input
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();

            // Flag para evitar m√©ltiplas chamadas
            let saving = false;

            // fun√ß√£oo para salvar (evita duplica√ß√£o)
            const save = () => {
                if (!saving) {
                    saving = true;
                    input.removeEventListener('blur', save);
                    saveInlineEdit(cell, reg, date, punchType, input.value);
                }
            };

            // Eventos do input
            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    save();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    saving = true; // Prevenir blur
                    input.removeEventListener('blur', save);
                    cancelInlineEdit(cell);
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    saving = true; // Prevenir blur
                    input.removeEventListener('blur', save);
                    saveInlineEdit(cell, reg, date, punchType, input.value);
                    // Mover para pr√ß√£xima c√ß√£lula edit√©vel
                    const nextCell = e.shiftKey ? getPreviousEditableCell(cell) : getNextEditableCell(cell);
                    if (nextCell) {
                        setTimeout(() => startInlineEdit(nextCell), 100);
                    }
                }
            });
        }

        function getNextEditableCell(currentCell) {
            const row = currentCell.parentElement;
            const cells = Array.from(row.querySelectorAll('.editable-cell'));
            const currentIndex = cells.indexOf(currentCell);
            
            if (currentIndex < cells.length - 1) {
                return cells[currentIndex + 1];
            } else {
                // Pr√ß√£xima linha
                const nextRow = row.nextElementSibling;
                if (nextRow) {
                    return nextRow.querySelector('.editable-cell');
                }
            }
            return null;
        }

        function getPreviousEditableCell(currentCell) {
            const row = currentCell.parentElement;
            const cells = Array.from(row.querySelectorAll('.editable-cell'));
            const currentIndex = cells.indexOf(currentCell);
            
            if (currentIndex > 0) {
                return cells[currentIndex - 1];
            } else {
                // Linha anterior
                const prevRow = row.previousElementSibling;
                if (prevRow) {
                    const prevCells = prevRow.querySelectorAll('.editable-cell');
                    return prevCells[prevCells.length - 1];
                }
            }
            return null;
        }

        async function saveInlineEdit(cell, reg, date, punchType, newValue) {
            if (!currentEditingCell) return;
            
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee) {
                cancelInlineEdit(cell);
                return;
            }

            // Se o valor n√£o mudou, apenas cancela
            const oldValue = employee.punches[punchType] || '';
            if (newValue === oldValue) {
                cancelInlineEdit(cell);
                return;
            }

            // Mostrar feedback visual
            cell.classList.add('saving-cell');
            cell.classList.remove('editing');
            
            // Limpar completamente a c√ß√£lula antes de adicionar novo conte√ß√£do
            while (cell.firstChild) {
                cell.removeChild(cell.firstChild);
            }
            
            const loadingSpan = document.createElement('span');
            loadingSpan.className = 'punch-time present';
            loadingSpan.style.fontSize = '13px';
            loadingSpan.textContent = newValue || '--:--';
            cell.appendChild(loadingSpan);

            try {
                // Mapear tipo de punch para nome da coluna
                const colunaMap = {
                    'ent1': 'Entrada1',
                    'sai1': 'Saida1',
                    'ent2': 'Entrada2',
                    'sai2': 'Saida2',
                    'ent3': 'Entrada3',
                    'sai3': 'Saida3',
                    'ent4': 'Entrada4',
                    'sai4': 'Saida4',
                    'ent5': 'Entrada5',
                    'sai5': 'Saida5'
                };

                // Buscar dados completos do FUNCION√ÅRIO (igual no modal)
                const funcionarioId = employee.rawData?.FuncionarioId || employee.dadosCompletos?.FuncionarioId;
                const data = employee.rawData?.Data || employee.dadosCompletos?.Data || employee.date;
                
                if (!funcionarioId) {
                    throw new Error('ID do FUNCION√ÅRIO n√£o encontrado! Recarregue os dados.');
                }

                const payload = {
                    NumeroFolha: reg,
                    Data: data, // Usar data original da API (j√° vem formatada)
                    Coluna: colunaMap[punchType],
                    Hora: newValue,
                    Motivo: 'Edi√ß√£o inline via sistema'
                };

                console.log(`?? Salvando ${colunaMap[punchType]}: ${newValue}`, payload);

                const endpoint = `${API_CONFIG.baseURL}/IntegracaoExterna/CartaoPonto/Manual`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_CONFIG.token}`,
                        'Content-Type': 'application/json',
                        'secullumidbancoselecionado': employee.empresaId || employee.companyId
                    },
                    body: JSON.stringify(payload)
                });

                console.log(`?? Status da resposta: ${response.status}`);

                if (response.ok) {
                    // ‚úÖ INVALIDA√á√ÉO CIR√öRGICA: Recarregar apenas este funcion√°rio
                    console.log('‚ö° Invalidando cache do funcion√°rio...');
                    await invalidateSingleEmployee(reg, date, employee.empresaId || employee.companyId);
                    
                    // Tenta ler como JSON, mas aceita resposta vazia
                    const responseText = await response.text();
                    console.log(`?? Resposta texto: "${responseText}"`);
                    
                    let result = null;
                    if (responseText && responseText.trim() !== '') {
                        try {
                            result = JSON.parse(responseText);
                        } catch (e) {
                            console.warn('?? Resposta n√£o √£ JSON v√°lido, mas status √£ OK');
                        }
                    }
                    
                    console.log(`? ${colunaMap[punchType]} registrada com sucesso!`, result || '(sem retorno JSON)');
                    
                    // Atualizar valor local
                    employee.punches[punchType] = newValue;
                    
                    // Re-renderizar c√ß√£lula com sucesso
                    cell.classList.remove('saving-cell');
                    
                    // Limpar completamente antes de adicionar
                    while (cell.firstChild) {
                        cell.removeChild(cell.firstChild);
                    }
                    
                    const editIcon = document.createElement('span');
                    editIcon.className = 'edit-icon';
                    editIcon.textContent = '??';
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = `punch-time ${newValue ? 'present' : 'missing'}`;
                    timeSpan.style.fontSize = '13px';
                    timeSpan.textContent = newValue || '--:--';
                    
                    cell.appendChild(editIcon);
                    cell.appendChild(timeSpan);
                    
                    // Atualizar status de inconsist√©ncia (sem recarregar tudo)
                    updateEmployeeStatus(employee);
                    
                    // VERIFICAR SE FICOU COM ORDEM INCORRETA OU BATIDAS √£MPARES
                    const batidas = [
                        employee.punches.ent1, employee.punches.sai1,
                        employee.punches.ent2, employee.punches.sai2,
                        employee.punches.ent3, employee.punches.sai3,
                        employee.punches.ent4, employee.punches.sai4,
                        employee.punches.ent5, employee.punches.sai5
                    ].filter(h => h && h !== '--:--');
                    
                    const totalBatidas = batidas.length;
                    
                    // Verificar ordem cronol√≥gica
                    const timeToMinutes = (time) => {
                        if (!time) return 0;
                        const [h, m] = time.split(':').map(Number);
                        return h * 60 + m;
                    };
                    
                    let ordemIncorreta = false;
                    const horariosOrdenados = [
                        employee.punches.ent1, employee.punches.sai1,
                        employee.punches.ent2, employee.punches.sai2,
                        employee.punches.ent3, employee.punches.sai3,
                        employee.punches.ent4, employee.punches.sai4,
                        employee.punches.ent5, employee.punches.sai5
                    ].filter(h => h && h !== '--:--');
                    
                    for (let i = 1; i < horariosOrdenados.length; i++) {
                        const anterior = timeToMinutes(horariosOrdenados[i - 1]);
                        const atual = timeToMinutes(horariosOrdenados[i]);
                        
                        if (atual <= anterior) {
                            ordemIncorreta = true;
                            break;
                        }
                    }
                    
                    // AVISOS
                    if (ordemIncorreta) {
                        alert(`?? ATEn√£oO: ORDEM cronol√≥gica INCORRETA!\n\n` +
                              `Os Hor√°rios devem estar em ordem crescente.\n` +
                              `Verifique: ${horariosOrdenados.join(' ? ')}\n\n` +
                              `A linha ficou marcada em AMARELO.`);
                    } else if (totalBatidas !== 4) {
                        alert(`?? ATEn√£oO: ${totalBatidas} batidas registradas!\n\n` +
                              `Padr√£o esperado: 4 batidas (2 pares)\n` +
                              `Atual: ${horariosOrdenados.join(', ')}\n\n` +
                              `A linha ficou marcada em AMARELO.`);
                    }
                    
                } else {
                    const errorText = await response.text();
                    console.error('? Erro:', errorText);
                    alert(`Erro ao salvar: ${errorText}`);
                    cancelInlineEdit(cell);
                }
            } catch (error) {
                console.error('? Erro na requisi√ß√£√£o:', error);
                alert('Erro ao salvar altera√ß√£o. Verifique o console.');
                cancelInlineEdit(cell);
            }

            currentEditingCell = null;
        }

        function cancelInlineEdit(cell) {
            if (!cell) return;
            
            const reg = cell.dataset.reg;
            const date = cell.dataset.date;
            const punchType = cell.dataset.punch;
            
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            const currentValue = employee ? (employee.punches[punchType] || '') : '';

            cell.classList.remove('editing', 'saving-cell');
            
            // Limpar completamente antes de adicionar (evita erro de DOM)
            while (cell.firstChild) {
                cell.removeChild(cell.firstChild);
            }
            
            const editIcon = document.createElement('span');
            editIcon.className = 'edit-icon';
            editIcon.textContent = '??';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = `punch-time ${currentValue ? 'present' : 'missing'}`;
            timeSpan.style.fontSize = '13px';
            timeSpan.textContent = currentValue || '--:--';
            
            cell.appendChild(editIcon);
            cell.appendChild(timeSpan);
            
            currentEditingCell = null;
        }

        // fun√ß√£oo auxiliar para atualizar status de um FUNCION√ÅRIO
        function updateEmployeeStatus(employee) {
            const p = employee.punches;
            
            // Coletar todas as batidas v√°lidas
            const batidas = [
                p.ent1, p.sai1,
                p.ent2, p.sai2,
                p.ent3, p.sai3,
                p.ent4, p.sai4,
                p.ent5, p.sai5
            ].filter(h => h && h !== '--:--');
            
            const totalBatidas = batidas.length;
            
            // fun√ß√£oo para converter HH:MM em minutos
            const timeToMinutes = (time) => {
                if (!time) return 0;
                const [h, m] = time.split(':').map(Number);
                return h * 60 + m;
            };
            
            // VALIDAR ORDEM cronol√≥gica
            let ordemIncorreta = false;
            const horariosOrdenados = [
                { nome: 'Entrada 1', hora: p.ent1 },
                { nome: 'SA√çda 1', hora: p.sai1 },
                { nome: 'Entrada 2', hora: p.ent2 },
                { nome: 'SA√çda 2', hora: p.sai2 },
                { nome: 'Entrada 3', hora: p.ent3 },
                { nome: 'SA√çda 3', hora: p.sai3 },
                { nome: 'Entrada 4', hora: p.ent4 },
                { nome: 'SA√çda 4', hora: p.sai4 },
                { nome: 'Entrada 5', hora: p.ent5 },
                { nome: 'SA√çda 5', hora: p.sai5 }
            ].filter(h => h.hora && h.hora !== '--:--');
            
            for (let i = 1; i < horariosOrdenados.length; i++) {
                const anterior = timeToMinutes(horariosOrdenados[i - 1].hora);
                const atual = timeToMinutes(horariosOrdenados[i].hora);
                
                if (atual <= anterior) {
                    ordemIncorreta = true;
                    console.log(`?? ORDEM INCORRETA: ${employee.name} - ${horariosOrdenados[i - 1].nome} (${horariosOrdenados[i - 1].hora}) >= ${horariosOrdenados[i].nome} (${horariosOrdenados[i].hora})`);
                    break;
                }
            }
            
            // Verificar se tem motivo especial
            const motivosEspeciais = ['FALTA', 'F√ß√£RIAS', 'AFASTAMENTO INSS', 'LICEN√ß√£A MATERNIDADE'];
            const temMotivoEspecial = motivosEspeciais.includes(employee.motivo);
            
            // Marca inconsist√©ncia se:
            // 1. n√£o tem exatamente 4 batidas
            // 2. OU Hor√°rios em ordem incorreta
            // 3. E n√£o tem motivo especial
            const batidaIncorreta = totalBatidas !== 4 || ordemIncorreta;
            
            if (batidaIncorreta && !temMotivoEspecial) {
                employee.hasInconsistency = true;
            } else {
                employee.hasInconsistency = false;
            }
            
            // Re-renderizar apenas a linha deste FUNCION√ÅRIO
            renderTable();
        }

        // ==========================================
        // Edi√ß√£o DE BATIDAS
        // ==========================================
        let currentEditEmployee = null;

        function openEditModal(reg, date) {
            const employee = allEmployees.find(emp => emp.reg === reg && emp.date === date);
            if (!employee) {
                alert('FUNCION√ÅRIO n√£o encontrado!');
                return;
            }

            currentEditEmployee = employee;

            // Preencher informa√ß√µeses do FUNCION√ÅRIO
            document.getElementById('editEmployeeName').textContent = employee.name;
            document.getElementById('editEmployeeReg').textContent = employee.reg;
            document.getElementById('editEmployeeDate').textContent = date;

            // Preencher Hor√°rios atuais (convertendo HH:MM para HH:MM formato do input)
            const setTimeValue = (id, value) => {
                const input = document.getElementById(id);
                if (value && value !== '--:--') {
                    // Se j√° est√© no formato HH:MM, usa direto
                    input.value = value.length === 4 ? `0${value}` : value; // Adiciona zero se for H:MM
                } else {
                    input.value = '';
                }
            };

            setTimeValue('editEnt1', employee.punches.ent1);
            setTimeValue('editSai1', employee.punches.sai1);
            setTimeValue('editEnt2', employee.punches.ent2);
            setTimeValue('editSai2', employee.punches.sai2);
            setTimeValue('editEnt3', employee.punches.ent3);
            setTimeValue('editSai3', employee.punches.sai3);
            setTimeValue('editEnt4', employee.punches.ent4);
            setTimeValue('editSai4', employee.punches.sai4);
            setTimeValue('editEnt5', employee.punches.ent5);
            setTimeValue('editSai5', employee.punches.sai5);

            // Mostrar modal
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditEmployee = null;
        }

        async function confirmSaveEdit() {
            if (!currentEditEmployee) return;

            // Coletar valores editados
            const getTimeValue = (id) => {
                const value = document.getElementById(id).value;
                return value ? value : null;
            };

            const updatedPunches = {
                ent1: getTimeValue('editEnt1'),
                sai1: getTimeValue('editSai1'),
                ent2: getTimeValue('editEnt2'),
                sai2: getTimeValue('editSai2'),
                ent3: getTimeValue('editEnt3'),
                sai3: getTimeValue('editSai3'),
                ent4: getTimeValue('editEnt4'),
                sai4: getTimeValue('editSai4'),
                ent5: getTimeValue('editEnt5'),
                sai5: getTimeValue('editSai5')
            };

            console.log('?? Dados a serem enviados:', updatedPunches);
            console.log('?? FUNCION√ÅRIO:', currentEditEmployee);

            // Confirmar antes de enviar
            const confirmacao = confirm(
                `Confirma o envio das altera√ß√£es para:\n\n` +
                `${currentEditEmployee.name} (REG: ${currentEditEmployee.reg})\n` +
                `Data: ${currentEditEmployee.date}\n\n` +
                `?? Esta a√ß√£o ir√ß√£ atualizar os dados na Secullum!`
            );

            if (!confirmacao) return;

            try {
                // Buscar o ID do FUNCION√ÅRIO na API (necesS√≥rio para o endpoint)
                const funcionarioId = currentEditEmployee.rawData?.FuncionarioId || currentEditEmployee.dadosCompletos?.FuncionarioId;
                const data = currentEditEmployee.rawData?.Data || currentEditEmployee.dadosCompletos?.Data || currentEditEmployee.data;
                
                if (!funcionarioId) {
                    throw new Error('ID do FUNCION√ÅRIO n√£o encontrado! Recarregue os dados.');
                }

                console.log(`?? Iniciando atualiza√ß√£oo de batidas...`);
                console.log(`?? FuncionarioId: ${funcionarioId}`);
                console.log(`?? Data: ${data}`);

                // Endpoint da Secullum para incluir batida manual
                const endpoint = `${API_CONFIG.baseURL}/IntegracaoExterna/CartaoPonto/Manual`;
                
                let sucessos = 0;
                let erros = 0;

                // Enviar cada batida individualmente
                const batidas = [
                    { tipo: 'E', hora: updatedPunches.ent1, label: 'Entrada 1', coluna: 'Entrada1' },
                    { tipo: 'S', hora: updatedPunches.sai1, label: 'SA√çda 1', coluna: 'Saida1' },
                    { tipo: 'E', hora: updatedPunches.ent2, label: 'Entrada 2', coluna: 'Entrada2' },
                    { tipo: 'S', hora: updatedPunches.sai2, label: 'SA√çda 2', coluna: 'Saida2' },
                    { tipo: 'E', hora: updatedPunches.ent3, label: 'Entrada 3', coluna: 'Entrada3' },
                    { tipo: 'S', hora: updatedPunches.sai3, label: 'SA√çda 3', coluna: 'Saida3' },
                    { tipo: 'E', hora: updatedPunches.ent4, label: 'Entrada 4', coluna: 'Entrada4' },
                    { tipo: 'S', hora: updatedPunches.sai4, label: 'SA√çda 4', coluna: 'Saida4' },
                    { tipo: 'E', hora: updatedPunches.ent5, label: 'Entrada 5', coluna: 'Entrada5' },
                    { tipo: 'S', hora: updatedPunches.sai5, label: 'SA√çda 5', coluna: 'Saida5' }
                ];

                for (const batida of batidas) {
                    if (!batida.hora) continue; // Pula se n√£o tiver Hor√°rio

                    const payload = {
                        NumeroFolha: currentEditEmployee.reg,
                        Data: data,
                        Coluna: batida.coluna, // "Entrada1", "Saida1", etc (TEXTO, n√£o n√ß√£mero!)
                        Hora: batida.hora,
                        Motivo: 'IncluS√≥o manual via sistema'
                    };

                    console.log(`?? Enviando ${batida.label}: ${batida.hora}`, payload);

                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${API_CONFIG.token}`,
                                'Content-Type': 'application/json',
                                'secullumidbancoselecionado': currentEditEmployee.empresaId || API_CONFIG.companies[0]?.id
                            },
                            body: JSON.stringify(payload)
                        });

                        console.log(`?? Status da resposta: ${response.status}`);

                        if (response.ok) {
                            // Tenta ler como JSON, mas aceita resposta vazia
                            const responseText = await response.text();
                            console.log(`?? Resposta texto: "${responseText}"`);
                            
                            let result = null;
                            if (responseText && responseText.trim() !== '') {
                                try {
                                    result = JSON.parse(responseText);
                                } catch (e) {
                                    console.warn('?? Resposta n√£o √£ JSON v√°lido, mas status √£ OK');
                                }
                            }
                            
                            console.log(`? ${batida.label} registrada com sucesso!`, result || '(sem retorno JSON)');
                            sucessos++;
                        } else {
                            const errorText = await response.text();
                            console.error(`? Erro ao registrar ${batida.label}: ${response.status} - ${errorText}`);
                            erros++;
                        }
                    } catch (fetchError) {
                        console.error(`? Erro de rede ao enviar ${batida.label}:`, fetchError);
                        erros++;
                    }

                    // Delay entre requisi√ß√£√£es para evitar sobrecarga
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                if (erros === 0) {
                    alert(`? Todas as batidas foram atualizadas com sucesso!\n\n${sucessos} Hor√°rios registrados.`);
                } else {
                    alert(`?? atualiza√ß√£oo parcial:\n\n? ${sucessos} registros com sucesso\n? ${erros} erros\n\nVerifique o console para detalhes.`);
                }

                closeEditModal();

                // Recarregar dados
                console.log('?? Recarregando dados...');
                await searchPeriod();

            } catch (error) {
                console.error('? Erro ao atualizar batidas:', error);
                alert(`? Erro ao atualizar batidas:\n\n${error.message}`);
            }
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        
        // ?? CORRE√ß√£√£O: Event listeners duplicados REMOVIDOS
        // Agora usa event delegation configurado na inicializa√ß√£o (linha ~2395)
        
        // Checkbox "Selecionar Todos"
        document.getElementById('selectAll').addEventListener('change', (e) => {
            const displayedEmployees = showOnlyInconsistencies 
                ? allEmployees.filter(emp => emp.hasInconsistency)
                : allEmployees;
            
            if (e.target.checked) {
                // ? SELECIONAR usando ID √∫nico (REG + DATA)
                selectedEmployees = displayedEmployees.map(emp => `${emp.reg}_${emp.date}`);
            } else {
                selectedEmployees = [];
            }
            
            // ? n√£o CHAMAR renderTable()! Atualizar diretamente os checkboxes
            document.querySelectorAll('.employee-checkbox').forEach(cb => {
                const uniqueId = cb.dataset.id;
                if (displayedEmployees.some(emp => `${emp.reg}_${emp.date}` === uniqueId)) {
                    cb.checked = e.target.checked;
                    const row = cb.closest('tr');
                    if (row) {
                        if (e.target.checked) {
                            row.classList.add('selected');
                        } else {
                            row.classList.remove('selected');
                        }
                    }
                }
            });
        });

        // fun√ß√£oo compartilhada de gera√ß√£o de PDF
        async function generatePDFs() {
            console.log('?? generatePDFs() iniciada');
            console.log(`?? Selecionados: ${selectedEmployees.length} - ${JSON.stringify(selectedEmployees.slice(0, 3))}`);
            
            // ? VERIFICAR SE H√ß√£ sele√ß√£o√£O
            if (selectedEmployees.length === 0) {
                showAlert('Aten√£oo', 'Selecione pelo menos um colaborador usando os checkboxes!', 'warning');
                return;
            }
            
            // ? GERAR APENAS OS SELECIONADOS (n√£o todos os exibidos)
            const displayedEmployees = showOnlyInconsistencies 
                ? allEmployees.filter(emp => emp.hasInconsistency)
                : allEmployees;
            
            console.log(`?? Total displayedEmployees: ${displayedEmployees.length}`);
            
            // ? FILTRAR usando ID √∫nico (REG + DATA) para pegar apenas os dias selecionados
            const toGenerate = displayedEmployees.filter(emp => {
                const uniqueId = `${emp.reg}_${emp.date}`;
                return selectedEmployees.includes(uniqueId);
            });
            
            console.log(`?? toGenerate: ${toGenerate.length} registros`);
            console.log(`?? Primeiro registro:`, toGenerate[0]);
            
            if (toGenerate.length === 0) {
                showAlert('Aten√£oo', 'Nenhum colaborador selecionado encontrado!', 'warning');
                return;
            }
            
            // ?? MOSTRAR DI√ß√£LOGO DE CONFIRMa√ß√£O
            const confirmar = confirm(
                `?? GERAR PDF PARA ENVIO?\n\n` +
                `Os registros Ser√°o salvos no banco de dados e receber√£o IDs √∫nicos.\n\n` +
                `Total: ${toGenerate.length} registro(s)`
            );
            
            if (!confirmar) {
                console.log('? gera√ß√£o de PDF cancelada pelo Usu√°rio');
                return;
            }
            
            // ?? MOSTRAR LOADING E SALVAR NO BANCO
            console.log('?? Salvando justificativas no banco de dados...');
            showAlert('Aguarde', 'Salvando justificativas no banco de dados...', 'info');
            
            // ?? Verificar se algum registro j√° foi impresso
            const registrosExistentes = [];
            const registrosNovos = [];
            
            try {
                for (const emp of toGenerate) {
                    // Preparar dados para enviar
                    const payload = {
                        cpf: emp.cpf,
                        reg: emp.reg,
                        data: emp.date,
                        empresa_id: emp.empresaId || emp.companyId || 0,
                        nome: emp.name || '',
                        motivo: emp.motivo || ''
                    };
                    
                    console.log(`?? Salvando ${emp.name} (CPF: ${emp.cpf})`);
                    
                    const response = await fetch(`${API_BASE_URL}/api/justificativa/salvar`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const { id, novo, mensagem } = await response.json();
                        emp.id = id;
                        console.log(`? ${mensagem} - ID: #${id}`);
                        
                        // Separar novos de existentes
                        if (novo) {
                            registrosNovos.push(emp.name);
                        } else {
                            registrosExistentes.push(emp.name);
                        }
                    } else {
                        const errorText = await response.text();
                        console.error(`? Erro ao salvar ${emp.name}: ${response.status} - ${errorText}`);
                        showAlert('Erro', `Erro ao salvar justificativa de ${emp.name}`, 'error');
                        return;
                    }
                }
                
                // Fechar alert de loading
                hideAlert();
                
                // ?? AVISAR SE H√ß√£ REIMPRESS√≥ES
                if (registrosExistentes.length > 0) {
                    const nomes = registrosExistentes.join('\n√ß√£ ');
                    const confirmar = confirm(
                        `?? REIMPRESS√≥O DETECTADA\n\n` +
                        `Os seguintes registros j√° FORAM IMPRESSOS:\n\n√ß√£ ${nomes}\n\n` +
                        `${registrosNovos.length > 0 ? `\nNovos registros: ${registrosNovos.length}\n\n` : ''}` +
                        `Deseja REIMPRIMIR mesmo assim?`
                    );
                    
                    if (!confirmar) {
                        console.log('? ReimpresS√≥o cancelada pelo Usu√°rio');
                        return;
                    }
                }
                
                console.log(`?? Gerando PDF para ${toGenerate.length} registro(s) selecionado(s)`);
                
                // Gerar PDFs usando emp.id do banco
                const pdfPages = document.getElementById('pdfPages');
                pdfPages.innerHTML = toGenerate.map((emp) => generateForm(emp, emp.id || '?', toGenerate.length)).join('');
                
                // Atualizar contador
                document.getElementById('pdfCount').textContent = `${toGenerate.length} formul√©rio(s) √£ 1 por p√°gina A4 Paisagem`;
                
                // Mostrar preview
                document.getElementById('mainInterface').classList.add('hidden');
                document.getElementById('pdfPreview').classList.add('active');
                
                // Recarregar dados para atualizar a tabela com os novos IDs
                await reloadData();
                
            } catch (err) {
                console.error('? Erro ao gerar PDFs:', err);
                showAlert('Erro', 'Erro ao gerar PDFs. Verifique o console.', 'error');
            }
        }
        
        // bot√£oo "GERAR PDF" no topo direito
        document.getElementById('btnGenerateTopRight').addEventListener('click', generatePDFs);

        document.getElementById('btnClosePDF').addEventListener('click', () => {
            document.getElementById('pdfPreview').classList.remove('active');
            document.getElementById('mainInterface').classList.remove('hidden');
        });

        // Event Listeners API - Removido bot√£oo manual, conecta automaticamente

        // bot√£oo de buscar Per√≠odo
        document.getElementById('btnSearchDates').addEventListener('click', async () => {
            if (isAPIConnected) {
                await searchPeriod();
            } else {
                alert('?? Primeiro conecte √£ API!');
            }
        });

        // Campo de busca por nome - atualiza em tempo real
        document.getElementById('searchName')?.addEventListener('input', () => {
            renderTable();
        });
        
        // Filtro de L√≠der (atualizar em tempo real)
        document.getElementById('searchLider')?.addEventListener('input', () => {
            renderTable();
        });

        // bot√£oo limpar filtro
        document.getElementById('btnClearFilter')?.addEventListener('click', () => {
            document.getElementById('searchName').value = '';
            document.getElementById('searchLider').value = '';
            document.getElementById('searchProject').value = '';
            renderTable();
        });
        
        // Filtro de projeto (atualizar em tempo real)
        document.getElementById('searchProject')?.addEventListener('input', () => {
            renderTable();
        });

        // ==========================================
        // ?? bot√£oo DE TESTE - ANEXO OCR
        // ==========================================
        document.getElementById('btnTesteAnexo').addEventListener('click', () => {
            document.getElementById('inputTesteAnexo').click();
        });

        document.getElementById('inputTesteAnexo').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            console.clear();
            console.log('?????? TESTE DE ANEXO E OCR INICIADO ??????');
            console.log('?? Arquivo selecionado:', file.name, `(${(file.size / 1024).toFixed(2)} KB)`);

            try {
                // Converter para base64
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const imageBase64 = event.target.result;
                    
                    console.log('?? Tamanho base64:', imageBase64.length, 'caracteres');

                    // Chamar fun√ß√£oo de OCR
                    console.log('');
                    console.log('??????????????????????????????????');
                    console.log('?? INICIANDO AZURE COMPUTER VISION OCR');
                    console.log('??????????????????????????????????');
                    
                    const resultado = await extrairDadosComGoogleVision(imageBase64);
                    
                    console.log('');
                    console.log('??????????????????????????????????');
                    console.log('?? RESULTADO FINAL DO OCR');
                    console.log('??????????????????????????????????');
                    console.log('?? ID detectado:', resultado.id || 'n√£o DETECTADO');
                    console.log('?? Motivo:', resultado.motivo || 'n√£o DETECTADO');
                    console.log('? Hor√°rios extra√ß√£dos:');
                    console.log('   Ent1:', resultado.ent1 || 'vazio');
                    console.log('   Sai1:', resultado.sai1 || 'vazio');
                    console.log('   Ent2:', resultado.ent2 || 'vazio');
                    console.log('   Sai2:', resultado.sai2 || 'vazio');
                    console.log('   Ent3:', resultado.ent3 || 'vazio');
                    console.log('   Sai3:', resultado.sai3 || 'vazio');
                    console.log('?? Confian√ß√£a:');
                    console.log('   ID:', resultado.confidence?.id || 0, '%');
                    console.log('   Motivo:', resultado.confidence?.motivo || 0, '%');
                    console.log('   Ent1:', resultado.confidence?.ent1 || 0, '%');
                    console.log('   Sai1:', resultado.confidence?.sai1 || 0, '%');
                    console.log('   Ent2:', resultado.confidence?.ent2 || 0, '%');
                    console.log('   Sai2:', resultado.confidence?.sai2 || 0, '%');
                    console.log('??????????????????????????????????');
                    console.log('');
                    
                    // Mostrar popup com resultado
                    const horariosStr = [
                        resultado.ent1 ? `Ent1: ${resultado.ent1}` : null,
                        resultado.sai1 ? `Sai1: ${resultado.sai1}` : null,
                        resultado.ent2 ? `Ent2: ${resultado.ent2}` : null,
                        resultado.sai2 ? `Sai2: ${resultado.sai2}` : null,
                        resultado.ent3 ? `Ent3: ${resultado.ent3}` : null,
                        resultado.sai3 ? `Sai3: ${resultado.sai3}` : null
                    ].filter(h => h).join('\n');
                    
                    alert(
                        `?? RESULTADO DO TESTE DE OCR\n\n` +
                        `?? ID: ${resultado.id || 'n√£o DETECTADO'}\n` +
                        `?? Motivo: ${resultado.motivo || 'PADR√£O'} ??\n` +
                        `   (Detec√ß√£√£o de checkbox visual n√£o implementada no OCR - sempre usa padr√£o)\n\n` +
                        `? Hor√°rios:\n${horariosStr || 'Nenhum Hor√°rio detectado'}\n\n` +
                        `? Verifique o console (F12) para detalhes completos!`
                    );
                };
                reader.readAsDataURL(file);

            } catch (err) {
                console.error('? Erro no teste:', err);
                alert(`? Erro no teste:\n${err.message}`);
            }

            // Limpar input para permitir retestar o mesmo arquivo
            e.target.value = '';
        });

        // Inicializar
        renderTable();
        
        // Definir datas padr√£o: HOJE em ambos os campos
        (function setDefaultDates() {
            const today = new Date();
            
            // Formatar para YYYY-MM-DD (formato aceito pelo input type="date")
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('dateStart').value = formatDate(today);
            document.getElementById('dateEnd').value = formatDate(today);
            
            console.log(`?? Datas padr√£o configuradas: ${formatDate(today)} (hoje)`);
        })();
    </script>
    
    <!-- Modal de Upload de Anexo -->
    <div id="modalAnexo" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto;">
        <div style="background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 16px; padding: 24px 32px; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.7); position: relative; margin: 20px auto;">
            <button onclick="fecharModalAnexo()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 32px; cursor: pointer; color: #94a3b8; padding: 0; width: 40px; height: 40px; line-height: 1;"></button>
            
            <h2 style="font-size: 24px; font-weight: bold; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 8px 0;">?? Anexar Justificativa</h2>
            <p style="color: #94a3b8; margin: 0 0 24px 0; font-size: 14px;" id="modalAnexoInfo">REG: 000 | Data: 00/00/0000</p>
            
            <div id="dropZone" style="border: 3px dashed #3b82f6; border-radius: 12px; padding: 32px 24px; text-align: center; background: rgba(59, 130, 246, 0.1); cursor: pointer; transition: all 0.3s; margin-bottom: 16px;">
                <div style="font-size: 40px; margin-bottom: 12px;">??</div>
                <h3 style="font-size: 16px; font-weight: 600; color: #e2e8f0; margin: 0 0 6px 0;">Cole o print aqui (Ctrl+V)</h3>
                <p style="color: #94a3b8; margin: 0; font-size: 13px;">Ou clique para selecionar arquivo</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
            
            <div id="previewArea" style="display: none; margin-bottom: 16px;">
                <img id="previewImage" style="max-width: 100%; max-height: 300px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; margin: 0 auto;">
            </div>
            
            <div id="ocrStatus" style="display: none; padding: 16px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 8px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="spinner" style="border: 3px solid rgba(148, 163, 184, 0.2); border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;"></div>
                    <span id="ocrStatusText" style="color: #e2e8f0;">Processando OCR...</span>
                </div>
            </div>
            
            <div id="ocrResult" style="display: none; padding: 16px; background: rgba(16, 185, 129, 0.15); border: 2px solid rgba(16, 185, 129, 0.4); border-radius: 8px; margin-bottom: 16px;">
                <h4 style="margin: 0 0 12px 0; color: #6ee7b7; font-size: 16px; font-weight: 600;">? Dados Detectados:</h4>
                <div id="ocrResultContent" style="color: #a7f3d0; font-size: 14px; line-height: 1.8;"></div>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="fecharModalAnexo()" style="flex: 1; padding: 12px 24px; background: rgba(107, 114, 128, 0.8); color: white; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">Cancelar</button>
                <button id="btnConfirmarAnexo" onclick="confirmarAnexo()" style="flex: 1; padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; display: none;">Confirmar Anexo</button>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #dropZone:hover {
            border-color: #2563eb;
            background: rgba(59, 130, 246, 0.15);
            transform: scale(1.02);
        }
        
        #dropZone.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            transform: scale(1.05);
        }
    </style>
</body>
</html>

< ! - -   C a c h e   B u s t e r :   2 0 2 5 - 1 0 - 3 0   1 4 : 0 6 : 3 8   - - > 
 
 




